<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2024腾讯游戏安全PC初赛 - Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Kvancy"><meta name="msapplication-TileImage" content="/img/Myfavicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Kvancy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="小Q是一个PC客户端安全爱好者。有一天他得到了一个未知工具，含有一个exe、一个sys和一份使用说明。说明写道:ACE的宝库钥匙由两串 token组成．运行这组程序．它们会将两串 token藏于内存中。宝库有两位守护者会制裁使用违禁工具的冒险家，在寻宝时务必谨慎小心。"><meta property="og:type" content="blog"><meta property="og:title" content="Kvancy"><meta property="og:url" content="http://120.46.134.9/2024/09/23/2024%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="小Q是一个PC客户端安全爱好者。有一天他得到了一个未知工具，含有一个exe、一个sys和一份使用说明。说明写道:ACE的宝库钥匙由两串 token组成．运行这组程序．它们会将两串 token藏于内存中。宝库有两位守护者会制裁使用违禁工具的冒险家，在寻宝时务必谨慎小心。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://s2.loli.net/2024/09/28/PxoZ4NGc7LQS1OB.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/1zITWHRrLqisX2C.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/FYlRe6CN8JbAD5X.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/odTGmIHf2JngXks.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/q4HkxMiJRA1rlua.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/cyxCKND7nm63iah.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/wLHNXjtrgEUc7iy.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/p8UM1yT3WJXagjY.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/FotWdRHu7mL3A2X.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/yOzb7VrFe6lBosK.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/utPUyzjqlIkWcCi.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/YchVMS4rPnZGdai.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/iUIm3cTYSkFbf7o.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/CMJuG1ms6yO5Xfv.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/vIAZxulSGOg4Pqo.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/Sn2xPDkH6ZvJoh8.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/PNeHIjpgYOF47KD.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/Dvf2c5RTaLNyHnY.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/ErcPg4bZ8KJ2uIV.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/9EUsBXSvDi1nZa4.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/5lR3vqSQVkiMU6a.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/vJwKBiXGR32na81.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/rBGdkLCpEIY6tnF.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/ucgDYVePtZaO9dH.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/itpCfgunESqZQPw.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/fkDhVr5juzyYTMS.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/yQT7sZ1UnvRAcXk.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/7zjZDi1Y9JPTAvX.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/yEc1leFT3afZI69.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/1KTEVnb9uPWsjpr.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/TOdNVCHav1FIbol.png"><meta property="og:image" content="https://s2.loli.net/2024/09/28/oZUh4qG7FBXanWO.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/suczGZU14mQHv8i.png"><meta property="og:image" content="https://s2.loli.net/2024/10/02/PIej3obTn5NLDyE.png"><meta property="article:published_time" content="2024-09-22T16:00:00.000Z"><meta property="article:modified_time" content="2024-10-02T07:11:01.735Z"><meta property="article:author" content="Kvancy"><meta property="article:tag" content="破解"><meta property="article:tag" content="逆向"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://s2.loli.net/2024/09/28/PxoZ4NGc7LQS1OB.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://120.46.134.9/2024/09/23/2024%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/"},"headline":"2024腾讯游戏安全PC初赛","image":["https://s2.loli.net/2024/09/28/PxoZ4NGc7LQS1OB.png","https://s2.loli.net/2024/09/28/1zITWHRrLqisX2C.png","https://s2.loli.net/2024/09/28/FYlRe6CN8JbAD5X.png","https://s2.loli.net/2024/09/28/odTGmIHf2JngXks.png","https://s2.loli.net/2024/09/28/q4HkxMiJRA1rlua.png","https://s2.loli.net/2024/09/28/cyxCKND7nm63iah.png","https://s2.loli.net/2024/09/28/wLHNXjtrgEUc7iy.png","https://s2.loli.net/2024/09/28/p8UM1yT3WJXagjY.png","https://s2.loli.net/2024/09/28/FotWdRHu7mL3A2X.png","https://s2.loli.net/2024/09/28/yOzb7VrFe6lBosK.png","https://s2.loli.net/2024/09/28/utPUyzjqlIkWcCi.png","https://s2.loli.net/2024/09/28/YchVMS4rPnZGdai.png","https://s2.loli.net/2024/09/28/iUIm3cTYSkFbf7o.png","https://s2.loli.net/2024/09/28/CMJuG1ms6yO5Xfv.png","https://s2.loli.net/2024/09/28/vIAZxulSGOg4Pqo.png","https://s2.loli.net/2024/09/28/Sn2xPDkH6ZvJoh8.png","https://s2.loli.net/2024/09/28/PNeHIjpgYOF47KD.png","https://s2.loli.net/2024/09/28/Dvf2c5RTaLNyHnY.png","https://s2.loli.net/2024/10/02/ErcPg4bZ8KJ2uIV.png","https://s2.loli.net/2024/09/28/9EUsBXSvDi1nZa4.png","https://s2.loli.net/2024/10/02/5lR3vqSQVkiMU6a.png","https://s2.loli.net/2024/09/28/vJwKBiXGR32na81.png","https://s2.loli.net/2024/10/02/rBGdkLCpEIY6tnF.png","https://s2.loli.net/2024/10/02/ucgDYVePtZaO9dH.png","https://s2.loli.net/2024/10/02/itpCfgunESqZQPw.png","https://s2.loli.net/2024/10/02/fkDhVr5juzyYTMS.png","https://s2.loli.net/2024/10/02/yQT7sZ1UnvRAcXk.png","https://s2.loli.net/2024/10/02/7zjZDi1Y9JPTAvX.png","https://s2.loli.net/2024/09/28/yEc1leFT3afZI69.png","https://s2.loli.net/2024/10/02/1KTEVnb9uPWsjpr.png","https://s2.loli.net/2024/10/02/TOdNVCHav1FIbol.png","https://s2.loli.net/2024/09/28/oZUh4qG7FBXanWO.png","https://s2.loli.net/2024/10/02/suczGZU14mQHv8i.png","https://s2.loli.net/2024/10/02/PIej3obTn5NLDyE.png"],"datePublished":"2024-09-22T16:00:00.000Z","dateModified":"2024-10-02T07:11:01.735Z","author":{"@type":"Person","name":"John Doe"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"http://120.46.134.9/img/Kvancy.svg"}},"description":"小Q是一个PC客户端安全爱好者。有一天他得到了一个未知工具，含有一个exe、一个sys和一份使用说明。说明写道:ACE的宝库钥匙由两串 token组成．运行这组程序．它们会将两串 token藏于内存中。宝库有两位守护者会制裁使用违禁工具的冒险家，在寻宝时务必谨慎小心。"}</script><link rel="canonical" href="http://120.46.134.9/2024/09/23/2024%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/"><link rel="icon" href="/img/Myfavicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/Kvancy.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Kvancy"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-09-22T16:00:00.000Z" title="2024/9/23 00:00:00">2024-09-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-02T07:11:01.735Z" title="2024/10/2 15:11:01">2024-10-02</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></span><span class="level-item">an hour read (About 8025 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2024腾讯游戏安全PC初赛</h1><div class="content"><p>小Q是一个PC客户端安全爱好者。有一天他得到了一个未知工具，含有一个exe、一个sys和一份使用说明。说明写道:ACE的宝库钥匙由两串 token组成．运行这组程序．它们会将两串 token藏于内存中。宝库有两位守护者会制裁使用违禁工具的冒险家，在寻宝时务必谨慎小心。<span id="more"></span></p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p><img src="https://s2.loli.net/2024/09/28/PxoZ4NGc7LQS1OB.png" alt="image-20240923132824209"></p>
<h2 id="（一）解题过程"><a href="#（一）解题过程" class="headerlink" title="（一）解题过程"></a>（一）解题过程</h2><p>拿到hack.exe，浅分析一下发现加了VM，并且有检测黑客工具的行为，检测到了之后即使关闭黑客程序也会影响程序正常运行，但是xdbg稍微改一下还是可以动调的，在xdbg里下一些可能的函数断点，我这里在这些地方下了断点</p>
<p><img src="https://s2.loli.net/2024/09/28/1zITWHRrLqisX2C.png" alt="image-20240923131144727"></p>
<p>运行发现程序会多次在<code>WriteProcessMemory</code>下断下，hook一下观察传参</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dllmain.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shellapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBGMGEBOX(fmt, ...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">         <span class="comment">/* 假设最大长度为1024，根据需要调整大小 */</span> \</span></span><br><span class="line"><span class="meta">        wsprintfA(out, fmt, __VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        MessageBoxA(NULL, out, <span class="string">&quot;提示&quot;</span>, MB_OK); \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"><span class="type">char</span> out[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">BOOL</span><span class="params">(WINAPI* WriteProcessMemory_t)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE hProcess,</span></span><br><span class="line"><span class="params">    _In_ LPVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T nSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ SIZE_T* lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">WriteProcessMemory_t TrueWriteProcessMemory = <span class="literal">NULL</span>;</span><br><span class="line">BOOL</span><br><span class="line">WINAPI</span><br><span class="line"><span class="title function_">HookWriteProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE hProcess,</span></span><br><span class="line"><span class="params">    _In_ LPVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T nSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ SIZE_T * lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> fileName[<span class="number">12</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(fileName, <span class="string">&quot;out%d.txt&quot;</span>, (<span class="type">int</span>)hProcess % <span class="number">1000</span>);</span><br><span class="line">    HANDLE hFile = CreateFile(fileName, FILE_APPEND_DATA, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        DBGMGEBOX(<span class="string">&quot;CreateFile Fail&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> TrueWriteProcessMemory(hProcess, lpBaseAddress, lpBuffer, nSize, lpNumberOfBytesWritten);</span><br><span class="line">    &#125;</span><br><span class="line">    SetFilePointer(hFile, <span class="number">0</span>, <span class="literal">NULL</span>, FILE_END);</span><br><span class="line">    DWORD bytesWritten;</span><br><span class="line">    BOOL result = WriteFile(hFile, lpBuffer, nSize, &amp;bytesWritten, <span class="literal">NULL</span>);</span><br><span class="line">    CloseHandle(hFile);</span><br><span class="line">    DBGMGEBOX(<span class="string">&quot;findProcess WriteProcessMemory:%p,size:%d\n&quot;</span>, hProcess,nSize);</span><br><span class="line">    <span class="keyword">return</span> TrueWriteProcessMemory(hProcess, lpBaseAddress, lpBuffer, nSize, lpNumberOfBytesWritten);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line"></span><br><span class="line">        DetourTransactionBegin();</span><br><span class="line">        DetourUpdateThread(GetCurrentThread());</span><br><span class="line"></span><br><span class="line">        TrueWriteProcessMemory = (WriteProcessMemory_t)DetourFindFunction(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;WriteProcessMemory&quot;</span>);</span><br><span class="line">        DetourAttach(&amp;(PVOID&amp;)TrueWriteProcessMemory, HookWriteProcessMemory);</span><br><span class="line"></span><br><span class="line">        DetourTransactionCommit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        DetourTransactionBegin();</span><br><span class="line">        DetourUpdateThread(GetCurrentThread());</span><br><span class="line">        DetourDetach(&amp;(PVOID&amp;)TrueWriteProcessMemory, HookWriteProcessMemory);</span><br><span class="line"></span><br><span class="line">        DetourTransactionCommit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里输出了三个txt文件</p>
<p><img src="https://s2.loli.net/2024/09/28/FYlRe6CN8JbAD5X.png" alt="image-20240923131546102"></p>
<p>其中out200.txt文件有明显的PE头</p>
<p><img src="https://s2.loli.net/2024/09/28/odTGmIHf2JngXks.png" alt="image-20240923131748329"></p>
<p>去除前面的字节，把文件丢到DIE里分析一下发现是dll64文件并且貌似没加壳，所以hack.exe通过<code>WriteProcessMemory</code>往某个进程写入了一个dll?怀疑是远程注入，至于做了什么，有可能跟token有关，继续分析。</p>
<p>ida64打开发现程序的dllMain入口还是被加密了</p>
<p><img src="https://s2.loli.net/2024/09/28/q4HkxMiJRA1rlua.png" alt="image-20240923132428865"></p>
<p>还是继续动调，随便找了个64位的可执行文件，拖到X64dbg里运行，直接用xdbg的注入方式将out200.dll注入进程，在</p>
<p>入口点下断点，并且对一些可疑的WINDOWS API下断观察进程行为</p>
<p><img src="https://s2.loli.net/2024/09/28/cyxCKND7nm63iah.png" alt="image-20240913213116556"></p>
<p>这里我对下面这几个API下了断点</p>
<p><img src="https://s2.loli.net/2024/09/28/wLHNXjtrgEUc7iy.png" alt="image-20240913213203300"></p>
<p>运行，第一次成功在openProcess函数断下</p>
<p><img src="https://s2.loli.net/2024/09/28/p8UM1yT3WJXagjY.png" alt="image-20240913213252406"></p>
<p>观察传参窗口，找到了一个系统进程名称字符串<code>winlogon.exe</code>，而这里调用的是openProcess，疑似是对系统进程winlogon.exe做了一些操作。继续分析，运行到返回，回溯一层函数，找到一段没有被加密的代码</p>
<p><img src="https://s2.loli.net/2024/09/28/FotWdRHu7mL3A2X.png" alt="image-20240913213951735"></p>
<p>汇编代码不是很好看，根据偏移在IDA里反汇编看看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1800063D0</span><span class="params">(_DWORD *Dst, DWORD dwProcessId)</span></span><br><span class="line">&#123;</span><br><span class="line">  __m128i si128; <span class="comment">// xmm0</span></span><br><span class="line">  __m128i v6; <span class="comment">// xmm0</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __m128i v10; <span class="comment">// xmm2</span></span><br><span class="line">  <span class="type">size_t</span> v14; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// r14d</span></span><br><span class="line">  HANDLE Toolhelp32Snapshot; <span class="comment">// rsi</span></span><br><span class="line">  HANDLE v18; <span class="comment">// rax</span></span><br><span class="line">  __int64 v21; <span class="comment">// rbx</span></span><br><span class="line">  CHAR Caption[<span class="number">16</span>]; <span class="comment">// [rsp+40h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _RBP = (<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64;</span><br><span class="line">  <span class="keyword">if</span> ( !dwProcessId )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x28</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">8</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">    *(_QWORD *)_RBP = <span class="number">0xE795A71250E2465A</span>ui64;</span><br><span class="line">    si128 = _mm_load_si128((<span class="type">const</span> __m128i *)_RBP);</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>) = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">    v6 = _mm_xor_si128(si128, *(__m128i *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>));</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>) = <span class="number">0x84FAD5301FE45158</span>ui64;</span><br><span class="line">    *(__m128i *)_RBP = v6;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x28</span>) = <span class="number">0xBF19D3ADD5D97A59</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1A0</span>) = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x30</span>) = <span class="number">0xBD1C9CA3F4C12EC9</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x38</span>) = <span class="number">0xA727C05763438E84</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1A8</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1B0</span>) = <span class="number">0xCF59BCC699A060E9</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1B8</span>) = <span class="number">0xA727C0574231E1F6</span>ui64;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">      vmovdqu ymm0, [rbp+<span class="number">210</span>h+var_70]</span><br><span class="line">      vpxor   ymm1, ymm0, ymmword ptr [rbp+<span class="number">210</span>h+Text]</span><br><span class="line">      vmovdqa ymmword ptr [rbp+<span class="number">210</span>h+Text], ymm1</span><br><span class="line">      vzeroupper</span><br><span class="line">    &#125;</span><br><span class="line">    MessageBoxA(<span class="number">0</span>i64, (LPCSTR)(_RBP + <span class="number">32</span>), (LPCSTR)((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64), <span class="number">0</span>);</span><br><span class="line">LABEL_3:</span><br><span class="line">    GetLastError();</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>) = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">    *(_QWORD *)_RBP = <span class="number">0x88D6871250E2465A</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x28</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">8</span>) = <span class="number">0xC65BF98DB9906C58</span>ui64;</span><br><span class="line">    *(__m128i *)_RBP = _mm_xor_si128(</span><br><span class="line">                         _mm_load_si128((<span class="type">const</span> __m128i *)_RBP),</span><br><span class="line">                         *(__m128i *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>));</span><br><span class="line">    <span class="keyword">return</span> sub_180006A00((<span class="type">void</span> *)((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)sub_180006FC0() )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1A0</span>) = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x48</span>) = <span class="number">0x44F651D568826090</span>i64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1C0</span>) = <span class="number">0x52C9FCDC77FF5FC3</span>i64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>) = <span class="number">0xDDD2E92971C27548</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x28</span>) = <span class="number">0xA43EB7C9E8CF4E1C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x30</span>) = <span class="number">0xA62FD5B4C980079C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x38</span>) = <span class="number">0xD55585772756849A</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x40</span>) = <span class="number">0x52C9FCDC7DDE2DAC</span>i64;</span><br><span class="line">    v10 = _mm_load_si128((<span class="type">const</span> __m128i *)(_RBP + <span class="number">64</span>));</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1C8</span>) = <span class="number">0x44F651D568826090</span>i64;</span><br><span class="line">    _XMM2 = _mm_xor_si128(v10, *(__m128i *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1C0</span>));</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1A8</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1B0</span>) = <span class="number">0xCF59BCC699A060E9</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1B8</span>) = <span class="number">0xA727C0574231E1F6</span>ui64;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">      vmovdqu ymm0, [rbp+<span class="number">210</span>h+var_70]</span><br><span class="line">      vpxor   ymm1, ymm0, ymmword ptr [rbp+<span class="number">210</span>h+Text]</span><br><span class="line">      vmovdqa [rbp+<span class="number">210</span>h+var_1D0], xmm2</span><br><span class="line">      vmovdqa ymmword ptr [rbp+<span class="number">210</span>h+Text], ymm1</span><br><span class="line">      vzeroupper</span><br><span class="line">    &#125;</span><br><span class="line">    sub_180006A00((<span class="type">void</span> *)(_RBP + <span class="number">32</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  v14 = <span class="number">-1</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( dwProcessId == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    Dst[<span class="number">34</span>] = GetCurrentProcessId();</span><br><span class="line">    *((_QWORD *)Dst + <span class="number">13</span>) = <span class="number">-1</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Dst[<span class="number">34</span>] = dwProcessId;</span><br><span class="line">    v18 = OpenProcess(<span class="number">0x1FFFFF</span>u, <span class="number">0</span>, dwProcessId);</span><br><span class="line">    *((_QWORD *)Dst + <span class="number">13</span>) = v18;</span><br><span class="line">    <span class="keyword">if</span> ( !v18 )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x38</span>) = <span class="number">0xA727C0574231E1F6</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>) = <span class="number">0x84FAD53051F54450</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1A0</span>) = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x28</span>) = <span class="number">0xA92981ACBCD97A59</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x30</span>) = <span class="number">0xCF59BCC699AA419B</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1A8</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1B0</span>) = <span class="number">0xCF59BCC699A060E9</span>ui64;</span><br><span class="line">      *(_QWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x1B8</span>) = <span class="number">0xA727C0574231E1F6</span>ui64;</span><br><span class="line">      __asm</span><br><span class="line">      &#123;</span><br><span class="line">        vmovdqu ymm0, [rbp+<span class="number">210</span>h+var_70]</span><br><span class="line">        vpxor   ymm1, ymm0, ymmword ptr [rbp+<span class="number">210</span>h+Text]</span><br><span class="line">        vmovdqa ymmword ptr [rbp+<span class="number">210</span>h+Text], ymm1</span><br><span class="line">        vzeroupper</span><br><span class="line">      &#125;</span><br><span class="line">      sub_180006A00((<span class="type">void</span> *)(_RBP + <span class="number">32</span>));<span class="comment">//打印报错信息</span></span><br><span class="line">      <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Dst[<span class="number">30</span>] = <span class="number">0x1FFFFF</span>;</span><br><span class="line">  v15 = <span class="number">-1</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v15;</span><br><span class="line">  <span class="keyword">while</span> ( *((_BYTE *)Dst + v15) );</span><br><span class="line">  <span class="keyword">if</span> ( !v15 )</span><br><span class="line">  &#123;</span><br><span class="line">    v16 = Dst[<span class="number">34</span>];</span><br><span class="line">    Toolhelp32Snapshot = CreateToolhelp32Snapshot(<span class="number">2u</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( Toolhelp32Snapshot != (HANDLE)<span class="number">-1</span>i64 )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x60</span>) = <span class="number">304</span>;</span><br><span class="line">      <span class="built_in">memset</span>((<span class="type">void</span> *)(_RBP + <span class="number">100</span>), <span class="number">0</span>, <span class="number">0x12C</span>ui64);</span><br><span class="line">      <span class="keyword">if</span> ( Process32First(Toolhelp32Snapshot, (LPPROCESSENTRY32)(_RBP + <span class="number">96</span>)) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( *(_DWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x68</span>) != v16 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !Process32Next(Toolhelp32Snapshot, (LPPROCESSENTRY32)(_RBP + <span class="number">96</span>)) )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">          ++v14;</span><br><span class="line">        <span class="keyword">while</span> ( *(_BYTE *)(_RBP + <span class="number">140</span> + v14) );</span><br><span class="line">        memmove(Dst, (<span class="type">const</span> <span class="type">void</span> *)(_RBP + <span class="number">140</span>), v14);</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_20:</span><br><span class="line">      CloseHandle(Toolhelp32Snapshot);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_QWORD *)Dst + <span class="number">18</span>) = sub_1800068D0(Dst, Dst);</span><br><span class="line">  v21 = <span class="number">0</span>i64;</span><br><span class="line">  *(_DWORD *)(((<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">8</span>) = Dst[<span class="number">34</span>];</span><br><span class="line">  *(_QWORD *)_RBP = <span class="number">0</span>i64;</span><br><span class="line">  EnumWindows(EnumFunc, (<span class="type">unsigned</span> __int64)Caption &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64);</span><br><span class="line">  result = *(_QWORD *)_RBP;</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)_RBP )</span><br><span class="line">    v21 = *(_QWORD *)_RBP;</span><br><span class="line">  *((_QWORD *)Dst + <span class="number">16</span>) = v21;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码一次进行了获取进程pid，打开进程，遍历模块等操作，并且在函数失败后做了一些奇奇怪怪的东西，对一些地址赋上了一些64位的值，猜测是隐藏字符串来打印调试信息用的，再通过messagebox和outputDebugString给出调试信息，显示打开进程失败，猜测是因为hack.exe启动是管理员启动，这里失去了管理员权限。</p>
<p><img src="https://s2.loli.net/2024/09/28/yOzb7VrFe6lBosK.png" alt="image-20240913221222730"></p>
<p>分析完这个函数，继续回溯一层，运行到返回，定位到这个地方</p>
<p><img src="https://s2.loli.net/2024/09/28/utPUyzjqlIkWcCi.png" alt="image-20240913221520425"></p>
<p>继续根据偏移转到IDA里看反汇编</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_180001990</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v0; <span class="comment">// rbx</span></span><br><span class="line">  DWORD v1; <span class="comment">// eax</span></span><br><span class="line">  __m128i Dst; <span class="comment">// [rsp+20h] [rbp-48h] BYREF</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+30h] [rbp-38h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+38h] [rbp-30h]</span></span><br><span class="line">  __m128i Src; <span class="comment">// [rsp+40h] [rbp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Dst.m128i_i64[<span class="number">0</span>] = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">  Dst.m128i_i64[<span class="number">1</span>] = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">  Src.m128i_i64[<span class="number">0</span>] = <span class="number">0x89FAC00F53FE5D68</span>ui64;</span><br><span class="line">  Src.m128i_i64[<span class="number">1</span>] = <span class="number">0xC65BF3E9F9D26C12</span>ui64;</span><br><span class="line">  Src = _mm_xor_si128(_mm_load_si128(&amp;Src), Dst);</span><br><span class="line">  v0 = <span class="number">-1</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v0;</span><br><span class="line">  <span class="keyword">while</span> ( Src.m128i_i8[v0] );</span><br><span class="line">  memmove(dword_1800349A0, &amp;Src, v0);</span><br><span class="line">  Dst.m128i_i64[<span class="number">0</span>] = <span class="number">0</span>i64;</span><br><span class="line">  v4 = <span class="number">0</span>i64;</span><br><span class="line">  v5 = <span class="number">15</span>i64;</span><br><span class="line">  sub_180004770(&amp;Dst, &amp;Src, v0);</span><br><span class="line">  v1 = sub_1800070A0(&amp;Dst);</span><br><span class="line">  sub_1800063D0(dword_1800349A0, v1);</span><br><span class="line">  <span class="keyword">return</span> atexit(sub_180020C90);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面应该是一个加密的字符串操作，用python打印出字符串</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hex_xor_to_string</span>(<span class="params">a, b</span>):</span><br><span class="line">    result = a ^ b</span><br><span class="line">    hex_str = <span class="built_in">hex</span>(result)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hex_str) % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">        hex_str = <span class="string">&#x27;0&#x27;</span> + hex_str</span><br><span class="line"></span><br><span class="line">    result_str = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(hex_str[i:i+<span class="number">2</span>], <span class="number">16</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(hex_str), <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> result_str</span><br><span class="line"></span><br><span class="line">x1 = <span class="number">0xE795A7603F90341F</span></span><br><span class="line">x2 = <span class="number">0xC65BF3E99CAA093C</span></span><br><span class="line">y1 = <span class="number">0x89FAC00F53FE5D68</span></span><br><span class="line">y2 = <span class="number">0xC65BF3E9F9D26C12</span></span><br><span class="line"></span><br><span class="line">result1 = hex_xor_to_string(x1, y1)</span><br><span class="line">result2 = hex_xor_to_string(x2, y2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 1:&quot;</span>, result1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 2:&quot;</span>, result2)</span><br><span class="line"><span class="comment">#Result 1: nogolniw</span></span><br><span class="line"><span class="comment">#Result 2: exe.</span></span><br></pre></td></tr></table></figure>

<p>得到的刚好是winlogon.exe字符串，然后程序将这个字符串转移到了dword_1800349A0全局变量中，目的应该是隐藏字符串，接着sub_180004770函数也是一个类似memmove操作，把这个字符串传到了Dst局部变量中，接着在sub_1800070A0中传入这个字符串，貌似是在根据字符串获取进程PID，接着调用sub_1800063D0函数根据pid打开进程，并将进程句柄存储到了某个地方</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v18 = OpenProcess(<span class="number">0x1FFFFF</span>u, <span class="number">0</span>, dwProcessId);</span><br><span class="line">*((_QWORD *)Dst + <span class="number">13</span>) = v18;</span><br></pre></td></tr></table></figure>

<p>随后return exit退出。</p>
<p>随后我在退出函数传参的时候看到了一个hProcess</p>
<p><img src="https://s2.loli.net/2024/09/28/YchVMS4rPnZGdai.png" alt="image-20240914102337797"></p>
<p>一个全局变量，很有可能在其他地方对句柄进行了读取，交叉引用一下定位到如下函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">sub_180007C10</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE v1; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// rdx</span></span><br><span class="line">  __int128 v3; <span class="comment">// xmm0</span></span><br><span class="line">  __int128 v4; <span class="comment">// xmm1</span></span><br><span class="line">  HANDLE FileA; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rcx</span></span><br><span class="line">  _BYTE *v9; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v11; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> Buffer; <span class="comment">// [rsp+60h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _RBP = (<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64;</span><br><span class="line">  <span class="keyword">while</span> ( byte_180032C00 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !byte_180034961 &amp;&amp; !byte_180034960 )</span><br><span class="line">      sub_1800041D0();</span><br><span class="line">    v1 = hProcess;</span><br><span class="line">    v2 = (<span class="type">void</span> *)(qword_180034968 + <span class="number">2766</span>);</span><br><span class="line">    *(_BYTE *)_RBP = <span class="number">15</span>;</span><br><span class="line">    WriteProcessMemory(v1, v2, (LPCVOID)((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64), <span class="number">1u</span>i64, <span class="number">0</span>i64);</span><br><span class="line">    byte_180032C00 = <span class="number">0</span>;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>) = <span class="number">0xAA32D3B2B7C50388</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x10</span>) = <span class="number">0xA0A195500DCC0E5C</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x18</span>) = <span class="number">0x943E9588CFCF645D</span>ui64;</span><br><span class="line">    v3 = *(_OWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x10</span>);</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x28</span>) = <span class="number">0xA727C0574231D098</span>ui64;</span><br><span class="line">    v4 = *(_OWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x20</span>);</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x80</span>) = <span class="number">0xE795A7603F90341F</span>ui64;</span><br><span class="line">    *(_OWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x60</span>) = v3;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x88</span>) = <span class="number">0xC65BF3E99CAA093C</span>ui64;</span><br><span class="line">    *(_OWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x70</span>) = v4;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x90</span>) = <span class="number">0xCF59BCC699A060E9</span>ui64;</span><br><span class="line">    *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x98</span>) = <span class="number">0xA727C0574231E1F6</span>ui64;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">      vmovdqu ymm0, [rbp+<span class="number">0</span>D0h+var_50]</span><br><span class="line">      vpxor   ymm1, ymm0, ymmword ptr [rbp+<span class="number">0</span>D0h+FileName]</span><br><span class="line">      vmovdqa ymmword ptr [rbp+<span class="number">0</span>D0h+FileName], ymm1</span><br><span class="line">      vzeroupper</span><br><span class="line">    &#125;</span><br><span class="line">    FileA = CreateFileA((LPCSTR)(_RBP + <span class="number">96</span>), <span class="number">0x40000000</span>u, <span class="number">0</span>, <span class="number">0</span>i64, <span class="number">3u</span>, <span class="number">0x80</span>u, <span class="number">0</span>i64);</span><br><span class="line">    <span class="keyword">if</span> ( FileA != (HANDLE)<span class="number">-1</span>i64 )</span><br><span class="line">    &#123;</span><br><span class="line">      ((<span class="type">void</span> (__fastcall *)(<span class="type">unsigned</span> __int64))loc_180007A20)(_RBP + <span class="number">48</span>);</span><br><span class="line">      v8 = <span class="number">-1</span>i64;</span><br><span class="line">      <span class="keyword">if</span> ( *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x48</span>) &lt; <span class="number">0x10</span>ui64 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">          ++v8;</span><br><span class="line">        <span class="keyword">while</span> ( *(_BYTE *)(_RBP + <span class="number">48</span> + v8) );</span><br><span class="line">        v9 = (_BYTE *)(_RBP + <span class="number">48</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v9 = *(_BYTE **)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">          ++v8;</span><br><span class="line">        <span class="keyword">while</span> ( v9[v8] );</span><br><span class="line">      &#125;</span><br><span class="line">      WriteFile(FileA, v9, v8, (LPDWORD)(_RBP + <span class="number">8</span>), <span class="number">0</span>i64);</span><br><span class="line">      CloseHandle(FileA);</span><br><span class="line">      v10 = *(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x48</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v10 &gt;= <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = *(_QWORD **)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v10 + <span class="number">1</span> &gt;= <span class="number">0x1000</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 = (_QWORD *)*(v11 - <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)(*(_QWORD *)(((<span class="type">unsigned</span> __int64)&amp;Buffer &amp; <span class="number">0xFFFFFFFFFFFFFFE0</span>ui64) + <span class="number">0x30</span>)</span><br><span class="line">                                - (_QWORD)v11</span><br><span class="line">                                - <span class="number">8</span>i64) &gt; <span class="number">0x1F</span> )</span><br><span class="line">            invalid_parameter_noinfo_noreturn();</span><br><span class="line">        &#125;</span><br><span class="line">        j_j_free(v11);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到了有WriteProcessMemory写入hProcess内存操作，CreateFileA，WriteFile，打开和写入文件操作，但是并没有找到hProcess的赋值语句，也就是说这个进程句柄还不知道是谁的，猜测赋值被隐藏了，但是可以猜测可能是winlogon.exe进程句柄。byte_180032C00是一个全局的标志变量，强制函数只能执行一次，对应的是运行程序时仅一次的初始化操作。接着看一下CreateFileA函数，同样的文件名被隐藏了，python解析一下</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hex_xor_to_string</span>(<span class="params">a, b</span>):</span><br><span class="line">    result = a ^ b</span><br><span class="line">    hex_str = <span class="built_in">hex</span>(result)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hex_str) % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">        hex_str = <span class="string">&#x27;0&#x27;</span> + hex_str</span><br><span class="line"></span><br><span class="line">    result_str = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(hex_str[i:i+<span class="number">2</span>], <span class="number">16</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(hex_str), <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> result_str</span><br><span class="line"></span><br><span class="line">x1 = <span class="number">0xA0A195500DCC0E5C</span></span><br><span class="line">x2 = <span class="number">0x943E9588CFCF645D</span></span><br><span class="line">x3 = <span class="number">0xAA32D3B2B7C50388</span></span><br><span class="line">x4 = <span class="number">0xA727C0574231D098</span></span><br><span class="line">y1 = <span class="number">0xE795A7603F90341F</span></span><br><span class="line">y2 = <span class="number">0xC65BF3E99CAA093C</span></span><br><span class="line">y3 = <span class="number">0xCF59BCC699A060E9</span></span><br><span class="line">y4 = <span class="number">0xA727C0574231E1F6</span></span><br><span class="line"></span><br><span class="line">result1 = hex_xor_to_string(x1, y1)</span><br><span class="line">result2 = hex_xor_to_string(x2, y2)</span><br><span class="line">result3 = hex_xor_to_string(x3, y3)</span><br><span class="line">result4 = hex_xor_to_string(x4, y4)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 1:&quot;</span>, result1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 2:&quot;</span>, result2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 3:&quot;</span>, result3)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 4:&quot;</span>, result4)</span><br><span class="line"></span><br><span class="line">res = result1[::-<span class="number">1</span>] + result2[::-<span class="number">1</span>] + result3[::-<span class="number">1</span>] + result4[::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/09/28/iUIm3cTYSkFbf7o.png" alt="image-20240914110434860"></p>
<p>整个拼起来是字符串<code>C:\2024GameSafeRace.token1</code>，应该是创建了一个文件，然后向这个文件写入了token1了，接着往下</p>
<p><img src="https://s2.loli.net/2024/09/28/CMJuG1ms6yO5Xfv.png" alt="image-20240914110826942"></p>
<p>loc_180007A20这个函数内部被加密了，猜测是对token1的解密过程，然后通过WriteFile写入<code>C:\2024GameSafeRace.token1</code>中，并不是很像去分析这个函数，直接加载驱动看看能不能直接运行得到2024GameSafeRace.token1文件。</p>
<p><img src="https://s2.loli.net/2024/09/28/vIAZxulSGOg4Pqo.png" alt="image-20240914111407201"></p>
<p>找到下没找到，回头看看CreateFileA函数，核查一下后面几个参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileA = CreateFileA((LPCSTR)(_RBP + <span class="number">96</span>), <span class="number">0x40000000</span>u, <span class="number">0</span>, <span class="number">0</span>i64, <span class="number">3u</span>, <span class="number">0x80</span>u, <span class="number">0</span>i64);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/09/28/Sn2xPDkH6ZvJoh8.png" alt="image-20240914111653640"></p>
<p>看来是参数在作怪，CreateFileA函数传入<strong>OPEN_EXISTING</strong>参数，如果没有指定文件，则函数会返回失败，那也好办，自己创建一个就好了。</p>
<p><img src="https://s2.loli.net/2024/09/28/PNeHIjpgYOF47KD.png" alt="image-20240914112419617"></p>
<p>C:\2024GameSafeRace.token1成功被写入</p>
<p><img src="https://s2.loli.net/2024/09/28/Dvf2c5RTaLNyHnY.png" alt="image-20240914112536772"></p>
<p>010打开找到token1:<code>757F4749AEBB1891EF5AC2A9B5439CEA</code></p>
<p>token2的寻找就偏简单了，加载驱动后留意一下dbgView的打印信息就可以获取</p>
<p><img src="https://s2.loli.net/2024/10/02/ErcPg4bZ8KJ2uIV.png" alt="image-20240914113718466"></p>
<p>组合一下就是token2：<code>803f14a24d64f3e697957c252e3a5686</code></p>
<h2 id="（二）解题过程"><a href="#（二）解题过程" class="headerlink" title="（二）解题过程"></a>（二）解题过程</h2><p>题目要求：</p>
<p>编写程序，运行时修改尽量少的内存，让两段token输出成功。（满分2分）</p>
<p>根据之前分析的token1，我们可以知道程序会在CreateFileA后解密token1然后写入到<code>C:\2024GameSafeRace.token1</code>中，但是会因为CreateFileA参数<code>OPEN_EXISTING</code>条件不满足而失败，所以我们只需要修改这个传参，改成<code>OPEN_ALWAYS</code>，即可实现输出token1，那我们只需要hook <code>CreateFileA</code>函数修改传参即可，但是有个问题，因为不是hack.exe本身调用<code>CreateFileA</code>函数，而是hack.exe注入了一个dll到winlogon.exe，然后再winlogon.exe里调用<code>CreateFileA</code>函数，所以我们可以考虑在注入前修改<code>WriteProcessMemory</code>函数参数buffer，从而在注入前patch dll，或者编写代码直接注入winlogon.exe，hook CreateFileA函数修改传参，但是考虑到第二种方式可能不被允许，winlogon.exe毕竟是系统进程，题目应该是要我们通过patch dll的方式解题。</p>
<p>这里我们要patch 传参，通过ida找到传参的汇编代码</p>
<p><img src="https://s2.loli.net/2024/09/28/9EUsBXSvDi1nZa4.png" alt="image-20240920142928600"></p>
<p>在winhex里找到对应所在文件偏移<br><img src="https://s2.loli.net/2024/10/02/5lR3vqSQVkiMU6a.png" alt="image-20240920143006628"></p>
<p>也就是在0x7171处OPEN_EXISTING:0x3是要patch的地方，把这个参数修改成OPEN_ALWAYS:0x4即可。下面编写代码实现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dllmain.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shellapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBGMGEBOX(fmt, ...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">         <span class="comment">/* 假设最大长度为1024，根据需要调整大小 */</span> \</span></span><br><span class="line"><span class="meta">        wsprintfA(out, fmt, __VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        MessageBoxA(NULL, out, <span class="string">&quot;提示&quot;</span>, MB_OK); \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"><span class="type">char</span> out[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">BOOL</span><span class="params">(WINAPI* WriteProcessMemory_t)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE hProcess,</span></span><br><span class="line"><span class="params">    _In_ LPVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T nSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ SIZE_T* lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">WriteProcessMemory_t TrueWriteProcessMemory = <span class="literal">NULL</span>;</span><br><span class="line">BOOL</span><br><span class="line">WINAPI</span><br><span class="line"><span class="title function_">HookWriteProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE hProcess,</span></span><br><span class="line"><span class="params">    _In_ LPVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T nSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ SIZE_T* lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (nSize == <span class="number">4506624</span> &amp;&amp; *((PUCHAR)lpBuffer + <span class="number">0x7171</span>) == <span class="number">0x3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *((PUCHAR)lpBuffer + <span class="number">0x7171</span>) = <span class="number">0x4</span>;</span><br><span class="line">        DBGMGEBOX(<span class="string">&quot;Hook Success!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TrueWriteProcessMemory(hProcess, lpBaseAddress, lpBuffer, nSize, lpNumberOfBytesWritten);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line"></span><br><span class="line">        DetourTransactionBegin();</span><br><span class="line">        DetourUpdateThread(GetCurrentThread());</span><br><span class="line"></span><br><span class="line">        TrueWriteProcessMemory = (WriteProcessMemory_t)DetourFindFunction(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;WriteProcessMemory&quot;</span>);</span><br><span class="line">        DetourAttach(&amp;(PVOID&amp;)TrueWriteProcessMemory, HookWriteProcessMemory);</span><br><span class="line"></span><br><span class="line">        DetourTransactionCommit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        DetourTransactionBegin();</span><br><span class="line">        DetourUpdateThread(GetCurrentThread());</span><br><span class="line">        DetourDetach(&amp;(PVOID&amp;)TrueWriteProcessMemory, HookWriteProcessMemory);</span><br><span class="line"></span><br><span class="line">        DetourTransactionCommit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功输出token1文件：</p>
<p><img src="https://s2.loli.net/2024/09/28/vJwKBiXGR32na81.png" alt="image-20240914120306770"></p>
<p>然后是token2，既然是内核输出，那只能是在ace.sys里做点手脚，DIE查壳发现ace.sys的大部分代码都被加壳过了，静态代码不好看，只能先猜测token2的输出调用了DbgPrint或者DbgPrintEx，因为之前输出token2的时候开启了Verbose Kernel outPut，猜测之所以正常输出失败是因为DbgPrintEx的level值太低，仅将字符串传递给内核调试器，不执行输出操作。</p>
<p>hook DbgPrintEx函数看一眼传参。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;R0Hook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dbgFilter <span class="string">&quot;Kvancy:&quot;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">ULONG</span><span class="params">(*FuncPtr)</span> <span class="params">(ULONG ComponentId, ULONG Level, PCSTR Format, ...)</span>;</span><br><span class="line">HOOK_MANAGER hookManager;</span><br><span class="line">ULONG <span class="title function_">myDbgPrintEx</span><span class="params">(ULONG ComponentId, ULONG Level, PCSTR Format, ...)</span> &#123;</span><br><span class="line">    Unhook(&amp;hookManager);</span><br><span class="line">    FuncPtr func = (FuncPtr)hookManager.target;</span><br><span class="line">    kPrint(<span class="string">&quot;%s DbgPrintEx ComponentId:%lu,Level:%lu\n&quot;</span>,dbgFilter, ComponentId, Level);</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, Format);</span><br><span class="line">    NTSTATUS s = func(ComponentId, Level, Format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    ApplyHook(&amp;hookManager);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kPrint(<span class="string">&quot;%s DriverUnload\n&quot;</span>, dbgFilter);</span><br><span class="line">    Unhook(&amp;hookManager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    PVOID dbgPrintEx = DbgPrintEx;</span><br><span class="line">    InitializeHookManager(&amp;hookManager, dbgPrintEx, myDbgPrintEx);</span><br><span class="line">    ApplyHook(&amp;hookManager);</span><br><span class="line">    DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;%s DriverEntry\n&quot;</span>,dbgFilter);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现加载ace驱动后，有大量的level:5的调试信息输出</p>
<p><img src="https://s2.loli.net/2024/10/02/rBGdkLCpEIY6tnF.png" alt="image-20240918212128643"></p>
<p>也就是说，程序通过设置调试信息的重要级别来控制调试信息是否正常输出，于是可以提高level级别来输出token2，那么最简单的方式就是hook之后修改level后传回去，编写代码hook测试下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;R0Hook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dbgFilter <span class="string">&quot;Kvancy:&quot;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">ULONG</span><span class="params">(*FuncPtr)</span> <span class="params">(ULONG ComponentId, ULONG Level, PCSTR Format, ...)</span>;</span><br><span class="line">HOOK_MANAGER hookManager;</span><br><span class="line"><span class="type">char</span> buffer[<span class="number">1024</span>]; </span><br><span class="line">ULONG <span class="title function_">myDbgPrintEx</span><span class="params">(ULONG ComponentId, ULONG Level, PCSTR Format, ...)</span> &#123;</span><br><span class="line">    Unhook(&amp;hookManager);</span><br><span class="line">    FuncPtr func = (FuncPtr)hookManager.target;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, Format);</span><br><span class="line">    <span class="built_in">vsprintf</span>(buffer, Format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    NTSTATUS s = func(ComponentId, <span class="number">0</span>, <span class="string">&quot;%s&quot;</span>, buffer);<span class="comment">//修改level为0</span></span><br><span class="line">    ApplyHook(&amp;hookManager);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kPrint(<span class="string">&quot;Kvancy: DriverUnload\n&quot;</span>);</span><br><span class="line">    Unhook(&amp;hookManager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    PVOID dbgPrintEx = DbgPrintEx;</span><br><span class="line">    InitializeHookManager(&amp;hookManager, dbgPrintEx, myDbgPrintEx);</span><br><span class="line">    ApplyHook(&amp;hookManager);</span><br><span class="line">    DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;Kvancy: DriverEntry\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/10/02/ucgDYVePtZaO9dH.png" alt="{4981D7A9-1EAA-4A38-9280-429D63ECABF9}"></p>
<p>成功输出token2，但是根据题目要求是不能修改系统模块代码的，也就是说hook内核函数的方法不能过这道题，还是得想想别的方法。现在已知的ace.sys的行为就是驱动会在被加载之后做了某些操作会使得系统持续调用DbgPrintEx来输出token2，但是ace.sys其实做了某种操作后就被卸载掉了，如下图所示。</p>
<p><img src="https://s2.loli.net/2024/10/02/itpCfgunESqZQPw.png" alt="{170126A6-1C28-4BF3-AB47-AB2397C76595}"></p>
<p>可以想到就是说驱动启动了一个线程或者进程，让该任务持续输出token2，创建完随后再卸载自己并且不停止这个线程或者进程。先枚举进程看看有没有奇怪的进程出现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">WriteToFile</span><span class="params">(PUNICODE_STRING FilePath, PCHAR Data)</span></span><br><span class="line">&#123;</span><br><span class="line">    OBJECT_ATTRIBUTES objAttr;</span><br><span class="line">    IO_STATUS_BLOCK ioStatusBlock;</span><br><span class="line">    HANDLE fileHandle;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    UNICODE_STRING unicodeFilePath;</span><br><span class="line"></span><br><span class="line">    RtlInitUnicodeString(&amp;unicodeFilePath, FilePath-&gt;Buffer);</span><br><span class="line"></span><br><span class="line">    InitializeObjectAttributes(&amp;objAttr, &amp;unicodeFilePath, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    status = ZwCreateFile(</span><br><span class="line">        &amp;fileHandle,</span><br><span class="line">        FILE_APPEND_DATA | SYNCHRONIZE,</span><br><span class="line">        &amp;objAttr,</span><br><span class="line">        &amp;ioStatusBlock,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        FILE_OPEN_IF,</span><br><span class="line">        FILE_SYNCHRONOUS_IO_NONALERT,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="type">size_t</span> dataLength = <span class="built_in">strlen</span>(Data);</span><br><span class="line">        ZwWriteFile(fileHandle, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;ioStatusBlock, Data, (ULONG)dataLength, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        ZwClose(fileHandle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Failed to create file: %08X\n&quot;</span>, status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">EnumProcesses</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    ULONG bufferSize = <span class="number">0x10000</span>; <span class="comment">// Initial buffer size, can grow if needed</span></span><br><span class="line">    ULONG returnLength;</span><br><span class="line">    CHAR logBuffer[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    UNICODE_STRING filePath;</span><br><span class="line">    RtlInitUnicodeString(&amp;filePath, <span class="string">L&quot;\\??\\C:\\Users\\15386\\Desktop\\1.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buffer = ExAllocatePoolWithTag(NonPagedPool, bufferSize, <span class="string">&#x27;proc&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!buffer) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Failed to allocate buffer for process information\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = ZwQuerySystemInformation(SystemProcessInformation, buffer, bufferSize, &amp;returnLength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH) &#123;</span><br><span class="line">        ExFreePool(buffer);</span><br><span class="line">        bufferSize = returnLength;</span><br><span class="line">        buffer = ExAllocatePoolWithTag(NonPagedPool, bufferSize, <span class="string">&#x27;proc&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!buffer) &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;Failed to allocate larger buffer for process information\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        status = ZwQuerySystemInformation(SystemProcessInformation, buffer, bufferSize, &amp;returnLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        PSYSTEM_PROCESS_INFORMATION processInfo = (PSYSTEM_PROCESS_INFORMATION)buffer;</span><br><span class="line">        <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (processInfo-&gt;ImageName.Buffer) &#123;</span><br><span class="line">                _snprintf(logBuffer, <span class="keyword">sizeof</span>(logBuffer), <span class="string">&quot;Process ID: %lu, Name: %wZ\n&quot;</span>, (ULONG)(ULONG_PTR)processInfo-&gt;ProcessId, &amp;processInfo-&gt;ImageName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                _snprintf(logBuffer, <span class="keyword">sizeof</span>(logBuffer), <span class="string">&quot;Process ID: %lu, Name: [System Process]\n&quot;</span>, (ULONG)(ULONG_PTR)processInfo-&gt;ProcessId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WriteToFile(&amp;filePath, logBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (processInfo-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            processInfo = (PSYSTEM_PROCESS_INFORMATION)((PUCHAR)processInfo + processInfo-&gt;NextEntryOffset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ExFreePool(buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果发现好像没有奇怪的进程被创建出来，那么有可能是驱动利用<code>PsCreateSystemThread</code>创建了一个内核线程。hook<code>PsCreateSystemThread</code>函数看看驱动加载时是否调用了这个函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;R0Hook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> dbgFilter <span class="string">&quot;Kvancy:&quot;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">ULONG</span><span class="params">(*FuncPtr)</span> <span class="params">(</span></span><br><span class="line"><span class="params">    PHANDLE            ThreadHandle,</span></span><br><span class="line"><span class="params">    ULONG              DesiredAccess,</span></span><br><span class="line"><span class="params">    POBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    HANDLE             ProcessHandle,</span></span><br><span class="line"><span class="params">    PCLIENT_ID         ClientId,</span></span><br><span class="line"><span class="params">    PKSTART_ROUTINE    StartRoutine,</span></span><br><span class="line"><span class="params">    PVOID              StartContext)</span>;</span><br><span class="line">HOOK_MANAGER hookManager;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">myPsCreateSystemThread</span><span class="params">(</span></span><br><span class="line"><span class="params">    PHANDLE            ThreadHandle,</span></span><br><span class="line"><span class="params">    ULONG              DesiredAccess,</span></span><br><span class="line"><span class="params">    POBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    HANDLE             ProcessHandle,</span></span><br><span class="line"><span class="params">    PCLIENT_ID         ClientId,</span></span><br><span class="line"><span class="params">    PKSTART_ROUTINE    StartRoutine,</span></span><br><span class="line"><span class="params">    PVOID              StartContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    Unhook(&amp;hookManager);</span><br><span class="line">    FuncPtr func = (FuncPtr)hookManager.target;</span><br><span class="line">    kPrint(<span class="string">&quot;%s myPsCreateSystemThread StartRoutine:%p\n&quot;</span>, dbgFilter, StartRoutine);</span><br><span class="line">    NTSTATUS s = func(ThreadHandle, DesiredAccess, ObjectAttributes, ProcessHandle, ClientId, StartRoutine, StartContext);</span><br><span class="line">    ApplyHook(&amp;hookManager);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kPrint(<span class="string">&quot;%s DriverUnload\n&quot;</span>, dbgFilter);</span><br><span class="line">    Unhook(&amp;hookManager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    PVOID dbgPrintEx = PsCreateSystemThread;</span><br><span class="line">    InitializeHookManager(&amp;hookManager, dbgPrintEx, myPsCreateSystemThread);</span><br><span class="line">    ApplyHook(&amp;hookManager);</span><br><span class="line">    DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;%s DriverEntry\n&quot;</span>, dbgFilter);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/10/02/fkDhVr5juzyYTMS.png" alt="{81A1CDF1-D6A3-454A-BAA1-BAE048F8B7F3}"></p>
<p>发现在token2输出前确实有PsCreateSystemThread函数调用，虽然不确定是不是ace.sys创建的。在windbg里反汇编看看线程函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; u FFFFBA0729013DB0 l 100</span><br><span class="line">ffffba07`29013db0 488bc4          mov     rax,rsp</span><br><span class="line">ffffba07`29013db3 48895808        mov     qword ptr [rax+8],rbx</span><br><span class="line">ffffba07`29013db7 48897818        mov     qword ptr [rax+18h],rdi</span><br><span class="line">ffffba07`29013dbb 4c897020        mov     qword ptr [rax+20h],r14</span><br><span class="line">ffffba07`29013dbf 55              push    rbp</span><br><span class="line">ffffba07`29013dc0 488d68a1        lea     rbp,[rax-5Fh]</span><br><span class="line">ffffba07`29013dc4 4881eca0000000  sub     rsp,0A0h</span><br><span class="line">ffffba07`29013dcb 48bf4e93328b546b331e mov rdi,1E336B548B32934Eh</span><br><span class="line">ffffba07`29013dd5 49bed520794add1d6d4b mov r14,4B6D1DDD4A7920D5h</span><br><span class="line">ffffba07`29013ddf 0f57c0          xorps   xmm0,xmm0</span><br><span class="line">ffffba07`29013de2 488d4d37        lea     rcx,[rbp+37h]</span><br><span class="line">ffffba07`29013de6 0f114537        movups  xmmword ptr [rbp+37h],xmm0</span><br><span class="line">ffffba07`29013dea e8d1030000      call    ffffba07`290141c0</span><br><span class="line">ffffba07`29013def 48b8a14f122fb3276d4b mov rax,4B6D27B32F124FA1h</span><br><span class="line">ffffba07`29013df9 4c8d45e7        lea     r8,[rbp-19h]</span><br><span class="line">ffffba07`29013dfd 4889456f        mov     qword ptr [rbp+6Fh],rax</span><br><span class="line">ffffba07`29013e01 ba05000000      mov     edx,5</span><br><span class="line">ffffba07`29013e06 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e0a 33c9            xor     ecx,ecx</span><br><span class="line">ffffba07`29013e0c 488945e7        mov     qword ptr [rbp-19h],rax</span><br><span class="line">ffffba07`29013e10 48897d6f        mov     qword ptr [rbp+6Fh],rdi</span><br><span class="line">ffffba07`29013e14 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e18 488945ef        mov     qword ptr [rbp-11h],rax</span><br><span class="line">ffffba07`29013e1c 4c89756f        mov     qword ptr [rbp+6Fh],r14</span><br><span class="line">ffffba07`29013e20 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e24 48894517        mov     qword ptr [rbp+17h],rax</span><br><span class="line">ffffba07`29013e28 48897d6f        mov     qword ptr [rbp+6Fh],rdi</span><br><span class="line">ffffba07`29013e2c 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e30 660f6f45e7      movdqa  xmm0,xmmword ptr [rbp-19h]</span><br><span class="line">ffffba07`29013e35 4889451f        mov     qword ptr [rbp+1Fh],rax</span><br><span class="line">ffffba07`29013e39 660fef4517      pxor    xmm0,xmmword ptr [rbp+17h]</span><br><span class="line">ffffba07`29013e3e 488b0543330000  mov     rax,qword ptr [ffffba07`29017188]</span><br><span class="line">ffffba07`29013e45 660f7f45e7      movdqa  xmmword ptr [rbp-19h],xmm0</span><br><span class="line">ffffba07`29013e4a ff15c8210000    call    qword ptr [ffffba07`29016018]</span><br><span class="line">ffffba07`29013e50 33db            xor     ebx,ebx</span><br><span class="line">ffffba07`29013e52 48b8f0104b32dd1d6d4b mov rax,4B6D1DDD324B10F0h</span><br><span class="line">ffffba07`29013e5c 4c8d45f7        lea     r8,[rbp-9]</span><br><span class="line">ffffba07`29013e60 4889456f        mov     qword ptr [rbp+6Fh],rax</span><br><span class="line">ffffba07`29013e64 ba05000000      mov     edx,5</span><br><span class="line">ffffba07`29013e69 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e6d 33c9            xor     ecx,ecx</span><br><span class="line">ffffba07`29013e6f 488945f7        mov     qword ptr [rbp-9],rax</span><br><span class="line">ffffba07`29013e73 48897d6f        mov     qword ptr [rbp+6Fh],rdi</span><br><span class="line">ffffba07`29013e77 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e7b 488945ff        mov     qword ptr [rbp-1],rax</span><br><span class="line">ffffba07`29013e7f 4c89756f        mov     qword ptr [rbp+6Fh],r14</span><br><span class="line">ffffba07`29013e83 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e87 48894527        mov     qword ptr [rbp+27h],rax</span><br><span class="line">ffffba07`29013e8b 48897d6f        mov     qword ptr [rbp+6Fh],rdi</span><br><span class="line">ffffba07`29013e8f 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013e93 660f6f45f7      movdqa  xmm0,xmmword ptr [rbp-9]</span><br><span class="line">ffffba07`29013e98 440fb64c1d37    movzx   r9d,byte ptr [rbp+rbx+37h]</span><br><span class="line">ffffba07`29013e9e 4889452f        mov     qword ptr [rbp+2Fh],rax</span><br><span class="line">ffffba07`29013ea2 660fef4527      pxor    xmm0,xmmword ptr [rbp+27h]</span><br><span class="line">ffffba07`29013ea7 488b05da320000  mov     rax,qword ptr [ffffba07`29017188]</span><br><span class="line">ffffba07`29013eae 660f7f45f7      movdqa  xmmword ptr [rbp-9],xmm0</span><br><span class="line">ffffba07`29013eb3 ff155f210000    call    qword ptr [ffffba07`29016018]</span><br><span class="line">ffffba07`29013eb9 48ffc3          inc     rbx</span><br><span class="line">ffffba07`29013ebc 4883fb10        cmp     rbx,10h</span><br><span class="line">ffffba07`29013ec0 7c90            jl      ffffba07`29013e52</span><br><span class="line">ffffba07`29013ec2 48b8df20794add1d6d4b mov rax,4B6D1DDD4A7920DFh</span><br><span class="line">ffffba07`29013ecc 4c8d4507        lea     r8,[rbp+7]</span><br><span class="line">ffffba07`29013ed0 4889456f        mov     qword ptr [rbp+6Fh],rax</span><br><span class="line">ffffba07`29013ed4 ba05000000      mov     edx,5</span><br><span class="line">ffffba07`29013ed9 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013edd 33c9            xor     ecx,ecx</span><br><span class="line">ffffba07`29013edf 48894507        mov     qword ptr [rbp+7],rax</span><br><span class="line">ffffba07`29013ee3 48897d6f        mov     qword ptr [rbp+6Fh],rdi</span><br><span class="line">ffffba07`29013ee7 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013eeb 4889450f        mov     qword ptr [rbp+0Fh],rax</span><br><span class="line">ffffba07`29013eef 4c89756f        mov     qword ptr [rbp+6Fh],r14</span><br><span class="line">ffffba07`29013ef3 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013ef7 48894547        mov     qword ptr [rbp+47h],rax</span><br><span class="line">ffffba07`29013efb 48897d6f        mov     qword ptr [rbp+6Fh],rdi</span><br><span class="line">ffffba07`29013eff 488b456f        mov     rax,qword ptr [rbp+6Fh]</span><br><span class="line">ffffba07`29013f03 660f6f4507      movdqa  xmm0,xmmword ptr [rbp+7]</span><br><span class="line">ffffba07`29013f08 4889454f        mov     qword ptr [rbp+4Fh],rax</span><br><span class="line">ffffba07`29013f0c 660fef4547      pxor    xmm0,xmmword ptr [rbp+47h]</span><br><span class="line">ffffba07`29013f11 488b0570320000  mov     rax,qword ptr [ffffba07`29017188]</span><br><span class="line">ffffba07`29013f18 660f7f4507      movdqa  xmmword ptr [rbp+7],xmm0</span><br><span class="line">ffffba07`29013f1d ff15f5200000    call    qword ptr [ffffba07`29016018]</span><br><span class="line">ffffba07`29013f23 b9ce0a0000      mov     ecx,0ACEh</span><br><span class="line">ffffba07`29013f28 e833e9ffff      call    ffffba07`29012860</span><br><span class="line">ffffba07`29013f2d e9adfeffff      jmp     ffffba07`29013ddf</span><br><span class="line">ffffba07`29013f32 cc              int     3</span><br><span class="line">ffffba07`29013f33 cc              int     3</span><br><span class="line">ffffba07`29013f34 4152            push    r10</span><br></pre></td></tr></table></figure>

<p>导入到ida里看伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">sub_180005148</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __m128i v0; <span class="comment">// xmm0</span></span><br><span class="line">  __int64 i; <span class="comment">// rbx</span></span><br><span class="line">  __m128i v2; <span class="comment">// xmm0</span></span><br><span class="line">  __int64 v3; <span class="comment">// r9</span></span><br><span class="line">  __m128i v4; <span class="comment">// xmm0</span></span><br><span class="line">  __m128i v5; <span class="comment">// [rsp+30h] [rbp-19h] BYREF</span></span><br><span class="line">  __m128i v6; <span class="comment">// [rsp+40h] [rbp-9h] BYREF</span></span><br><span class="line">  __m128i v7; <span class="comment">// [rsp+50h] [rbp+7h] BYREF</span></span><br><span class="line">  __m128i v8; <span class="comment">// [rsp+60h] [rbp+17h]</span></span><br><span class="line">  __m128i v9; <span class="comment">// [rsp+70h] [rbp+27h]</span></span><br><span class="line">  __int128 v10; <span class="comment">// [rsp+80h] [rbp+37h] BYREF</span></span><br><span class="line">  __m128i v11; <span class="comment">// [rsp+90h] [rbp+47h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="number">0</span>i64;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(__int128 *))((<span class="type">char</span> *)&amp;loc_180005556 + <span class="number">2</span>))(&amp;v10);</span><br><span class="line">    v5.m128i_i64[<span class="number">0</span>] = <span class="number">0x4B6D27B32F124FA1</span>i64;</span><br><span class="line">    v5.m128i_i64[<span class="number">1</span>] = <span class="number">0x1E336B548B32934E</span>i64;</span><br><span class="line">    v8.m128i_i64[<span class="number">0</span>] = <span class="number">0x4B6D1DDD4A7920D5</span>i64;</span><br><span class="line">    v0 = _mm_load_si128(&amp;v5);</span><br><span class="line">    v8.m128i_i64[<span class="number">1</span>] = <span class="number">0x1E336B548B32934E</span>i64;</span><br><span class="line">    v5 = _mm_xor_si128(v0, v8);</span><br><span class="line">    MEMORY[<span class="number">0x31305A8047353130</span>](<span class="number">0</span>i64, <span class="number">5</span>i64, &amp;v5);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>i64; i &lt; <span class="number">16</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v6.m128i_i64[<span class="number">0</span>] = <span class="number">0x4B6D1DDD324B10F0</span>i64;</span><br><span class="line">      v6.m128i_i64[<span class="number">1</span>] = <span class="number">0x1E336B548B32934E</span>i64;</span><br><span class="line">      v9.m128i_i64[<span class="number">0</span>] = <span class="number">0x4B6D1DDD4A7920D5</span>i64;</span><br><span class="line">      v2 = _mm_load_si128(&amp;v6);</span><br><span class="line">      v3 = *((<span class="type">unsigned</span> __int8 *)&amp;v10 + i);</span><br><span class="line">      v9.m128i_i64[<span class="number">1</span>] = <span class="number">0x1E336B548B32934E</span>i64;</span><br><span class="line">      v6 = _mm_xor_si128(v2, v9);</span><br><span class="line">      MEMORY[<span class="number">0x31305A8047353130</span>](<span class="number">0</span>i64, <span class="number">5</span>i64, &amp;v6, v3);</span><br><span class="line">    &#125;</span><br><span class="line">    v7.m128i_i64[<span class="number">0</span>] = <span class="number">0x4B6D1DDD4A7920DF</span>i64;</span><br><span class="line">    v7.m128i_i64[<span class="number">1</span>] = <span class="number">0x1E336B548B32934E</span>i64;</span><br><span class="line">    v11.m128i_i64[<span class="number">0</span>] = <span class="number">0x4B6D1DDD4A7920D5</span>i64;</span><br><span class="line">    v4 = _mm_load_si128(&amp;v7);</span><br><span class="line">    v11.m128i_i64[<span class="number">1</span>] = <span class="number">0x1E336B548B32934E</span>i64;</span><br><span class="line">    v7 = _mm_xor_si128(v4, v11);</span><br><span class="line">    MEMORY[<span class="number">0x31305A8047353130</span>](<span class="number">0</span>i64, <span class="number">5</span>i64, &amp;v7);</span><br><span class="line">    sub_180003BF8(<span class="number">2766</span>i64);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好像是做了一个字符串解密然后输出的操作，浅浅用python跑一下解析字符串验证猜想。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hex_xor_to_string</span>(<span class="params">a, b</span>):</span><br><span class="line">    result = a ^ b</span><br><span class="line">    hex_str = <span class="built_in">hex</span>(result)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hex_str) % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">        hex_str = <span class="string">&#x27;0&#x27;</span> + hex_str</span><br><span class="line"></span><br><span class="line">    result_str = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(<span class="built_in">int</span>(hex_str[i:i+<span class="number">2</span>], <span class="number">16</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(hex_str), <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> result_str</span><br><span class="line"></span><br><span class="line">x1 = <span class="number">0x4B6D27B32F124FA1</span></span><br><span class="line">x2 = <span class="number">0x1E336B548B32934E</span></span><br><span class="line">y1 = <span class="number">0x4B6D1DDD4A7920D5</span></span><br><span class="line">y2 = <span class="number">0x1E336B548B32934E</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result1 = hex_xor_to_string(x1, y1)</span><br><span class="line">result2 = hex_xor_to_string(x2, y2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 1:&quot;</span>, result1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Result 2:&quot;</span>, result2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = result1[::-<span class="number">1</span>] + result2[::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/10/02/yQT7sZ1UnvRAcXk.png" alt="{8FBDE081-6C77-49BA-BEDA-94E3B44A9056}"></p>
<p>打印出了<code>token</code>基本上确定了这个线程就是打印token的线程，现在就是要想怎么patch这个线程函数使得token能够输出出来。</p>
<p><img src="https://s2.loli.net/2024/10/02/7zjZDi1Y9JPTAvX.png" alt="image-20240919195412464">)</p>
<p>这里有个<code>mov edx,5</code>语句，将DbgPrintEx函数的level设置成5，可以考虑patch这个语句，将5改成0，那么只需要patch一个字节，共三处。但是又要怎么patch呢，首先不能通过现在这种方式hook PsCreateSystemThread函数调用来确定StartRoutine地址（题目要求不能修改系统模块代码），也就是说得想另外一个办法确定这个线程的地址，然后通过偏移来确定需要patch的地址。</p>
<p>那么怎么确定这个线程地址呢，如果通过<code>ZwQuerySystemInformation</code>枚举内核模块然后枚举模块下的所有线程的话，已经卸载了的ace.sys模块还能被枚举到么？问了下GPT好像是不能的，还可以考虑用StartRoutine地址的后几位做特征，匹配所有线程的开始地址的后几位，但是这种方式又感觉怕遇到地址特征一模一样的，感觉还是不大行。又问GPT怎么寻找到某个内核线程，得到答复是除了<code>ZwQuerySystemInformation</code>枚举，还有通过<code>PsLookupThreadByThreadId</code>函数从进程id和线程id查找的。</p>
<p>那么线程id和进程id又从哪获取呢？因为之前hook过PsCreateSystemThread函数，翻阅文档找到了一个ClientId参数，这个参数指向接收新线程的客户端标识符的结构，即一个pid，一个tid，但是pid，tid应该都是系统分配的吧，能是一个固定值么？hook一下看看输出</p>
<p><img src="https://s2.loli.net/2024/09/28/yEc1leFT3afZI69.png" alt="image-20240919214001840"></p>
<p><img src="https://s2.loli.net/2024/10/02/1KTEVnb9uPWsjpr.png" alt="image-20240919215044101"></p>
<p>诶，tid貌似是系统分配的，但是pid一直都是4，很奇怪，pid&#x3D;4代表的是什么进程呢？之前刚好枚举过进程来找有没有新进程创建，现在正好能派上用场。</p>
<p><img src="https://s2.loli.net/2024/10/02/TOdNVCHav1FIbol.png" alt="image-20240919215837787"></p>
<p>貌似是一个系统进程，GPT了一下发现原来如果驱动程序通过内核模式创建系统线程（使用<code>PsCreateSystemThread</code>），这些线程通常会在系统进程下运行，PID为4。原来如此，驱动程序和进程是一个级别的，但是驱动程序创建的这个线程是在系统进程之下的，而不是属于驱动模块，只是线程起始地址隶属于模块地址空间的，驱动卸载并不影响线程的运行。</p>
<p>这样的话，我们要找的线程因为模块被卸载了，所以它不在所有模块地址空间内，只要枚举所有系统进程pid&#x3D;4下的所有线程，然后通过判断线程的起始地址是否在所有模块地址之内，即可判断它是否是我们要找的线程。这下思路就通了，开始编写代码实现patch。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;header.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PVOID MoudleBaseAddress[<span class="number">1024</span>];</span><br><span class="line">ULONG64 MoudleSize[<span class="number">1024</span>];</span><br><span class="line">ULONG ModuleCount = <span class="number">0</span>;</span><br><span class="line">ULONG Offset1 = <span class="number">0x52</span>, Offset2 = <span class="number">0xB5</span>, Offset3 = <span class="number">0x125</span>;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">IsAddressInKnownModules</span><span class="params">(PVOID Address, PVOID* ModuleBaseAddresses, ULONG64* ModuleSize, ULONG ModuleCount)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ModuleCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Address &gt;= ModuleBaseAddresses[i] &amp;&amp; Address &lt; (ULONG64)ModuleBaseAddresses[i] + ModuleSize[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PVOID <span class="title function_">EnumSystemModulesForProcess</span><span class="params">(HANDLE TargetProcessId)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG bufferSize = <span class="number">0x10000</span>;</span><br><span class="line">    PVOID processBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    PVOID moduleBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    ULONG returnLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询进程信息</span></span><br><span class="line">    processBuffer = ExAllocatePoolWithTag(NonPagedPool, bufferSize, <span class="string">&#x27;proc&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!processBuffer) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Failed to allocate buffer for process information\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = ZwQuerySystemInformation(SystemProcessInformation, processBuffer, bufferSize, &amp;returnLength);</span><br><span class="line">    <span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH) &#123;</span><br><span class="line">        ExFreePool(processBuffer);</span><br><span class="line">        bufferSize = returnLength;</span><br><span class="line">        processBuffer = ExAllocatePoolWithTag(NonPagedPool, bufferSize, <span class="string">&#x27;proc&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!processBuffer) &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;Failed to allocate larger buffer for process information\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        status = ZwQuerySystemInformation(SystemProcessInformation, processBuffer, bufferSize, &amp;returnLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询模块信息</span></span><br><span class="line">    moduleBuffer = ExAllocatePoolWithTag(NonPagedPool, bufferSize, <span class="string">&#x27;modl&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!moduleBuffer) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Failed to allocate buffer for module information\n&quot;</span>);</span><br><span class="line">        ExFreePool(processBuffer);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = ZwQuerySystemInformation(SystemModuleInformation, moduleBuffer, bufferSize, &amp;returnLength);</span><br><span class="line">    <span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH) &#123;</span><br><span class="line">        ExFreePool(moduleBuffer);</span><br><span class="line">        bufferSize = returnLength;</span><br><span class="line">        moduleBuffer = ExAllocatePoolWithTag(NonPagedPool, bufferSize, <span class="string">&#x27;modl&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!moduleBuffer) &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;Failed to allocate larger buffer for module information\n&quot;</span>);</span><br><span class="line">            ExFreePool(processBuffer);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        status = ZwQuerySystemInformation(SystemModuleInformation, moduleBuffer, bufferSize, &amp;returnLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历模块信息</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        PSYSTEM_MODULE_INFORMATION moduleInfo = (PSYSTEM_MODULE_INFORMATION)moduleBuffer;</span><br><span class="line">        ModuleCount = moduleInfo-&gt;ModulesCount;</span><br><span class="line">        <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; moduleInfo-&gt;ModulesCount; i++) &#123;</span><br><span class="line">            PSYSTEM_MODULE_INFORMATION_ENTRY moduleEntry = &amp;moduleInfo-&gt;Modules[i];</span><br><span class="line">            MoudleBaseAddress[i] = moduleEntry-&gt;Base;</span><br><span class="line">            MoudleSize[i] = moduleEntry-&gt;Size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历进程信息</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        PSYSTEM_PROCESS_INFORMATION processInfo = (PSYSTEM_PROCESS_INFORMATION)processBuffer;</span><br><span class="line">        <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (processInfo-&gt;ProcessId == TargetProcessId) &#123;</span><br><span class="line">                PSYSTEM_THREAD_INFORMATION threadInfo = (PSYSTEM_THREAD_INFORMATION)(processInfo + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; processInfo-&gt;NumberOfThreads; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!IsAddressInKnownModules(threadInfo[i].StartAddress, MoudleBaseAddress, MoudleSize, ModuleCount))</span><br><span class="line">                    &#123;</span><br><span class="line">                        DbgPrint(<span class="string">&quot;Find it:%p\n&quot;</span>,threadInfo[i].StartAddress);</span><br><span class="line">                        <span class="keyword">return</span> threadInfo[i].StartAddress;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (processInfo-&gt;NextEntryOffset == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            processInfo = (PSYSTEM_PROCESS_INFORMATION)((PUCHAR)processInfo + processInfo-&gt;NextEntryOffset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理分配的内存</span></span><br><span class="line">    ExFreePool(processBuffer);</span><br><span class="line">    ExFreePool(moduleBuffer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">UnloadDriver</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> &#123;</span><br><span class="line">    KdPrint((<span class="string">&quot;Driver Unloaded\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">    KdPrint((<span class="string">&quot;Driver Loaded\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">    HANDLE targetPid = (HANDLE)<span class="number">4</span>; <span class="comment">// 系统进程的 PID</span></span><br><span class="line">    PVOID targetAddress = EnumSystemModulesForProcess(targetPid);</span><br><span class="line"></span><br><span class="line">    UCHAR valueToWrite = <span class="number">0x00</span>; <span class="comment">// 要写入的字节值</span></span><br><span class="line">    UCHAR valueToRead = <span class="number">0x05</span>; <span class="comment">// 要写入的字节值</span></span><br><span class="line">    ULONG numHasChanged = <span class="number">0x00</span>;</span><br><span class="line">    <span class="keyword">if</span> (*(PUCHAR)((ULONG64)targetAddress + Offset1) == valueToRead)</span><br><span class="line">    &#123;</span><br><span class="line">        *(PUCHAR)((ULONG64)targetAddress + Offset1) = valueToWrite;</span><br><span class="line">        numHasChanged++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(PUCHAR)((ULONG64)targetAddress + Offset2) == valueToRead)</span><br><span class="line">    &#123;</span><br><span class="line">        *(PUCHAR)((ULONG64)targetAddress + Offset2) = valueToWrite;</span><br><span class="line">        numHasChanged++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(PUCHAR)((ULONG64)targetAddress + Offset3) == valueToRead)</span><br><span class="line">    &#123;</span><br><span class="line">        *(PUCHAR)((ULONG64)targetAddress + Offset3) = valueToWrite;</span><br><span class="line">        numHasChanged++;</span><br><span class="line">    &#125;</span><br><span class="line">    DbgPrint(<span class="string">&quot;numHasChanged:%d\n&quot;</span>, numHasChanged);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>成功输出token2</p>
<p><img src="https://s2.loli.net/2024/09/28/oZUh4qG7FBXanWO.png" alt="image-20240920125107119"></p>
<h2 id="（三）解题过程"><a href="#（三）解题过程" class="headerlink" title="（三）解题过程"></a>（三）解题过程</h2><p>题目要求：</p>
<p>编写程序，运行时修改尽量少的内存，让shellcode 往自行指定的位置写入token1成功。（满分3分）</p>
<p>要求任意位置，也就是要修改CreateFileA函数的第一个参数的值，根据之前分析的<code>C:\2024GameSafeRace.token1</code>字符串是由十六进制异或得到的，也就是下面这些<br><img src="https://s2.loli.net/2024/10/02/suczGZU14mQHv8i.png" alt="image-20240920145014956"></p>
<p>可以考虑的是patch这些十六进制数据，把异或的key改成0，然后密文改成明文即可，因为明文异或0还是明文，但是考虑到要尽量修改少量的内存，我们最好还是保持key不变，自定义密文解密到我们所要的文件地址。跑个python脚本解出新的密文，得到新的密文，接着找到密文所在文件的偏移然后patch即可，给出解题代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dllmain.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shellapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _KDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBGMGEBOX(fmt, ...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">         <span class="comment">/* 假设最大长度为1024，根据需要调整大小 */</span> \</span></span><br><span class="line"><span class="meta">        wsprintfA(out, fmt, __VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        MessageBoxA(NULL, out, <span class="string">&quot;提示&quot;</span>, MB_OK); \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"><span class="type">char</span> out[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">BOOL</span><span class="params">(WINAPI* WriteProcessMemory_t)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE hProcess,</span></span><br><span class="line"><span class="params">    _In_ LPVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T nSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ SIZE_T* lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">WriteProcessMemory_t TrueWriteProcessMemory = <span class="literal">NULL</span>;</span><br><span class="line">BOOL</span><br><span class="line">WINAPI</span><br><span class="line"><span class="title function_">HookWriteProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE hProcess,</span></span><br><span class="line"><span class="params">    _In_ LPVOID lpBaseAddress,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_(nSize) LPCVOID lpBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T nSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ SIZE_T* lpNumberOfBytesWritten</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (nSize == <span class="number">4506624</span> &amp;&amp; *((PUCHAR)lpBuffer + <span class="number">0x7171</span>) == <span class="number">0x3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *((PUCHAR)lpBuffer + <span class="number">0x7171</span>) = <span class="number">0x4</span>;</span><br><span class="line">        *(PULONG64)((ULONG64)lpBuffer + <span class="number">0x7082</span>) = <span class="number">0x94e7c2136acc0e5c</span>;<span class="comment">//</span></span><br><span class="line">        *(PULONG64)((ULONG64)lpBuffer + <span class="number">0x7093</span>) = <span class="number">0x8207c5d1af9f3860</span>;</span><br><span class="line">        *(PULONG64)((ULONG64)lpBuffer + <span class="number">0x70F1</span>) = <span class="number">0xa905cca9edcb138c</span>;</span><br><span class="line">        *(PULONG64)((ULONG64)lpBuffer + <span class="number">0x7108</span>) = <span class="number">0xa753b8236c56809a</span>;</span><br><span class="line">        <span class="comment">//C:\Users\15386\Desktop\flag.txt</span></span><br><span class="line">        DBGMGEBOX(<span class="string">&quot;Hook Success!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TrueWriteProcessMemory(hProcess, lpBaseAddress, lpBuffer, nSize, lpNumberOfBytesWritten);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line"></span><br><span class="line">        DetourTransactionBegin();</span><br><span class="line">        DetourUpdateThread(GetCurrentThread());</span><br><span class="line"></span><br><span class="line">        TrueWriteProcessMemory = (WriteProcessMemory_t)DetourFindFunction(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;WriteProcessMemory&quot;</span>);</span><br><span class="line">        DetourAttach(&amp;(PVOID&amp;)TrueWriteProcessMemory, HookWriteProcessMemory);</span><br><span class="line"></span><br><span class="line">        DetourTransactionCommit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        DetourTransactionBegin();</span><br><span class="line">        DetourUpdateThread(GetCurrentThread());</span><br><span class="line">        DetourDetach(&amp;(PVOID&amp;)TrueWriteProcessMemory, HookWriteProcessMemory);</span><br><span class="line"></span><br><span class="line">        DetourTransactionCommit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入hook成功后，成功在桌面的<code>flag.txt</code>输出token1</p>
<p><img src="https://s2.loli.net/2024/10/02/PIej3obTn5NLDyE.png" alt="{87F08EF1-EECF-4DBC-A7D0-954E04FFA9CD}"></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E7%A0%B4%E8%A7%A3/">破解</a><a class="link-muted mr-2" rel="tag" href="/tags/%E9%80%86%E5%90%91/">逆向</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/08/13/2023%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%86%B3%E8%B5%9B/"><span class="level-item">2023腾讯游戏安全PC决赛</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/d1dad23c8c4baa8aadd7ab73213dfbfd?s=128" alt="Kvancy"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Kvancy</p><p class="is-size-6 is-block">CTFer / Reverser</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国/江西</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">5</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Kvancy" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/Kvancy"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#题目"><span class="level-left"><span class="level-item">1</span><span class="level-item">题目</span></span></a></li><li><a class="level is-mobile" href="#（一）解题过程"><span class="level-left"><span class="level-item">2</span><span class="level-item">（一）解题过程</span></span></a></li><li><a class="level is-mobile" href="#（二）解题过程"><span class="level-left"><span class="level-item">3</span><span class="level-item">（二）解题过程</span></span></a></li><li><a class="level is-mobile" href="#（三）解题过程"><span class="level-left"><span class="level-item">4</span><span class="level-item">（三）解题过程</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.52pojie.cn/thread-1954225-1-1.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">2023腾讯游戏安全PC决赛复现</span></span><span class="level-right"><span class="level-item tag">www.52pojie.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.52pojie.cn/thread-1952072-1-1.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">2022腾讯游戏安全PC端初赛复现</span></span><span class="level-right"><span class="level-item tag">www.52pojie.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.52pojie.cn/thread-1948904-1-1.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">2023年腾讯游戏安全竞赛PC端初赛复现</span></span><span class="level-right"><span class="level-item tag">www.52pojie.cn</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E8%B7%B5/"><span class="level-start"><span class="level-item">实践</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">笔记</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-22T16:00:00.000Z">2024-09-23</time></p><p class="title"><a href="/2024/09/23/2024%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/">2024腾讯游戏安全PC初赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-12T16:00:00.000Z">2024-08-13</time></p><p class="title"><a href="/2024/08/13/2023%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%86%B3%E8%B5%9B/">2023腾讯游戏安全PC决赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-05T16:00:00.000Z">2024-08-06</time></p><p class="title"><a href="/2024/08/06/2022%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/">2022腾讯游戏安全PC初赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-27T16:00:00.000Z">2024-07-28</time></p><p class="title"><a href="/2024/07/28/2023%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/">2023腾讯游戏安全PC初赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-04-30T16:00:00.000Z">2024-05-01</time></p><p class="title"><a href="/2024/05/01/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">Windows内核逆向学习记录</a></p><p class="categories"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/09/"><span class="level-start"><span class="level-item">September 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/08/"><span class="level-start"><span class="level-item">August 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">July 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">May 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/04/"><span class="level-start"><span class="level-item">April 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">January 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">September 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/07/"><span class="level-start"><span class="level-item">July 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">May 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">April 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%AE%B0/"><span class="tag">杂记</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A0%B4%E8%A7%A3/"><span class="tag">破解</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%86%E5%90%91/"><span class="tag">逆向</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A9%B1%E5%8A%A8/"><span class="tag">驱动</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/Kvancy.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2024 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>