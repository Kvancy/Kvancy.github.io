<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>逆向笔记 - Kvancy</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Kvancy"><meta name="msapplication-TileImage" content="/img/Myfavicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Kvancy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="逆向的开始！从这开始记录我在做逆向题目时遇到的问题以及总结一些逆向的知识点"><meta property="og:type" content="blog"><meta property="og:title" content="Kvancy"><meta property="og:url" content="http://120.46.134.9/2023/04/09/re/"><meta property="og:site_name" content="Kvancy"><meta property="og:description" content="逆向的开始！从这开始记录我在做逆向题目时遇到的问题以及总结一些逆向的知识点"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://s2.loli.net/2024/06/22/URIjbw4sLCHTS8Q.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/QkYWnuEXvbVM8Kp.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/8isNvxnrQpDVHFE.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/KBonGr7HZgWVIC4.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/8aATK9XVMOtGpPn.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/VWTSJEYMnOjZIr4.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/HUTfFSkE8Pwtm9R.png"><meta property="og:image" content="https://s2.loli.net/2024/06/22/z1xhTRjQWKd3IDk.png"><meta property="article:published_time" content="2023-04-08T16:00:00.000Z"><meta property="article:modified_time" content="2024-09-27T13:52:52.080Z"><meta property="article:author" content="Kvancy"><meta property="article:tag" content="逆向"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://s2.loli.net/2024/06/22/URIjbw4sLCHTS8Q.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://120.46.134.9/2023/04/09/re/"},"headline":"逆向笔记","image":["https://s2.loli.net/2024/06/22/URIjbw4sLCHTS8Q.png","https://s2.loli.net/2024/06/22/QkYWnuEXvbVM8Kp.png","https://s2.loli.net/2024/06/22/8isNvxnrQpDVHFE.png","https://s2.loli.net/2024/06/22/KBonGr7HZgWVIC4.png","https://s2.loli.net/2024/06/22/8aATK9XVMOtGpPn.png","https://s2.loli.net/2024/06/22/VWTSJEYMnOjZIr4.png","https://s2.loli.net/2024/06/22/HUTfFSkE8Pwtm9R.png","https://s2.loli.net/2024/06/22/z1xhTRjQWKd3IDk.png"],"datePublished":"2023-04-08T16:00:00.000Z","dateModified":"2024-09-27T13:52:52.080Z","author":{"@type":"Person","name":"John Doe"},"publisher":{"@type":"Organization","name":"Kvancy","logo":{"@type":"ImageObject","url":"http://120.46.134.9/img/Kvancy.svg"}},"description":"逆向的开始！从这开始记录我在做逆向题目时遇到的问题以及总结一些逆向的知识点"}</script><link rel="canonical" href="http://120.46.134.9/2023/04/09/re/"><link rel="icon" href="/img/Myfavicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/Kvancy.svg" alt="Kvancy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Kvancy"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-04-08T16:00:00.000Z" title="2023/4/9 00:00:00">2023-04-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-27T13:52:52.080Z" title="2024/9/27 21:52:52">2024-09-27</time></span><span class="level-item"><a class="link-muted" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span><span class="level-item">an hour read (About 11652 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">逆向笔记</h1><div class="content"><p>逆向的开始！从这开始记录我在做逆向题目时遇到的问题以及总结一些逆向的知识点<span id="more"></span></p>
<h2 id="BFS脚本："><a href="#BFS脚本：" class="headerlink" title="BFS脚本："></a>BFS脚本：</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">char</span> map[<span class="number">15</span>][<span class="number">13</span>]=&#123;</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span>  <span class="title class_">Point</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    string path;</span><br><span class="line">    <span class="type">char</span> mp[<span class="number">15</span>][<span class="number">13</span>]=&#123;<span class="number">0</span>&#125;;<span class="comment">//标记路线</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> w1[<span class="number">4</span>] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">-1</span>&#125;;</span><br><span class="line"><span class="type">char</span> w2[<span class="number">4</span>] = &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">-1</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">char</span> pa[<span class="number">5</span>] = <span class="string">&quot;sdwa&quot;</span>;</span><br><span class="line">queue&lt;Point&gt;q;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">   Point first = &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line">   first.mp[first.y][first.x]=<span class="number">1</span>;</span><br><span class="line">   q.<span class="built_in">push</span>(first);</span><br><span class="line">   <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())</span><br><span class="line">   &#123;</span><br><span class="line">       Point now = q.<span class="built_in">front</span>();</span><br><span class="line">       q.<span class="built_in">pop</span>();</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">       &#123;</span><br><span class="line">        Point temp = now;</span><br><span class="line">        temp.x+=w1[i];</span><br><span class="line">        temp.y+=w2[i];</span><br><span class="line">        temp.path+=pa[i];</span><br><span class="line">        <span class="keyword">if</span>(map[temp.y][temp.x]==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout&lt;&lt;temp.path&lt;&lt;endl;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="keyword">if</span>(map[temp.y][temp.x]==<span class="number">0</span>&amp;&amp;temp.x&gt;=<span class="number">0</span>&amp;&amp;temp.x&lt;<span class="number">13</span>&amp;&amp;temp.y&gt;=<span class="number">0</span>&amp;&amp;temp.y&lt;<span class="number">15</span>&amp;&amp;temp.mp[temp.y][temp.x]==<span class="number">0</span>)</span><br><span class="line">         &#123;     </span><br><span class="line">            temp.mp[temp.y][temp.x]=<span class="number">1</span>;</span><br><span class="line">            q.<span class="built_in">push</span>(temp);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<!-- more -->

<h2 id="Frida环境搭建与测试："><a href="#Frida环境搭建与测试：" class="headerlink" title="Frida环境搭建与测试："></a>Frida环境搭建与测试：</h2><p>进入开发者模式，与手机进行连接<code>adb connect 127.0.0.1:62001</code>（PC端命令行）</p>
<p>查看是否连接成功 <code>adb devices</code></p>
<p>frida-server处理器类型与Android处理器对齐</p>
<p>查询虚拟机处理器架构: <code>adb shell getprop ro.product.cpu.abi</code> </p>
<p>进入frida移动端目录 <code>adb shell</code></p>
<p> <code>cd /data/local/tmp</code></p>
<p>运行 <code>./frida-server</code></p>
<p>执行 <code>frida -U -f MyApplication</code> 进行连接\</p>
<p>显示找不到MyApplication,查询app名称的id <code>frida-ps -U -a</code></p>
<p>结果:</p>
<p><img src="https://s2.loli.net/2024/06/22/URIjbw4sLCHTS8Q.png" alt="image-20231022105344293"></p>
<p>再次执行 <code>frida -U -f com.example.myapplication</code></p>
<p>连接成功,脚本测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*****[frida hook]***** : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*****[frida hook]***** : &quot;</span> + <span class="built_in">str</span>(message))</span><br><span class="line"> </span><br><span class="line"><span class="comment">#js脚本</span></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Java.perform(function () &#123;</span></span><br><span class="line"><span class="string">    var MainActivity = Java.use(&#x27;com.example.myapplication.MainActivity&#x27;);</span></span><br><span class="line"><span class="string">    MainActivity.print.implementation  = function()&#123;</span></span><br><span class="line"><span class="string">        send(&quot;Hook Start&quot;);</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string"> &#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line">process = frida.get_usb_device().attach(<span class="string">&#x27;MyApplication&#x27;</span>)<span class="comment">#应用程序名称,和包名不一样</span></span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[*] Running CTF&#x27;</span>)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>



<h2 id="RC4解密脚本："><a href="#RC4解密脚本：" class="headerlink" title="RC4解密脚本："></a>RC4解密脚本：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_setup</span>(<span class="params">key</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">        key = key.encode()</span><br><span class="line"></span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> S</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_crypt</span>(<span class="params">data, key</span>):<span class="comment">#文本解密</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">        data = data.encode()</span><br><span class="line"></span><br><span class="line">    S = rc4_setup(key)</span><br><span class="line">    i, j = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        res.append(byte ^ S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(res)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_decrypt</span>(<span class="params">key_hex, data_hex</span>):<span class="comment">#十六进制解密</span></span><br><span class="line">    key = <span class="built_in">bytes</span>.fromhex(key_hex)</span><br><span class="line">    data = <span class="built_in">bytes</span>.fromhex(data_hex)</span><br><span class="line">    res = rc4_crypt(data, key)</span><br><span class="line">    <span class="keyword">return</span> res.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    enc = <span class="string">b&#x27;FUZAza8WP5FERi17FvdHowYFSNs6cOk1h0tQLSqk&#x27;</span></span><br><span class="line">    key = <span class="string">b&#x27;BirkenwaldCTF&#123;This_is_f4ke_f1ag&#125;&#x27;</span></span><br><span class="line">    enc = base64.b64decode(enc)</span><br><span class="line">    enc = rc4_decrypt(key.<span class="built_in">hex</span>(),enc.<span class="built_in">hex</span>())</span><br><span class="line">    enc = long_to_bytes(<span class="built_in">int</span>(enc,<span class="number">16</span>)).decode()</span><br><span class="line">    <span class="built_in">print</span>(enc)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>&amp;0xff在python中可以表示取无符号整数，0xff表示八个比特1，也就是数byte数进行无符号运算,&amp;0x7f表示取有符号字节类型</p>
</blockquote>
<h2 id="RC4的c语言加密脚本："><a href="#RC4的c语言加密脚本：" class="headerlink" title="RC4的c语言加密脚本："></a>RC4的c语言加密脚本：</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> data[<span class="number">26</span>] = &#123; <span class="number">0x4e</span>,<span class="number">0xd5</span>,<span class="number">0xc</span>,<span class="number">0xed</span>,<span class="number">0x4d</span>,<span class="number">0xbf</span>,<span class="number">0x9e</span>,<span class="number">0xe8</span>,<span class="number">0x43</span>,<span class="number">0x50</span>,<span class="number">0x8</span>,<span class="number">0xd0</span>,<span class="number">0xa0</span>,<span class="number">0xe2</span>,<span class="number">0x4b</span>,<span class="number">0x62</span>,<span class="number">0xbe</span>,<span class="number">0xab</span>,<span class="number">0x0</span>,<span class="number">0x22</span>,<span class="number">0xb3</span>,<span class="number">0xd8</span>,<span class="number">0x68</span>,<span class="number">0x3f</span>,<span class="number">0x80</span>,<span class="number">0xa4</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 S 表，根据密钥打乱 S 表</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* S, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* key, <span class="type">int</span> keylen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        S[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        j = (j + S[i] + key[i % keylen]) % <span class="number">256</span>;</span><br><span class="line">        <span class="comment">// 交换 S[i] 和 S[j]</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> temp = S[i];</span><br><span class="line">        S[i] = S[j];</span><br><span class="line">        S[j] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成一个字节的密钥流</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> <span class="title">generate</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* S, <span class="type">int</span>* i, <span class="type">int</span>* j)</span> </span>&#123;</span><br><span class="line">    *i = (*i + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">    *j = (*j + S[*i]) % <span class="number">256</span>;</span><br><span class="line">    <span class="comment">// 交换 S[i] 和 S[j]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp = S[*i];</span><br><span class="line">    S[*i] = S[*j];</span><br><span class="line">    S[*j] = temp;</span><br><span class="line">    <span class="comment">// 返回 S[S[i] + S[j]]</span></span><br><span class="line">    <span class="keyword">return</span> S[(S[*i] + S[*j]) % <span class="number">256</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对数据进行加密或解密</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">encrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">int</span> datalen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* key, <span class="type">int</span> keylen)</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> S[<span class="number">256</span>]; <span class="comment">// 256 字节的数据表</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; <span class="comment">// 两个索引变量</span></span><br><span class="line">    <span class="comment">// 初始化 S 表</span></span><br><span class="line">    <span class="built_in">init</span>(S, key, keylen);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; datalen; k++) &#123;</span><br><span class="line">        <span class="comment">// 数据和密钥流进行异或运算</span></span><br><span class="line">        data[k] ^= <span class="built_in">generate</span>(S, &amp;i, &amp;j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试函数</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 假设这是要加密或解密的数据</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> input[<span class="number">26</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Do you know flag?\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please tell me:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, input);</span><br><span class="line">    <span class="comment">//unsigned char data[] = &quot;CynopsCTF&#123;RC4_1s_4w3s0m3!&#125;&quot;;</span></span><br><span class="line">    <span class="type">int</span> datalen = <span class="number">26</span>;</span><br><span class="line">    <span class="comment">// 假设这是加密或解密的密钥</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> key[] = <span class="string">&quot;CynopsCTF&#123;This_is_f4ke_f1ag&#125;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> keylen = <span class="built_in">strlen</span>((<span class="type">char</span>*)key);</span><br><span class="line">    <span class="comment">// 对数据进行加密</span></span><br><span class="line">    <span class="built_in">encrypt</span>(input, datalen, key, keylen);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (input[i] != data[i])</span><br><span class="line">            <span class="keyword">goto</span> label;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;re so smart. This&#x27;s what I want!!!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">label:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Oh,You don&#x27;t seem to know what I want\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please leave here\n&quot;</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="AES加解密C脚本"><a href="#AES加解密C脚本" class="headerlink" title="AES加解密C脚本"></a>AES加解密C脚本</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aes.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * S盒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> S[<span class="number">16</span>][<span class="number">16</span>] = &#123; <span class="number">0x63</span>, <span class="number">0x7c</span>, <span class="number">0x77</span>, <span class="number">0x7b</span>, <span class="number">0xf2</span>, <span class="number">0x6b</span>, <span class="number">0x6f</span>, <span class="number">0xc5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2b</span>, <span class="number">0xfe</span>, <span class="number">0xd7</span>, <span class="number">0xab</span>, <span class="number">0x76</span>,</span><br><span class="line">    <span class="number">0xca</span>, <span class="number">0x82</span>, <span class="number">0xc9</span>, <span class="number">0x7d</span>, <span class="number">0xfa</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xf0</span>, <span class="number">0xad</span>, <span class="number">0xd4</span>, <span class="number">0xa2</span>, <span class="number">0xaf</span>, <span class="number">0x9c</span>, <span class="number">0xa4</span>, <span class="number">0x72</span>, <span class="number">0xc0</span>,</span><br><span class="line">    <span class="number">0xb7</span>, <span class="number">0xfd</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3f</span>, <span class="number">0xf7</span>, <span class="number">0xcc</span>, <span class="number">0x34</span>, <span class="number">0xa5</span>, <span class="number">0xe5</span>, <span class="number">0xf1</span>, <span class="number">0x71</span>, <span class="number">0xd8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>,</span><br><span class="line">    <span class="number">0x04</span>, <span class="number">0xc7</span>, <span class="number">0x23</span>, <span class="number">0xc3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9a</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xe2</span>, <span class="number">0xeb</span>, <span class="number">0x27</span>, <span class="number">0xb2</span>, <span class="number">0x75</span>,</span><br><span class="line">    <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2c</span>, <span class="number">0x1a</span>, <span class="number">0x1b</span>, <span class="number">0x6e</span>, <span class="number">0x5a</span>, <span class="number">0xa0</span>, <span class="number">0x52</span>, <span class="number">0x3b</span>, <span class="number">0xd6</span>, <span class="number">0xb3</span>, <span class="number">0x29</span>, <span class="number">0xe3</span>, <span class="number">0x2f</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0xd1</span>, <span class="number">0x00</span>, <span class="number">0xed</span>, <span class="number">0x20</span>, <span class="number">0xfc</span>, <span class="number">0xb1</span>, <span class="number">0x5b</span>, <span class="number">0x6a</span>, <span class="number">0xcb</span>, <span class="number">0xbe</span>, <span class="number">0x39</span>, <span class="number">0x4a</span>, <span class="number">0x4c</span>, <span class="number">0x58</span>, <span class="number">0xcf</span>,</span><br><span class="line">    <span class="number">0xd0</span>, <span class="number">0xef</span>, <span class="number">0xaa</span>, <span class="number">0xfb</span>, <span class="number">0x43</span>, <span class="number">0x4d</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xf9</span>, <span class="number">0x02</span>, <span class="number">0x7f</span>, <span class="number">0x50</span>, <span class="number">0x3c</span>, <span class="number">0x9f</span>, <span class="number">0xa8</span>,</span><br><span class="line">    <span class="number">0x51</span>, <span class="number">0xa3</span>, <span class="number">0x40</span>, <span class="number">0x8f</span>, <span class="number">0x92</span>, <span class="number">0x9d</span>, <span class="number">0x38</span>, <span class="number">0xf5</span>, <span class="number">0xbc</span>, <span class="number">0xb6</span>, <span class="number">0xda</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xff</span>, <span class="number">0xf3</span>, <span class="number">0xd2</span>,</span><br><span class="line">    <span class="number">0xcd</span>, <span class="number">0x0c</span>, <span class="number">0x13</span>, <span class="number">0xec</span>, <span class="number">0x5f</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xc4</span>, <span class="number">0xa7</span>, <span class="number">0x7e</span>, <span class="number">0x3d</span>, <span class="number">0x64</span>, <span class="number">0x5d</span>, <span class="number">0x19</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4f</span>, <span class="number">0xdc</span>, <span class="number">0x22</span>, <span class="number">0x2a</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xee</span>, <span class="number">0xb8</span>, <span class="number">0x14</span>, <span class="number">0xde</span>, <span class="number">0x5e</span>, <span class="number">0x0b</span>, <span class="number">0xdb</span>,</span><br><span class="line">    <span class="number">0xe0</span>, <span class="number">0x32</span>, <span class="number">0x3a</span>, <span class="number">0x0a</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5c</span>, <span class="number">0xc2</span>, <span class="number">0xd3</span>, <span class="number">0xac</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xe4</span>, <span class="number">0x79</span>,</span><br><span class="line">    <span class="number">0xe7</span>, <span class="number">0xc8</span>, <span class="number">0x37</span>, <span class="number">0x6d</span>, <span class="number">0x8d</span>, <span class="number">0xd5</span>, <span class="number">0x4e</span>, <span class="number">0xa9</span>, <span class="number">0x6c</span>, <span class="number">0x56</span>, <span class="number">0xf4</span>, <span class="number">0xea</span>, <span class="number">0x65</span>, <span class="number">0x7a</span>, <span class="number">0xae</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0xba</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2e</span>, <span class="number">0x1c</span>, <span class="number">0xa6</span>, <span class="number">0xb4</span>, <span class="number">0xc6</span>, <span class="number">0xe8</span>, <span class="number">0xdd</span>, <span class="number">0x74</span>, <span class="number">0x1f</span>, <span class="number">0x4b</span>, <span class="number">0xbd</span>, <span class="number">0x8b</span>, <span class="number">0x8a</span>,</span><br><span class="line">    <span class="number">0x70</span>, <span class="number">0x3e</span>, <span class="number">0xb5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xf6</span>, <span class="number">0x0e</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xb9</span>, <span class="number">0x86</span>, <span class="number">0xc1</span>, <span class="number">0x1d</span>, <span class="number">0x9e</span>,</span><br><span class="line">    <span class="number">0xe1</span>, <span class="number">0xf8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xd9</span>, <span class="number">0x8e</span>, <span class="number">0x94</span>, <span class="number">0x9b</span>, <span class="number">0x1e</span>, <span class="number">0x87</span>, <span class="number">0xe9</span>, <span class="number">0xce</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xdf</span>,</span><br><span class="line">    <span class="number">0x8c</span>, <span class="number">0xa1</span>, <span class="number">0x89</span>, <span class="number">0x0d</span>, <span class="number">0xbf</span>, <span class="number">0xe6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2d</span>, <span class="number">0x0f</span>, <span class="number">0xb0</span>, <span class="number">0x54</span>, <span class="number">0xbb</span>, <span class="number">0x16</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逆S盒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> S2[<span class="number">16</span>][<span class="number">16</span>] = &#123; <span class="number">0x52</span>, <span class="number">0x09</span>, <span class="number">0x6a</span>, <span class="number">0xd5</span>, <span class="number">0x30</span>, <span class="number">0x36</span>, <span class="number">0xa5</span>, <span class="number">0x38</span>, <span class="number">0xbf</span>, <span class="number">0x40</span>, <span class="number">0xa3</span>, <span class="number">0x9e</span>, <span class="number">0x81</span>, <span class="number">0xf3</span>, <span class="number">0xd7</span>, <span class="number">0xfb</span>,</span><br><span class="line">    <span class="number">0x7c</span>, <span class="number">0xe3</span>, <span class="number">0x39</span>, <span class="number">0x82</span>, <span class="number">0x9b</span>, <span class="number">0x2f</span>, <span class="number">0xff</span>, <span class="number">0x87</span>, <span class="number">0x34</span>, <span class="number">0x8e</span>, <span class="number">0x43</span>, <span class="number">0x44</span>, <span class="number">0xc4</span>, <span class="number">0xde</span>, <span class="number">0xe9</span>, <span class="number">0xcb</span>,</span><br><span class="line">    <span class="number">0x54</span>, <span class="number">0x7b</span>, <span class="number">0x94</span>, <span class="number">0x32</span>, <span class="number">0xa6</span>, <span class="number">0xc2</span>, <span class="number">0x23</span>, <span class="number">0x3d</span>, <span class="number">0xee</span>, <span class="number">0x4c</span>, <span class="number">0x95</span>, <span class="number">0x0b</span>, <span class="number">0x42</span>, <span class="number">0xfa</span>, <span class="number">0xc3</span>, <span class="number">0x4e</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x2e</span>, <span class="number">0xa1</span>, <span class="number">0x66</span>, <span class="number">0x28</span>, <span class="number">0xd9</span>, <span class="number">0x24</span>, <span class="number">0xb2</span>, <span class="number">0x76</span>, <span class="number">0x5b</span>, <span class="number">0xa2</span>, <span class="number">0x49</span>, <span class="number">0x6d</span>, <span class="number">0x8b</span>, <span class="number">0xd1</span>, <span class="number">0x25</span>,</span><br><span class="line">    <span class="number">0x72</span>, <span class="number">0xf8</span>, <span class="number">0xf6</span>, <span class="number">0x64</span>, <span class="number">0x86</span>, <span class="number">0x68</span>, <span class="number">0x98</span>, <span class="number">0x16</span>, <span class="number">0xd4</span>, <span class="number">0xa4</span>, <span class="number">0x5c</span>, <span class="number">0xcc</span>, <span class="number">0x5d</span>, <span class="number">0x65</span>, <span class="number">0xb6</span>, <span class="number">0x92</span>,</span><br><span class="line">    <span class="number">0x6c</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x50</span>, <span class="number">0xfd</span>, <span class="number">0xed</span>, <span class="number">0xb9</span>, <span class="number">0xda</span>, <span class="number">0x5e</span>, <span class="number">0x15</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0xa7</span>, <span class="number">0x8d</span>, <span class="number">0x9d</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0xd8</span>, <span class="number">0xab</span>, <span class="number">0x00</span>, <span class="number">0x8c</span>, <span class="number">0xbc</span>, <span class="number">0xd3</span>, <span class="number">0x0a</span>, <span class="number">0xf7</span>, <span class="number">0xe4</span>, <span class="number">0x58</span>, <span class="number">0x05</span>, <span class="number">0xb8</span>, <span class="number">0xb3</span>, <span class="number">0x45</span>, <span class="number">0x06</span>,</span><br><span class="line">    <span class="number">0xd0</span>, <span class="number">0x2c</span>, <span class="number">0x1e</span>, <span class="number">0x8f</span>, <span class="number">0xca</span>, <span class="number">0x3f</span>, <span class="number">0x0f</span>, <span class="number">0x02</span>, <span class="number">0xc1</span>, <span class="number">0xaf</span>, <span class="number">0xbd</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x13</span>, <span class="number">0x8a</span>, <span class="number">0x6b</span>,</span><br><span class="line">    <span class="number">0x3a</span>, <span class="number">0x91</span>, <span class="number">0x11</span>, <span class="number">0x41</span>, <span class="number">0x4f</span>, <span class="number">0x67</span>, <span class="number">0xdc</span>, <span class="number">0xea</span>, <span class="number">0x97</span>, <span class="number">0xf2</span>, <span class="number">0xcf</span>, <span class="number">0xce</span>, <span class="number">0xf0</span>, <span class="number">0xb4</span>, <span class="number">0xe6</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x96</span>, <span class="number">0xac</span>, <span class="number">0x74</span>, <span class="number">0x22</span>, <span class="number">0xe7</span>, <span class="number">0xad</span>, <span class="number">0x35</span>, <span class="number">0x85</span>, <span class="number">0xe2</span>, <span class="number">0xf9</span>, <span class="number">0x37</span>, <span class="number">0xe8</span>, <span class="number">0x1c</span>, <span class="number">0x75</span>, <span class="number">0xdf</span>, <span class="number">0x6e</span>,</span><br><span class="line">    <span class="number">0x47</span>, <span class="number">0xf1</span>, <span class="number">0x1a</span>, <span class="number">0x71</span>, <span class="number">0x1d</span>, <span class="number">0x29</span>, <span class="number">0xc5</span>, <span class="number">0x89</span>, <span class="number">0x6f</span>, <span class="number">0xb7</span>, <span class="number">0x62</span>, <span class="number">0x0e</span>, <span class="number">0xaa</span>, <span class="number">0x18</span>, <span class="number">0xbe</span>, <span class="number">0x1b</span>,</span><br><span class="line">    <span class="number">0xfc</span>, <span class="number">0x56</span>, <span class="number">0x3e</span>, <span class="number">0x4b</span>, <span class="number">0xc6</span>, <span class="number">0xd2</span>, <span class="number">0x79</span>, <span class="number">0x20</span>, <span class="number">0x9a</span>, <span class="number">0xdb</span>, <span class="number">0xc0</span>, <span class="number">0xfe</span>, <span class="number">0x78</span>, <span class="number">0xcd</span>, <span class="number">0x5a</span>, <span class="number">0xf4</span>,</span><br><span class="line">    <span class="number">0x1f</span>, <span class="number">0xdd</span>, <span class="number">0xa8</span>, <span class="number">0x33</span>, <span class="number">0x88</span>, <span class="number">0x07</span>, <span class="number">0xc7</span>, <span class="number">0x31</span>, <span class="number">0xb1</span>, <span class="number">0x12</span>, <span class="number">0x10</span>, <span class="number">0x59</span>, <span class="number">0x27</span>, <span class="number">0x80</span>, <span class="number">0xec</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x7f</span>, <span class="number">0xa9</span>, <span class="number">0x19</span>, <span class="number">0xb5</span>, <span class="number">0x4a</span>, <span class="number">0x0d</span>, <span class="number">0x2d</span>, <span class="number">0xe5</span>, <span class="number">0x7a</span>, <span class="number">0x9f</span>, <span class="number">0x93</span>, <span class="number">0xc9</span>, <span class="number">0x9c</span>, <span class="number">0xef</span>,</span><br><span class="line">    <span class="number">0xa0</span>, <span class="number">0xe0</span>, <span class="number">0x3b</span>, <span class="number">0x4d</span>, <span class="number">0xae</span>, <span class="number">0x2a</span>, <span class="number">0xf5</span>, <span class="number">0xb0</span>, <span class="number">0xc8</span>, <span class="number">0xeb</span>, <span class="number">0xbb</span>, <span class="number">0x3c</span>, <span class="number">0x83</span>, <span class="number">0x53</span>, <span class="number">0x99</span>, <span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0x17</span>, <span class="number">0x2b</span>, <span class="number">0x04</span>, <span class="number">0x7e</span>, <span class="number">0xba</span>, <span class="number">0x77</span>, <span class="number">0xd6</span>, <span class="number">0x26</span>, <span class="number">0xe1</span>, <span class="number">0x69</span>, <span class="number">0x14</span>, <span class="number">0x63</span>, <span class="number">0x55</span>, <span class="number">0x21</span>, <span class="number">0x0c</span>, <span class="number">0x7d</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取整形数据的低8位的左4个位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getLeft4Bit</span><span class="params">(<span class="type">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> left = num &amp; <span class="number">0x000000f0</span>;</span><br><span class="line">    <span class="keyword">return</span> left &gt;&gt; <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取整形数据的低8位的右4个位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getRight4Bit</span><span class="params">(<span class="type">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num &amp; <span class="number">0x0000000f</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据索引，从S盒中获得元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getNumFromSBox</span><span class="params">(<span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> row = <span class="built_in">getLeft4Bit</span>(index);</span><br><span class="line">    <span class="type">int</span> col = <span class="built_in">getRight4Bit</span>(index);</span><br><span class="line">    <span class="keyword">return</span> S[row][col];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把一个字符转变成整型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getIntFromChar</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> result = (<span class="type">int</span>)c;</span><br><span class="line">    <span class="keyword">return</span> result &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把16个字符转变成4X4的数组，</span></span><br><span class="line"><span class="comment"> * 该矩阵中字节的排列顺序为从上到下，</span></span><br><span class="line"><span class="comment"> * 从左到右依次排列。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">convertToIntArray</span><span class="params">(<span class="type">char</span>* str, <span class="type">int</span> pa[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> k = <span class="number">0</span>, i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            pa[j][i] = <span class="built_in">getIntFromChar</span>(str[k]);</span><br><span class="line">            k++;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打印4X4的数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">printArray</span><span class="params">(<span class="type">int</span> a[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;a[%d][%d] = 0x%x &quot;</span>, i, j, a[i][j]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打印字符串的ASSCI，</span></span><br><span class="line"><span class="comment"> * 以十六进制显示。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">printASSCI</span><span class="params">(<span class="type">char</span>* str, <span class="type">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%x &quot;</span>, <span class="built_in">getIntFromChar</span>(str[i]));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把连续的4个字符合并成一个4字节的整型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getWordFromStr</span><span class="params">(<span class="type">char</span>* str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> one = <span class="built_in">getIntFromChar</span>(str[<span class="number">0</span>]);</span><br><span class="line">    one = one &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    <span class="type">int</span> two = <span class="built_in">getIntFromChar</span>(str[<span class="number">1</span>]);</span><br><span class="line">    two = two &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    <span class="type">int</span> three = <span class="built_in">getIntFromChar</span>(str[<span class="number">2</span>]);</span><br><span class="line">    three = three &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    <span class="type">int</span> four = <span class="built_in">getIntFromChar</span>(str[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">return</span> one | two | three | four;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把一个4字节的数的第一、二、三、四个字节取出，</span></span><br><span class="line"><span class="comment"> * 入进一个4个元素的整型数组里面。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">splitIntToArray</span><span class="params">(<span class="type">int</span> num, <span class="type">int</span> array[<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> one = num &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    array[<span class="number">0</span>] = one &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">    <span class="type">int</span> two = num &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    array[<span class="number">1</span>] = two &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">    <span class="type">int</span> three = num &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    array[<span class="number">2</span>] = three &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">    array[<span class="number">3</span>] = num &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将数组中的元素循环左移step位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">leftLoop4int</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>], <span class="type">int</span> step)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> temp[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        temp[i] = array[i];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index = step % <span class="number">4</span> == <span class="number">0</span> ? <span class="number">0</span> : step % <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        array[i] = temp[index];</span><br><span class="line">        index++;</span><br><span class="line">        index = index % <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把数组中的第一、二、三和四元素分别作为</span></span><br><span class="line"><span class="comment"> * 4字节整型的第一、二、三和四字节，合并成一个4字节整型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">mergeArrayToInt</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> one = array[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    <span class="type">int</span> two = array[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    <span class="type">int</span> three = array[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    <span class="type">int</span> four = array[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">return</span> one | two | three | four;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 常量轮值表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> Rcon[<span class="number">10</span>] = &#123; <span class="number">0x01000000</span>, <span class="number">0x02000000</span>,</span><br><span class="line">    <span class="number">0x04000000</span>, <span class="number">0x08000000</span>,</span><br><span class="line">    <span class="number">0x10000000</span>, <span class="number">0x20000000</span>,</span><br><span class="line">    <span class="number">0x40000000</span>, <span class="number">0x80000000</span>,</span><br><span class="line">    <span class="number">0x1b000000</span>, <span class="number">0x36000000</span> &#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 密钥扩展中的T函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">T</span><span class="params">(<span class="type">int</span> num, <span class="type">int</span> round)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> numArray[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">splitIntToArray</span>(num, numArray);</span><br><span class="line">    <span class="built_in">leftLoop4int</span>(numArray, <span class="number">1</span>);<span class="comment">//字循环</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//字节代换</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        numArray[i] = <span class="built_in">getNumFromSBox</span>(numArray[i]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result = <span class="built_in">mergeArrayToInt</span>(numArray);</span><br><span class="line">    <span class="keyword">return</span> result ^ Rcon[round];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密钥对应的扩展数组</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> w[<span class="number">44</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展密钥，结果是把w[44]中的每个元素初始化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">extendKey</span><span class="params">(<span class="type">char</span>* key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>  i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        w[i] = <span class="built_in">getWordFromStr</span>(key + i * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">4</span>, j = <span class="number">0</span>; i &lt; <span class="number">44</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            w[i] = w[i - <span class="number">4</span>] ^ <span class="built_in">T</span>(w[i - <span class="number">1</span>], j);</span><br><span class="line">            j++;<span class="comment">//下一轮</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            w[i] = w[i - <span class="number">4</span>] ^ w[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 轮密钥加</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">addRoundKey</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>], <span class="type">int</span> round)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> warray[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">splitIntToArray</span>(w[round * <span class="number">4</span> + i], warray);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            array[j][i] = array[j][i] ^ warray[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字节代换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">subBytes</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            array[i][j] = <span class="built_in">getNumFromSBox</span>(array[i][j]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 行移位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">shiftRows</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> rowTwo[<span class="number">4</span>], rowThree[<span class="number">4</span>], rowFour[<span class="number">4</span>];</span><br><span class="line">    <span class="comment">//复制状态矩阵的第2,3,4行</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        rowTwo[i] = array[<span class="number">1</span>][i];</span><br><span class="line">        rowThree[i] = array[<span class="number">2</span>][i];</span><br><span class="line">        rowFour[i] = array[<span class="number">3</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//循环左移相应的位数</span></span><br><span class="line">    <span class="built_in">leftLoop4int</span>(rowTwo, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">leftLoop4int</span>(rowThree, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">leftLoop4int</span>(rowFour, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把左移后的行复制回状态矩阵中</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        array[<span class="number">1</span>][i] = rowTwo[i];</span><br><span class="line">        array[<span class="number">2</span>][i] = rowThree[i];</span><br><span class="line">        array[<span class="number">3</span>][i] = rowFour[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列混合要用到的矩阵</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> colM[<span class="number">4</span>][<span class="number">4</span>] = &#123; <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line">    <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul2</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> result = s &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> a7 = result &amp; <span class="number">0x00000100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a7 != <span class="number">0</span>) &#123;</span><br><span class="line">        result = result &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">        result = result ^ <span class="number">0x1b</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul3</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul2</span>(s) ^ s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul4</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul2</span>(<span class="built_in">GFMul2</span>(s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul8</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul2</span>(<span class="built_in">GFMul4</span>(s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul9</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul8</span>(s) ^ s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul11</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul9</span>(s) ^ <span class="built_in">GFMul2</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul12</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul8</span>(s) ^ <span class="built_in">GFMul4</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul13</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul12</span>(s) ^ s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul14</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GFMul12</span>(s) ^ <span class="built_in">GFMul2</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GF上的二元运算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GFMul</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>)</span><br><span class="line">        result = s;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">2</span>)</span><br><span class="line">        result = <span class="built_in">GFMul2</span>(s);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">3</span>)</span><br><span class="line">        result = <span class="built_in">GFMul3</span>(s);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0x9</span>)</span><br><span class="line">        result = <span class="built_in">GFMul9</span>(s);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0xb</span>)<span class="comment">//11</span></span><br><span class="line">        result = <span class="built_in">GFMul11</span>(s);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0xd</span>)<span class="comment">//13</span></span><br><span class="line">        result = <span class="built_in">GFMul13</span>(s);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0xe</span>)<span class="comment">//14</span></span><br><span class="line">        result = <span class="built_in">GFMul14</span>(s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列混合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">mixColumns</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> tempArray[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            tempArray[i][j] = array[i][j];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            array[i][j] = <span class="built_in">GFMul</span>(colM[i][<span class="number">0</span>], tempArray[<span class="number">0</span>][j]) ^ <span class="built_in">GFMul</span>(colM[i][<span class="number">1</span>], tempArray[<span class="number">1</span>][j])</span><br><span class="line">                ^ <span class="built_in">GFMul</span>(colM[i][<span class="number">2</span>], tempArray[<span class="number">2</span>][j]) ^ <span class="built_in">GFMul</span>(colM[i][<span class="number">3</span>], tempArray[<span class="number">3</span>][j]);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把4X4数组转回字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">convertArrayToStr</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>], <span class="type">char</span>* str)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            *str++ = (<span class="type">char</span>)array[j][i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查密钥长度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">checkKeyLen</span><span class="params">(<span class="type">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数 p: 明文的字符串数组。</span></span><br><span class="line"><span class="comment"> * 参数 plen: 明文的长度。</span></span><br><span class="line"><span class="comment"> * 参数 key: 密钥的字符串数组。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">aes</span><span class="params">(<span class="type">char</span>* p, <span class="type">int</span> plen, <span class="type">char</span>* key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> keylen = <span class="built_in">strlen</span>(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">checkKeyLen</span>(keylen)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;keylen erro;keylen=%d\n&quot;</span>, keylen);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">extendKey</span>(key);<span class="comment">//扩展密钥</span></span><br><span class="line">    <span class="type">int</span> pArray[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i, k;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; plen; k += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">convertToIntArray</span>(p + k, pArray);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">addRoundKey</span>(pArray, <span class="number">0</span>);<span class="comment">//一开始的轮密钥加</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">10</span>; i++) &#123;<span class="comment">//前9轮</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">subBytes</span>(pArray);<span class="comment">//字节代换</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">shiftRows</span>(pArray);<span class="comment">//行移位</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">mixColumns</span>(pArray);<span class="comment">//列混合</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">addRoundKey</span>(pArray, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//第10轮</span></span><br><span class="line">        <span class="built_in">subBytes</span>(pArray);<span class="comment">//字节代换</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">shiftRows</span>(pArray);<span class="comment">//行移位</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">addRoundKey</span>(pArray, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">convertArrayToStr</span>(pArray, p + k);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据索引从逆S盒中获取值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getNumFromS1Box</span><span class="params">(<span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> row = <span class="built_in">getLeft4Bit</span>(index);</span><br><span class="line">    <span class="type">int</span> col = <span class="built_in">getRight4Bit</span>(index);</span><br><span class="line">    <span class="keyword">return</span> S2[row][col];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逆字节变换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">deSubBytes</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            array[i][j] = <span class="built_in">getNumFromS1Box</span>(array[i][j]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把4个元素的数组循环右移step位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">rightLoop4int</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>], <span class="type">int</span> step)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> temp[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        temp[i] = array[i];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index = step % <span class="number">4</span> == <span class="number">0</span> ? <span class="number">0</span> : step % <span class="number">4</span>;</span><br><span class="line">    index = <span class="number">3</span> - index;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        array[i] = temp[index];</span><br><span class="line">        index--;</span><br><span class="line">        index = index == <span class="number">-1</span> ? <span class="number">3</span> : index;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逆行移位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">deShiftRows</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> rowTwo[<span class="number">4</span>], rowThree[<span class="number">4</span>], rowFour[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        rowTwo[i] = array[<span class="number">1</span>][i];</span><br><span class="line">        rowThree[i] = array[<span class="number">2</span>][i];</span><br><span class="line">        rowFour[i] = array[<span class="number">3</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rightLoop4int</span>(rowTwo, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">rightLoop4int</span>(rowThree, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">rightLoop4int</span>(rowFour, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        array[<span class="number">1</span>][i] = rowTwo[i];</span><br><span class="line">        array[<span class="number">2</span>][i] = rowThree[i];</span><br><span class="line">        array[<span class="number">3</span>][i] = rowFour[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逆列混合用到的矩阵</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> deColM[<span class="number">4</span>][<span class="number">4</span>] = &#123; <span class="number">0xe</span>, <span class="number">0xb</span>, <span class="number">0xd</span>, <span class="number">0x9</span>,</span><br><span class="line">    <span class="number">0x9</span>, <span class="number">0xe</span>, <span class="number">0xb</span>, <span class="number">0xd</span>,</span><br><span class="line">    <span class="number">0xd</span>, <span class="number">0x9</span>, <span class="number">0xe</span>, <span class="number">0xb</span>,</span><br><span class="line">    <span class="number">0xb</span>, <span class="number">0xd</span>, <span class="number">0x9</span>, <span class="number">0xe</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逆列混合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">deMixColumns</span><span class="params">(<span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> tempArray[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            tempArray[i][j] = array[i][j];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            array[i][j] = <span class="built_in">GFMul</span>(deColM[i][<span class="number">0</span>], tempArray[<span class="number">0</span>][j]) ^ <span class="built_in">GFMul</span>(deColM[i][<span class="number">1</span>], tempArray[<span class="number">1</span>][j])</span><br><span class="line">                ^ <span class="built_in">GFMul</span>(deColM[i][<span class="number">2</span>], tempArray[<span class="number">2</span>][j]) ^ <span class="built_in">GFMul</span>(deColM[i][<span class="number">3</span>], tempArray[<span class="number">3</span>][j]);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 把两个4X4数组进行异或</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">addRoundTowArray</span><span class="params">(<span class="type">int</span> aArray[<span class="number">4</span>][<span class="number">4</span>], <span class="type">int</span> bArray[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">            aArray[i][j] = aArray[i][j] ^ bArray[i][j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从4个32位的密钥字中获得4X4数组，</span></span><br><span class="line"><span class="comment"> * 用于进行逆列混合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">getArrayFrom4W</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> array[<span class="number">4</span>][<span class="number">4</span>])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> index = i * <span class="number">4</span>;</span><br><span class="line">    <span class="type">int</span> colOne[<span class="number">4</span>], colTwo[<span class="number">4</span>], colThree[<span class="number">4</span>], colFour[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">splitIntToArray</span>(w[index], colOne);</span><br><span class="line">    <span class="built_in">splitIntToArray</span>(w[index + <span class="number">1</span>], colTwo);</span><br><span class="line">    <span class="built_in">splitIntToArray</span>(w[index + <span class="number">2</span>], colThree);</span><br><span class="line">    <span class="built_in">splitIntToArray</span>(w[index + <span class="number">3</span>], colFour);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        array[i][<span class="number">0</span>] = colOne[i];</span><br><span class="line">        array[i][<span class="number">1</span>] = colTwo[i];</span><br><span class="line">        array[i][<span class="number">2</span>] = colThree[i];</span><br><span class="line">        array[i][<span class="number">3</span>] = colFour[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数 c: 密文的字符串数组。</span></span><br><span class="line"><span class="comment"> * 参数 clen: 密文的长度。</span></span><br><span class="line"><span class="comment"> * 参数 key: 密钥的字符串数组。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deAes</span><span class="params">(<span class="type">char</span>* c, <span class="type">int</span> clen, <span class="type">char</span>* key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> keylen = <span class="built_in">strlen</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (clen == <span class="number">0</span> || clen % <span class="number">16</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Ciphertext characters must be a multiple of 16! Now the length is zero:%d\n&quot;</span>, clen);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">checkKeyLen</span>(keylen)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Key character length error! The lengths must be 16, 24, and 32. The current length is:%d\n&quot;</span>, keylen);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">extendKey</span>(key);<span class="comment">//扩展密钥</span></span><br><span class="line">    <span class="type">int</span> cArray[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> i, k;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; clen; k += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">convertToIntArray</span>(c + k, cArray);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">addRoundKey</span>(cArray, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> wArray[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">9</span>; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">            <span class="built_in">deSubBytes</span>(cArray);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">deShiftRows</span>(cArray);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">deMixColumns</span>(cArray);</span><br><span class="line">            <span class="built_in">getArrayFrom4W</span>(i, wArray);</span><br><span class="line">            <span class="built_in">deMixColumns</span>(wArray);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">addRoundTowArray</span>(cArray, wArray);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">deSubBytes</span>(cArray);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">deShiftRows</span>(cArray);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">addRoundKey</span>(cArray, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">convertArrayToStr</span>(cArray, c + k);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>.rodata段是用来存放只读数据的一块内存区域，例如常量数据。ro代表read only，即只读的意思。.rodata段也叫常量区，它属于静态内存分配。使用const修饰符，例如<code>const int a = 10;</code>，这样的变量会被放在.rodata段中</p>
</blockquote>
<h2 id="Ida-Python脚本"><a href="#Ida-Python脚本" class="headerlink" title="Ida Python脚本:"></a>Ida Python脚本:</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">start = <span class="number">0x00401500</span></span><br><span class="line">end  = start + <span class="number">0xBA</span></span><br><span class="line">xor = <span class="number">0x41</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start,end):</span><br><span class="line">   data = get_wide_byte(i)</span><br><span class="line">   patch_byte(i,data^xor)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; patched&quot;</span>.<span class="built_in">format</span>(i))</span><br></pre></td></tr></table></figure>

<h2 id="attribute实现main函数之前执行相应函数："><a href="#attribute实现main函数之前执行相应函数：" class="headerlink" title="attribute实现main函数之前执行相应函数："></a>attribute实现main函数之前执行相应函数：</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">before</span><span class="params">()</span> __<span class="title">attribute__</span><span class="params">((constructor))</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">after</span><span class="params">()</span> __<span class="title">attribute__</span><span class="params">((destructor))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is function %s\n&quot;</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is function %s\n&quot;</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is function %s\n&quot;</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="函数调用默认传参的几种方式"><a href="#函数调用默认传参的几种方式" class="headerlink" title="函数调用默认传参的几种方式"></a>函数调用默认传参的几种方式</h2><p>$$<br>cdecl：这是C语言默认的调用约定，它要求参数从右向左依次压入栈中，由调用者负责清理栈空间。这种方式适用于可变数量的参数，如printf函数。在Windows和Linux系统中，cdecl通常用于32位x86架构的编译器。<br>$$</p>
<p>$$<br>stdcall：这是Windows API默认的调用约定，它要求参数从右向左依次压入栈中，由被调用者负责清理栈空间。这种方式适用于固定数量的参数，如MessageBox函数。在Windows系统中，stdcall通常用于32位x86架构的编译器。<br>$$</p>
<p>$$<br>fastcall：这是一种优化的调用约定，它要求将部分参数通过寄存器传递，而不是全部压入栈中，以提高函数调用的效率。不同的编译器可能会有不同的fastcall实现，例如Microsoft Visual C++和Borland C++ Builder分别使用ECX和EDX两个寄存器传递前两个参数，而GCC则使用EAX、EDX和ECX三个寄存器传递前三个参数。在Windows和Linux系统中，fastcall通常用于32位x86架构的编译器。<br>$$</p>
<p>$$<br>thiscall：这是C++类成员函数默认的调用约定，它要求将对象指针（this指针）通过ECX寄存器传递给函数，而其他参数则从右向左依次压入栈中。由于thiscall只适用于类成员函数，因此它通常不需要显式指定。在Windows和Linux系统中，thiscall通常用于32位x86架构的编译器。<br>$$</p>
<p>$$<br>syscall：这是Linux内核默认的调用约定，它要求将系统调用号通过EAX寄存器传递给内核，而其他参数则通过EBX、ECX、EDX、ESI、EDI和EBP六个寄存器按顺序传递给内核。如果参数超过六个，则需要通过栈传递。在Linux系统中，syscall通常用于32位x86架构的编译器<br>$$</p>
<p>$$<br>在64位x86架构（x86_64或AMD64）的编译器中，通常会有更多的寄存器可供使用，因此参数传递方式也会有所不同。例如，在Windows系统中，x64调用约定要求将前四个整数或指针类型的参数通过RCX、RDX、R8和R9四个寄存器传递，而前四个浮点类型的参数通过XMM0、XMM1、XMM2和XMM3四个寄存器传递；在Linux系统中，System V AMD64 ABI要求将前六个整数或指针类型的参数通过RDI、RSI、RDX、RCX、R8和R9六个寄存器传递，而前八个浮点类型的参数通过XMM0到XMM7八个寄存器传递。<br>$$</p>
<h2 id="gbk解码转中文，先ida64-convert-to-string，再用b修饰，解码即可"><a href="#gbk解码转中文，先ida64-convert-to-string，再用b修饰，解码即可" class="headerlink" title="gbk解码转中文，先ida64 convert to string，再用b修饰，解码即可"></a>gbk解码转中文，先ida64 convert to string，再用b修饰，解码即可</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span> = <span class="string">b&quot;\xD7\xA2\xB2\xE1\xB3\xC9\xB9\xA6\xA3\xA1&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>.decode(<span class="string">&#x27;gbk&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h2 id="异常处理和反调试"><a href="#异常处理和反调试" class="headerlink" title="异常处理和反调试"></a>异常处理和反调试</h2><p>反调试的几种方式记录</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> flag[<span class="number">5</span>] = <span class="string">&quot;1234&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">change</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">strcpy_s</span>(flag, <span class="built_in">size_t</span>(<span class="number">5</span>), <span class="string">&quot;9999&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">EXCEPTION_DISPOSITION WINAPI <span class="title">myExceptHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">struct</span> _EXCEPTION_RECORD* ExceptionRecord,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID EstablisherFrame,</span></span></span><br><span class="line"><span class="params"><span class="function">    PCONTEXT pcontext,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID DisapatcherContext</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// 第五种方式，类似第四种方式</span></span><br><span class="line">    <span class="keyword">if</span> (pcontext-&gt;Dr0 != <span class="number">0</span> || pcontext-&gt;Dr1 != <span class="number">0</span> || pcontext-&gt;Dr2 != <span class="number">0</span> || pcontext-&gt;Dr3 != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;myExceptHandler检测到硬件断点\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;myExceptHandlerm没有检测到硬件断点\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pcontext-&gt;Eip += <span class="number">2</span>;<span class="comment">//跳过程序异常处，要不然程序一直在异常处不继续运行</span></span><br><span class="line">    <span class="built_in">change</span>();</span><br><span class="line">    <span class="keyword">return</span> ExceptionContinueExecution;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="comment">//第一种，会被x32dbg,OD反反调试器杀掉</span></span><br><span class="line">    BOOL flag = <span class="built_in">IsDebuggerPresent</span>();</span><br><span class="line">    <span class="keyword">if</span> (flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IsDebuggerPresent检测到调试器\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IsDebuggerPresent没有检测到调试器\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第二种，不会被x32,OD反反调试器杀掉</span></span><br><span class="line">    BOOL IsDebug = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//第一个参数是进程句柄，可以检测远程进程是否被调试</span></span><br><span class="line">    <span class="built_in">CheckRemoteDebuggerPresent</span>(<span class="built_in">GetCurrentProcess</span>(), &amp;IsDebug);</span><br><span class="line">    <span class="keyword">if</span> (IsDebug)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CheckRemoteDebuggerPresent检测到调试器\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CheckRemoteDebuggerPresent没有检测到调试器\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//第三种，不会被x32,OD反反调试器杀掉</span></span><br><span class="line">    <span class="comment">//CloseHandle函数会试图关闭指定句柄的进程，</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1 </span></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CloseHandle</span>((HANDLE)<span class="number">0x1234</span>);<span class="comment">//指定一个不存在的进程句柄</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CloseHandle没有检测到调试器\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    __except(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CloseHandle检测到调试器\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">//第四种,硬件断点反调试，只要在动调时设置硬件断点就会被发现</span></span><br><span class="line">    CONTEXT context&#123; <span class="number">0</span> &#125;;</span><br><span class="line">    context.ContextFlags = CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">    <span class="built_in">GetThreadContext</span>(<span class="built_in">GetCurrentThread</span>(),&amp;context);</span><br><span class="line">    <span class="comment">//查找寄存器的值，如果有硬件断点，该寄存器的值会改变</span></span><br><span class="line">    <span class="keyword">if</span> (context.Dr0 != <span class="number">0</span> || context.Dr1 != <span class="number">0</span> || context.Dr2 != <span class="number">0</span> || context.Dr3 != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;GetThreadContext检测到硬件断点\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;GetThreadContext没有检测到硬件断点\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">//第五种</span></span><br><span class="line">    DWORD sehHandler = (DWORD)myExceptHandler;</span><br><span class="line">    <span class="comment">//上面可能是添加一个异常处理函数，然后下面让异常处理链表SEH增加一个节点，把这个异常处理函数插进去</span></span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        push myExceptHandler<span class="comment">//fs: [0] 指向的是TIB[Thread information Block]结构中的EXCEPTION_REGISTRATION 结构</span></span><br><span class="line">        mov eax,fs:[<span class="number">0</span>]</span><br><span class="line">        push eax</span><br><span class="line">        mov fs:[<span class="number">0</span>],esp<span class="comment">//让fs:[0]指向一个新的EXCEPTION_REGISTRATION 结构(就像链表插入一个新节点)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置程序异常处</span></span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    a = a / <span class="number">0</span>;</span><br><span class="line">    std::cout &lt;&lt; flag;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="dll的编译和使用"><a href="#dll的编译和使用" class="headerlink" title="dll的编译和使用"></a>dll的编译和使用</h2><p>先编译dll文件，新建生成dll项目，创建一个新的Mydll.cpp和Mydll.h</p>
<p>Mydll.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Mydll.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a-b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">multi</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a*b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Div</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a/b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">XXOR</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a ^ b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>导出的两种方式的其中第一种方式，头文件导出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MYDLL_EXPORTS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYDLL_API __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYDLL_API __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第一种导出方式</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> MYDLL_API <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Produce the next value in the sequence.</span></span><br><span class="line"><span class="comment">// Returns true on success and updates current value and index;</span></span><br><span class="line"><span class="comment">// false on overflow, leaves current value and index unchanged.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> MYDLL_API <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the current value in the sequence.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> MYDLL_API <span class="type">int</span> <span class="title function_">multi</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the position of the current value in the sequence.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> MYDLL_API <span class="type">int</span> <span class="title function_">Div</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>;</span><br></pre></td></tr></table></figure>

<p>导出的第二种方式，源文件新建一个export.def文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LIBRARY <span class="string">&quot;Mydll&quot;</span></span><br><span class="line">EXPORTS</span><br><span class="line">XXOR @ <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>新建一个项目导入生成的dll文件</p>
<p>导入的第一种方式，隐式链接的方式调用dll导出寒素</p>
<p><code>#pragma comment(lib,&quot;Mydll.lib&quot;)//lib地址</code></p>
<p>头文件main.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;Mydll.lib&quot;</span>)<span class="comment">//lib地址</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>源文件main.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> sum = <span class="built_in">add</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, sum);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种显示链接方式调用导出函数</p>
<p>不需要头文件和lib，源文件main.cpp如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*XXOR)</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HMODULE hModule = <span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;Mydll.dll&quot;</span>);</span><br><span class="line">	XXOR Xorr = (XXOR)<span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;XXOR&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, <span class="built_in">Xorr</span>(<span class="number">100</span>, <span class="number">200</span>));</span><br><span class="line">	<span class="built_in">FreeLibrary</span>(hModule);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="c语言RC4，base64加解密代码"><a href="#c语言RC4，base64加解密代码" class="headerlink" title="c语言RC4，base64加解密代码"></a>c语言RC4，base64加解密代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* S, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* key, <span class="type">int</span> keylen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        S[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        j = (j + S[i] + key[i % keylen]) % <span class="number">256</span>;</span><br><span class="line">        <span class="comment">// 交换 S[i] 和 S[j]</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> temp = S[i];</span><br><span class="line">        S[i] = S[j];</span><br><span class="line">        S[j] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成一个字节的密钥流</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> <span class="title">generate</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* S, <span class="type">int</span>* i, <span class="type">int</span>* j)</span> </span>&#123;</span><br><span class="line">    *i = (*i + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">    *j = (*j + S[*i]) % <span class="number">256</span>;</span><br><span class="line">    <span class="comment">// 交换 S[i] 和 S[j]</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp = S[*i];</span><br><span class="line">    S[*i] = S[*j];</span><br><span class="line">    S[*j] = temp;</span><br><span class="line">    <span class="comment">// 返回 S[S[i] + S[j]]</span></span><br><span class="line">    <span class="keyword">return</span> S[(S[*i] + S[*j]) % <span class="number">256</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对数据进行加密或解密</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">encrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">int</span> datalen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* key, <span class="type">int</span> keylen)</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> S[<span class="number">256</span>]; <span class="comment">// 256 字节的数据表</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; <span class="comment">// 两个索引变量</span></span><br><span class="line">    <span class="comment">// 初始化 S 表</span></span><br><span class="line">    <span class="built_in">init</span>(S, key, keylen);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; datalen; k++) &#123;</span><br><span class="line">        <span class="comment">// 数据和密钥流进行异或运算</span></span><br><span class="line">        data[k] ^= <span class="built_in">generate</span>(S, &amp;i, &amp;j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> base64char = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">base64_decode</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* base64, <span class="type">unsigned</span> <span class="type">char</span>* bindata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> k;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; base64[i] != <span class="string">&#x27;\0&#x27;</span>; i += <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(temp, <span class="number">0xFF</span>, <span class="built_in">sizeof</span>(temp));</span><br><span class="line">        <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">64</span>; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (base64char[k] == base64[i])</span><br><span class="line">                temp[<span class="number">0</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">64</span>; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (base64char[k] == base64[i + <span class="number">1</span>])</span><br><span class="line">                temp[<span class="number">1</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">64</span>; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (base64char[k] == base64[i + <span class="number">2</span>])</span><br><span class="line">                temp[<span class="number">2</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">64</span>; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (base64char[k] == base64[i + <span class="number">3</span>])</span><br><span class="line">                temp[<span class="number">3</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bindata[j++] = ((<span class="type">unsigned</span> <span class="type">char</span>)(((<span class="type">unsigned</span> <span class="type">char</span>)(temp[<span class="number">0</span>] &lt;&lt; <span class="number">2</span>)) &amp; <span class="number">0xFC</span>)) |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">char</span>)((<span class="type">unsigned</span> <span class="type">char</span>)(temp[<span class="number">1</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x03</span>));</span><br><span class="line">        <span class="keyword">if</span> (base64[i + <span class="number">2</span>] == <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        bindata[j++] = ((<span class="type">unsigned</span> <span class="type">char</span>)(((<span class="type">unsigned</span> <span class="type">char</span>)(temp[<span class="number">1</span>] &lt;&lt; <span class="number">4</span>)) &amp; <span class="number">0xF0</span>)) |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">char</span>)((<span class="type">unsigned</span> <span class="type">char</span>)(temp[<span class="number">2</span>] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x0F</span>));</span><br><span class="line">        <span class="keyword">if</span> (base64[i + <span class="number">3</span>] == <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        bindata[j++] = ((<span class="type">unsigned</span> <span class="type">char</span>)(((<span class="type">unsigned</span> <span class="type">char</span>)(temp[<span class="number">2</span>] &lt;&lt; <span class="number">6</span>)) &amp; <span class="number">0xF0</span>)) |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">char</span>)(temp[<span class="number">3</span>] &amp; <span class="number">0x3F</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* bindata, <span class="type">char</span>* base64, <span class="type">int</span> binlength)</span><span class="comment">//输入，输出，输入长度</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> current;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; binlength; i += <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        current = (bindata[i] &gt;&gt; <span class="number">2</span>);</span><br><span class="line">        current &amp;= (<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0x3F</span>;</span><br><span class="line">        base64[j++] = base64char[(<span class="type">int</span>)current];</span><br><span class="line"></span><br><span class="line">        current = ((<span class="type">unsigned</span> <span class="type">char</span>)(bindata[i] &lt;&lt; <span class="number">4</span>)) &amp; ((<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &gt;= binlength)</span><br><span class="line">        &#123;</span><br><span class="line">            base64[j++] = base64char[(<span class="type">int</span>)current];</span><br><span class="line">            base64[j++] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            base64[j++] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        current |= ((<span class="type">unsigned</span> <span class="type">char</span>)(bindata[i + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>)) &amp; ((<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0x0F</span>);</span><br><span class="line">        base64[j++] = base64char[(<span class="type">int</span>)current];</span><br><span class="line"></span><br><span class="line">        current = ((<span class="type">unsigned</span> <span class="type">char</span>)(bindata[i + <span class="number">1</span>] &lt;&lt; <span class="number">2</span>)) &amp; ((<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0x3C</span>);</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">2</span> &gt;= binlength)</span><br><span class="line">        &#123;</span><br><span class="line">            base64[j++] = base64char[(<span class="type">int</span>)current];</span><br><span class="line">            base64[j++] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        current |= ((<span class="type">unsigned</span> <span class="type">char</span>)(bindata[i + <span class="number">2</span>] &gt;&gt; <span class="number">6</span>)) &amp; ((<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0x03</span>);</span><br><span class="line">        base64[j++] = base64char[(<span class="type">int</span>)current];</span><br><span class="line"></span><br><span class="line">        current = ((<span class="type">unsigned</span> <span class="type">char</span>)bindata[i + <span class="number">2</span>]) &amp; ((<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0x3F</span>);</span><br><span class="line">        base64[j++] = base64char[(<span class="type">int</span>)current];</span><br><span class="line">    &#125;</span><br><span class="line">    base64[j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> base64;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> Buffer[<span class="number">31</span>];</span><br><span class="line">    <span class="type">char</span> enc[<span class="number">41</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> key[] = <span class="string">&quot;BirkenwaldCTF&#123;This_is_f4ke_f1ag&#125;&quot;</span>;<span class="comment">//RC5密钥</span></span><br><span class="line">    <span class="type">int</span> keylen = (<span class="type">int</span>)<span class="built_in">strlen</span>((<span class="type">char</span>*)key);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Do you know flag?\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please tell me:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, Buffer);</span><br><span class="line">    <span class="type">int</span> datelen = (<span class="type">int</span>)<span class="built_in">strlen</span>((<span class="type">char</span>*)Buffer);</span><br><span class="line">    <span class="built_in">encrypt</span>(Buffer, datelen, key, keylen);<span class="comment">//RC4加密</span></span><br><span class="line">    <span class="built_in">encrypt2</span>(Buffer, enc, <span class="number">30</span>);<span class="comment">//base64加密</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="lea指令使用，防止遗忘"><a href="#lea指令使用，防止遗忘" class="headerlink" title="lea指令使用，防止遗忘"></a>lea指令使用，防止遗忘</h2><p>lea，官方解释Load Effective Address，即装入有效地址的意思，它的操作数就是地址；</p>
<p>常见的几种用法：</p>
<p><code>1、lea eax，[addr]</code></p>
<p>就是将表达式addr的值放入eax寄存器，示例如下：</p>
<p>lea eax,[401000h]; 将值401000h写入eax寄存器中</p>
<p>lea指令右边的操作数表示一个精指针，上述指令和mov eax，401000h是等价的</p>
<p><code>2、lea eax，dword ptr [ebx]</code>;将ebx的值赋值给eax</p>
<p><code>3、lea eax，c</code>；其中c为一个int型的变量，该条语句的意思是把c的地址赋值给eax；</p>
<h2 id="内联汇编实现部分常用函数功能练习"><a href="#内联汇编实现部分常用函数功能练习" class="headerlink" title="内联汇编实现部分常用函数功能练习"></a>内联汇编实现部分常用函数功能练习</h2><p>在全局内定义字符串后的print hello world，因为编译器会编译的时候会自动寻址，最简单的一种方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> format[] = <span class="string">&quot;%s %s\n&quot;</span>;</span><br><span class="line"><span class="type">char</span> hello[] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">char</span> world[] = <span class="string">&quot;world!&quot;</span>;</span><br><span class="line"><span class="comment">//_declspec(naked)裸函数标识，没有基本函数框架的函数</span></span><br><span class="line"><span class="type">void</span> _declspec(naked)<span class="built_in">print</span>()<span class="comment">//打印hello world</span></span><br><span class="line">&#123;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		push ebp</span><br><span class="line">		mov ebp,esp</span><br><span class="line">		sub esp,<span class="number">0x20</span></span><br><span class="line">		mov eax,offset world</span><br><span class="line">		push eax</span><br><span class="line">		mov eax,offset hello</span><br><span class="line">		push eax</span><br><span class="line">		mov eax,offset format</span><br><span class="line">		push eax</span><br><span class="line">		call printf</span><br><span class="line">		pop ebx</span><br><span class="line">		pop ebx</span><br><span class="line">		pop ebx</span><br><span class="line">		mov esp,ebp</span><br><span class="line">		pop ebp</span><br><span class="line">		retn</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		call print</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用局部变量字符串，将字符串push进栈中，通过栈寻址，push传参来实现功能</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">//char format[] = &quot;%s %s&quot;;//25,73,20,25,73</span></span><br><span class="line"><span class="comment">//char hello[] = &quot;hello&quot;;//68,65,6c,6c,6f</span></span><br><span class="line"><span class="comment">//char world[] = &quot;world!&quot;;//77,6f,72,6c,64,21</span></span><br><span class="line"><span class="type">void</span> _declspec(naked)<span class="built_in">print</span>()</span><br><span class="line">&#123;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		push ebp</span><br><span class="line">		mov ebp,esp</span><br><span class="line">		push eax</span><br><span class="line">		push <span class="number">0x2164</span><span class="comment">//push 后高位自动补零结束字符串</span></span><br><span class="line">		push <span class="number">0x6c726f77</span><span class="comment">//注意push顺序和十六进制顺序</span></span><br><span class="line">		push <span class="number">0x6f</span></span><br><span class="line">		push <span class="number">0x6c6c6568</span></span><br><span class="line">		push <span class="number">0x73</span></span><br><span class="line">		push <span class="number">0x25207325</span></span><br><span class="line">		lea eax,dword ptr ss:[esp<span class="number">+0x10</span>]<span class="comment">//ss堆栈段，ds数据段</span></span><br><span class="line">		push eax</span><br><span class="line">		lea eax,dword ptr ss:[esp<span class="number">+0xc</span>]<span class="comment">//注意偏移量计算</span></span><br><span class="line">		push eax</span><br><span class="line">		lea eax,dword ptr ss:[esp<span class="number">+0x08</span>]<span class="comment">//用lea将字符串地址传入寄存器</span></span><br><span class="line">		push eax</span><br><span class="line">		call printf</span><br><span class="line">		add esp,<span class="number">0x24</span></span><br><span class="line">		pop eax</span><br><span class="line">		mov esp,ebp</span><br><span class="line">		pop ebp</span><br><span class="line">		ret</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//char format[] = &quot;%s %s&quot;;//25,73,20,25,73,0a</span></span><br><span class="line">	<span class="comment">//char hello[] = &quot;hello&quot;;//68,65,6c,6c,6f</span></span><br><span class="line">	<span class="comment">//char world[] = &quot;world!&quot;;//77,6f,72,6c,64,21</span></span><br><span class="line">	<span class="comment">//printf(format, hello, world);</span></span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		call print</span><br><span class="line">		ret</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用kernel32.dll或者kernelbase.dll模块寻找loadlibrary和getprocaddr函数地址，以此加载想要的模块和获得想要的函数地址，从而调用想要的函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> Load[] = <span class="string">&quot;LoadLibraryA&quot;</span>;<span class="comment">//4c,6f,61,64,4c,69,62,72,61,72,79,41 00 len = 0xc</span></span><br><span class="line"><span class="type">char</span> Get[] = <span class="string">&quot;GetProcAddress&quot;</span>;<span class="comment">//47,65,74,50,72,6f,63,41,64,64,72,65,73,73 00 len = 0xe</span></span><br><span class="line"><span class="type">char</span> hello[] = <span class="string">&quot;hello world!&quot;</span>;<span class="comment">//68,65,6c,6c,6f,20,77,6f,72,6c,64,21 00 len = 0xc</span></span><br><span class="line"><span class="type">char</span> Msvc[] = <span class="string">&quot;msvcrt.dll&quot;</span>;<span class="comment">//6d,73,76,63,72,74,2e,64,6c,6c 00 len = 0xa</span></span><br><span class="line"><span class="type">char</span> Print[] = <span class="string">&quot;printf&quot;</span>;<span class="comment">//70,72,69,6e,74,66 00 len = 0x6</span></span><br><span class="line"><span class="type">void</span> _declspec(naked)<span class="built_in">MyShell</span>()</span><br><span class="line">&#123;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		pushad</span><br><span class="line">		mov ebp,esp</span><br><span class="line">		push <span class="number">0</span></span><br><span class="line">		push <span class="number">0x21646c72</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x6f77206f</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x6c6c6568</span><span class="comment">//hello world</span></span><br><span class="line">		push <span class="number">0x7373</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x65726464</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x41636f72</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x50746547</span><span class="comment">//GetProcAddress</span></span><br><span class="line">        push <span class="number">0</span></span><br><span class="line">		push <span class="number">0x41797261</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x7262694c</span><span class="comment">//</span></span><br><span class="line">		push <span class="number">0x64616f4c</span><span class="comment">//LoadLibraryA</span></span><br><span class="line">		mov ecx,esp</span><br><span class="line">		push ecx<span class="comment">//esp传参过去</span></span><br><span class="line">		call Func_print</span><br><span class="line">		mov esp,ebp</span><br><span class="line">		popad</span><br><span class="line">               nop</span><br><span class="line">               nop</span><br><span class="line">               nop</span><br><span class="line">               nop</span><br><span class="line">               nop<span class="comment">//填充五个字节留给jmp指令，因为call指令有一个相对地址</span></span><br><span class="line">            <span class="comment">//可以在OD，xdbg中计算jmp的相对地址</span></span><br><span class="line">            </span><br><span class="line">    </span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line">	Func_GetModule:</span><br><span class="line">	push ebp</span><br><span class="line">		mov ebp, esp</span><br><span class="line">		sub esp, <span class="number">0x20</span></span><br><span class="line">		push esi</span><br><span class="line">		mov esi,dword ptr fs:[<span class="number">0x30</span>]<span class="comment">//PEB结构体地址</span></span><br><span class="line">		mov esi,[esi<span class="number">+0xc</span>]<span class="comment">//LDR结构体地址</span></span><br><span class="line">		mov esi,[esi<span class="number">+0x1c</span>]<span class="comment">//list</span></span><br><span class="line">		mov esi,[esi]<span class="comment">//list 第二项kernel32或者kernelbase</span></span><br><span class="line">		mov esi,[esi<span class="number">+0x8</span>]<span class="comment">//dllbase</span></span><br><span class="line">		mov eax,esi</span><br><span class="line">		pop esi</span><br><span class="line">		mov esp, ebp</span><br><span class="line">		pop ebp</span><br><span class="line">		ret </span><br><span class="line"></span><br><span class="line">		Func_GetAddr:</span><br><span class="line">	    push ebp</span><br><span class="line">		mov ebp, esp</span><br><span class="line">		sub esp, <span class="number">0x20</span></span><br><span class="line">		mov edx, [ebp + <span class="number">0x8</span>]<span class="comment">//dllbase</span></span><br><span class="line">		mov esi, [edx + <span class="number">0x3c</span>]<span class="comment">//if_anew</span></span><br><span class="line">		lea esi, [esi + edx]<span class="comment">//NT header</span></span><br><span class="line">		mov esi, [esi + <span class="number">0x78</span>]<span class="comment">//导出表RVA</span></span><br><span class="line">		lea esi, [edx + esi]<span class="comment">//导出表VA</span></span><br><span class="line">		mov edi, [esi + <span class="number">0x1c</span>]<span class="comment">//EAT RVA</span></span><br><span class="line">		lea edi, [edi + edx]<span class="comment">//EAT VA</span></span><br><span class="line">		mov [ebp - <span class="number">0x4</span>], edi<span class="comment">//保存</span></span><br><span class="line">		mov edi, [esi + <span class="number">0x20</span>]<span class="comment">//ENT RVA</span></span><br><span class="line">		lea edi, [edi + edx]<span class="comment">//ENT VA</span></span><br><span class="line">		mov [ebp - <span class="number">0x8</span>], edi<span class="comment">//保存</span></span><br><span class="line">		mov edi, [esi + <span class="number">0x24</span>]<span class="comment">//EOT RVA</span></span><br><span class="line">		lea edi, [edi+edx]<span class="comment">//EOT VA</span></span><br><span class="line">		mov [ebp<span class="number">-0xc</span>],edi<span class="comment">//保存</span></span><br><span class="line">		<span class="keyword">xor</span> eax,eax</span><br><span class="line">		jmp tag_cmpfirst</span><br><span class="line">	tag_cmpLoop:</span><br><span class="line">	    inc eax</span><br><span class="line">	tag_cmpfirst:</span><br><span class="line">	    mov esi,[ebp<span class="number">-0x8</span>]<span class="comment">//ENT</span></span><br><span class="line">		mov esi,[esi+eax*<span class="number">4</span>]<span class="comment">//RVA</span></span><br><span class="line">		lea esi,[esi+edx]<span class="comment">//函数名称字符串地址</span></span><br><span class="line">		mov edi,[ebp<span class="number">+0xc</span>]<span class="comment">//</span></span><br><span class="line">		mov ecx,[ebp<span class="number">+0x10</span>]<span class="comment">//循环次数，ebp+0x10是传来的参数</span></span><br><span class="line">		repe cmpsb</span><br><span class="line">		mov esi,[ebp<span class="number">-0xc</span>]</span><br><span class="line">		jne tag_cmpLoop</span><br><span class="line">		mov esi,[ebp<span class="number">-0xc</span>]<span class="comment">//EOT</span></span><br><span class="line">		<span class="keyword">xor</span> edi,edi<span class="comment">//为了不影响结果清空edi</span></span><br><span class="line">		mov di,[esi+eax*<span class="number">2</span>]<span class="comment">//word类型,EAT表索引</span></span><br><span class="line">		mov edx,[ebp<span class="number">-0x4</span>]<span class="comment">//EAT</span></span><br><span class="line">		mov esi,[edx+edi*<span class="number">4</span>]<span class="comment">//函数地址RVA</span></span><br><span class="line">		mov edx,[ebp<span class="number">+0x8</span>]<span class="comment">//dllbase</span></span><br><span class="line">		lea eax,[esi+edx]<span class="comment">//最终函数地址</span></span><br><span class="line">		mov esp, ebp</span><br><span class="line">		pop ebp</span><br><span class="line">		retn <span class="number">0xc</span><span class="comment">//在栈中弹出三个参数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	Func_print:</span><br><span class="line">	push ebp</span><br><span class="line">		mov ebp,esp </span><br><span class="line">		sub esp,<span class="number">0x10</span></span><br><span class="line">		call Func_GetModule<span class="comment">//获取kernel模块基址</span></span><br><span class="line">		mov [ebp<span class="number">-0x4</span>],eax<span class="comment">//[ebp-0x4]保存模块基址</span></span><br><span class="line">		lea ecx,[ebp + <span class="number">0xc</span>]<span class="comment">//load地址</span></span><br><span class="line">		push <span class="number">0xc</span></span><br><span class="line">		push ecx</span><br><span class="line">		push eax</span><br><span class="line">		call Func_GetAddr<span class="comment">//三个参数，第一个模块基址，第二个字符串地址，第三个字符串长度 loadlibrarya</span></span><br><span class="line">		mov [ebp<span class="number">-0x8</span>],eax<span class="comment">//load地址	</span></span><br><span class="line">		push <span class="number">0xe</span></span><br><span class="line">		lea ecx, [ebp + <span class="number">0x1c</span>]<span class="comment">//Get字符串</span></span><br><span class="line">		push ecx</span><br><span class="line">		push [ebp<span class="number">-0x4</span>]<span class="comment">//模块基址</span></span><br><span class="line">		call Func_GetAddr<span class="comment">//三个参数，第一个模块基址，第二个字符串地址，第三个字符串长度 GetProcAddress</span></span><br><span class="line">		mov [ebp<span class="number">-0xc</span>],eax<span class="comment">//get地址</span></span><br><span class="line">		push <span class="number">0x6c6c</span></span><br><span class="line">		push <span class="number">0x642e7472</span>	</span><br><span class="line">		push <span class="number">0x6376736d</span></span><br><span class="line">		lea ecx,dword ptr ss:[ebp<span class="number">-0x1c</span>]</span><br><span class="line">		push ecx</span><br><span class="line">		call [ebp<span class="number">-0x8</span>]<span class="comment">//调用load函数load Msvc.dll，一个参数，字符串地址</span></span><br><span class="line">		push <span class="number">0x6674</span></span><br><span class="line">		push <span class="number">0x6e697270</span></span><br><span class="line">		lea ecx,[ebp<span class="number">-0x24</span>]<span class="comment">//printf字符串</span></span><br><span class="line">		push ecx</span><br><span class="line">		push eax<span class="comment">//msvc.dll基址</span></span><br><span class="line">		call [ebp<span class="number">-0xc</span>]<span class="comment">//调用GetProcAddress函数，两个参数，一个msvc.dll基址，一个字符串名称</span></span><br><span class="line">		lea ecx,[ebp<span class="number">+0x2c</span>]<span class="comment">//hello world地址</span></span><br><span class="line">		push ecx</span><br><span class="line">		call eax<span class="comment">//printf地址</span></span><br><span class="line">		mov esp,ebp</span><br><span class="line">		pop ebp</span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*GetProcAddress();</span></span><br><span class="line"><span class="comment">    LoadLibraryA()*/</span></span><br><span class="line">		<span class="comment">//6d, 73, 76, 63, 72, 74, 2e, 64, 6c, 6c 00 len = 0xa</span></span><br><span class="line">		<span class="comment">// //70,72,69,6e,74,66</span></span><br><span class="line">	<span class="built_in">MyShell</span>();</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="comment">/*	for (int i = 0; i &lt; strlen(Print); i++)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			printf(&quot;%x,&quot;, Print[i]);</span></span><br><span class="line"><span class="comment">		&#125;*/</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*AT&amp;T写法</span></span><br><span class="line"><span class="comment">asm(</span></span><br><span class="line"><span class="comment">    &quot;pusha\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %esp, %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x21646c72\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x6f77206f\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x6c6c6568\n&quot; // hello world</span></span><br><span class="line"><span class="comment">    &quot;push $0x7373\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x65726464\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x41636f72\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x50746547\n&quot; // GetProcAddress</span></span><br><span class="line"><span class="comment">    &quot;push $0\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x41797261\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x7262694c\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x64616f4c\n&quot; // LoadLibraryA</span></span><br><span class="line"><span class="comment">    &quot;mov %esp, %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %ecx\n&quot; // esp传参过去</span></span><br><span class="line"><span class="comment">    &quot;call Func_print\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %ebp, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;popa\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;nop\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;nop\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;nop\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;nop\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;nop\n&quot; // 填充五个字节留给jmp指令，因为call指令有一个相对地址</span></span><br><span class="line"><span class="comment">    // 可以在OD，xdbg中计算jmp的相对地址</span></span><br><span class="line"><span class="comment">    &quot;mov %ebp, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;pop %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;ret\n&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&quot;Func_GetModule:&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %esp, %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;sub $0x20, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %esi\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %fs:0x30, %esi\n&quot; // PEB结构体地址</span></span><br><span class="line"><span class="comment">    &quot;mov 0xc(%esi), %esi\n&quot; // LDR结构体地址</span></span><br><span class="line"><span class="comment">    &quot;mov 0x1c(%esi), %esi\n&quot; // list</span></span><br><span class="line"><span class="comment">    &quot;mov (%esi), %esi\n&quot; // list 第二项kernel32或者kernelbase</span></span><br><span class="line"><span class="comment">    &quot;mov 0x8(%esi), %esi\n&quot; // dllbase</span></span><br><span class="line"><span class="comment">    &quot;mov %esi, %eax\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;pop %esi\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %ebp, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;pop %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;ret\n&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&quot;Func_GetAddr:&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %esp, %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;sub $0x20, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov 0x8(%ebp), %edx\n&quot; // dllbase</span></span><br><span class="line"><span class="comment">    &quot;mov 0x3c(%edx), %esi\n&quot; // if_anew</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %esi), %esi\n&quot;  // NT header</span></span><br><span class="line"><span class="comment">    &quot;mov 0x78(%esi), %esi\n&quot;  // 导出表RVA</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %esi), %esi\n&quot;  // 导出表VA</span></span><br><span class="line"><span class="comment">    &quot;mov 0x1c(%esi), %edi\n&quot;  // EAT RVA</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %edi), %edi\n&quot;  // EAT VA</span></span><br><span class="line"><span class="comment">    &quot;mov %edi, -0x4(%ebp)\n&quot;  // 保存</span></span><br><span class="line"><span class="comment">    &quot;mov 0x20(%esi), %edi\n&quot;  // ENT RVA</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %edi), %edi\n&quot;  // ENT VA</span></span><br><span class="line"><span class="comment">    &quot;mov %edi, -0x8(%ebp)\n&quot;  // 保存</span></span><br><span class="line"><span class="comment">    &quot;mov 0x24(%esi), %edi\n&quot;  // EOT RVA</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %edi), %edi\n&quot;  // EOT VA</span></span><br><span class="line"><span class="comment">    &quot;mov %edi, -0xc(%ebp)\n&quot;  // 保存</span></span><br><span class="line"><span class="comment">    &quot;xor %eax, %eax\n&quot; </span></span><br><span class="line"><span class="comment">    &quot;jmp tag_cmpfirst\n&quot; </span></span><br><span class="line"><span class="comment">&quot;tag_cmpLoop:&quot;</span></span><br><span class="line"><span class="comment">    &quot;inc %eax\n&quot; </span></span><br><span class="line"><span class="comment">&quot;tag_cmpfirst:&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov -0x8(%ebp), %esi\n&quot;  // ENT</span></span><br><span class="line"><span class="comment">    &quot;mov (%esi, %eax, 4), %esi\n&quot; // RVA</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %esi), %esi\n&quot; // 函数名称字符串地址</span></span><br><span class="line"><span class="comment">    &quot;mov 0xc(%ebp), %edi\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov 0x10(%ebp), %ecx\n&quot; // 循环次数，ebp+0x10是传来的参数</span></span><br><span class="line"><span class="comment">    &quot;repe cmpsb\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov -0xc(%ebp), %esi\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;jne tag_cmpLoop\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov -0xc(%ebp), %esi\n&quot; // EOT</span></span><br><span class="line"><span class="comment">    &quot;xor %edi, %edi\n&quot; // 为了不影响结果清空edi</span></span><br><span class="line"><span class="comment">    &quot;mov (%esi, %eax, 2), %di\n&quot; // word类型,EAT表索引</span></span><br><span class="line"><span class="comment">    &quot;mov -0x4(%ebp), %edx\n&quot; // EAT</span></span><br><span class="line"><span class="comment">    &quot;mov (%edx, %edi, 4), %esi\n&quot; // 函数地址RVA</span></span><br><span class="line"><span class="comment">    &quot;mov 0x8(%ebp), %edx\n&quot; // dllbase</span></span><br><span class="line"><span class="comment">    &quot;lea (%edx, %esi), %eax\n&quot; // 最终函数地址</span></span><br><span class="line"><span class="comment">    &quot;mov %ebp, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;pop %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;ret $0xc\n&quot; // 在栈中弹出三个参数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&quot;Func_print:&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;mov %esp, %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;sub $0x10, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;call Func_GetModule\n&quot; // 获取kernel模块基址</span></span><br><span class="line"><span class="comment">    &quot;mov %eax, -0x4(%ebp)\n&quot; // 保存模块基址</span></span><br><span class="line"><span class="comment">    &quot;lea 0xc(%ebp), %ecx\n&quot; // load地址</span></span><br><span class="line"><span class="comment">    &quot;push $0xc\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %eax\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;call Func_GetAddr\n&quot; // 三个参数，第一个模块基址，第二个字符串地址，第三个字符串长度 loadlibrarya</span></span><br><span class="line"><span class="comment">    &quot;mov %eax, -0x8(%ebp)\n&quot; // load地址</span></span><br><span class="line"><span class="comment">    &quot;push $0xe\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;lea 0x1c(%ebp), %ecx\n&quot; // Get字符串</span></span><br><span class="line"><span class="comment">    &quot;push %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push -0x4(%ebp)\n&quot; // 模块基址</span></span><br><span class="line"><span class="comment">    &quot;call Func_GetAddr\n&quot; // 三个参数，第一个模块基址，第二个字符串地址，第三个字符串长度 GetProcAddress</span></span><br><span class="line"><span class="comment">    &quot;mov %eax, -0xc(%ebp)\n&quot; // get地址</span></span><br><span class="line"><span class="comment">    &quot;push $0x6c6c\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x642e7472\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x6376736d\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;lea -0x1c(%ebp), %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;call -0x8(%ebp)\n&quot; // 调用load函数load Msvc.dll，一个参数，字符串地址</span></span><br><span class="line"><span class="comment">    &quot;push $0x6674\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push $0x6e697270\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;lea -0x24(%ebp), %ecx\n&quot; // printf字符串</span></span><br><span class="line"><span class="comment">    &quot;push %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;push %eax\n&quot; // msvc.dll基址</span></span><br><span class="line"><span class="comment">    &quot;call -0xc(%ebp)\n&quot; // 调用GetProcAddress函数，两个参数，一个msvc.dll基址，一个字符串名称</span></span><br><span class="line"><span class="comment">    &quot;lea 0x2c(%ebp), %ecx\n&quot; // hello world地址</span></span><br><span class="line"><span class="comment">    &quot;push %ecx\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;call %eax\n&quot; // printf地址</span></span><br><span class="line"><span class="comment">    &quot;mov %ebp, %esp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;pop %ebp\n&quot;</span></span><br><span class="line"><span class="comment">    &quot;ret\n&quot;</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>准备了一个表格存储栈信息,ebp2对应的是print函数的栈底，pushadd到ebp2是Myshell函数形成的栈帧</p>
<table>
<thead>
<tr>
<th></th>
<th>msvc</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>printf</td>
</tr>
<tr>
<td>28</td>
<td>6e</td>
</tr>
<tr>
<td>printf 24</td>
<td>66</td>
</tr>
<tr>
<td>20</td>
<td>msvc</td>
</tr>
<tr>
<td>1c msvc</td>
<td>63</td>
</tr>
<tr>
<td>18</td>
<td>64</td>
</tr>
<tr>
<td>14</td>
<td>6c</td>
</tr>
<tr>
<td>esp 0x10</td>
<td></td>
</tr>
<tr>
<td>0xc</td>
<td>get_adr</td>
</tr>
<tr>
<td>0x8</td>
<td>load_adr</td>
</tr>
<tr>
<td>0x4</td>
<td>kernel</td>
</tr>
<tr>
<td>ebp2</td>
<td>ebp1</td>
</tr>
<tr>
<td>4</td>
<td>eip</td>
</tr>
<tr>
<td>8</td>
<td>ecx&#x3D;esp1</td>
</tr>
<tr>
<td>load c</td>
<td>64</td>
</tr>
<tr>
<td>10</td>
<td>72</td>
</tr>
<tr>
<td>14</td>
<td>41</td>
</tr>
<tr>
<td>18</td>
<td>0</td>
</tr>
<tr>
<td>get1c</td>
<td>50</td>
</tr>
<tr>
<td>20</td>
<td>41</td>
</tr>
<tr>
<td>24</td>
<td>65</td>
</tr>
<tr>
<td>28</td>
<td>73</td>
</tr>
<tr>
<td>hello 2c</td>
<td>6c</td>
</tr>
<tr>
<td>30</td>
<td>6f</td>
</tr>
<tr>
<td>34</td>
<td>21</td>
</tr>
<tr>
<td>38</td>
<td>0</td>
</tr>
<tr>
<td>pushadd</td>
<td>ad</td>
</tr>
</tbody></table>
<h2 id="重温栈结构"><a href="#重温栈结构" class="headerlink" title="重温栈结构"></a>重温栈结构</h2><blockquote>
<p>今天在准备写一个壳的时候需要手写汇编，把汇编十六进制插入PE文件中，一时对栈结构有点遗忘，在xdbg中调了会温故了一下，在这里记一下，防止下一次遗忘</p>
</blockquote>
<p>比方说我们有一个main函数时，在函数开始时经常有如下汇编代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push ebp</span><br><span class="line"></span><br><span class="line">mov esp,ebp</span><br><span class="line"></span><br><span class="line">sub esp,<span class="number">0x20</span></span><br></pre></td></tr></table></figure>

<p>为什么会出现以上代码？在主函数调用的子函数中能不能不出现这些代码？</p>
<p>push ebp 做的是一个保存ebp的操作，mov esp,ebp为下一个栈帧形成打下基础，在新栈帧中利用栈来保存数据，并且不会破坏原来栈帧中的数据</p>
<p>sub esp,0x20则是开辟了一个新的栈空间，这段空间可被函数直接利用，比如说做一些局部变量的初始化操作，也可以省略这部操作，直接通过push提高栈顶（地址下降）然后再通过mov在栈中储存数据（初始化局部变量）</p>
<p>主函数下的子函数结构和main函数类似，其实也可以说main函数时其他函数的子函数，没有什么较大的区别</p>
<p>在call的时候其实把下一条要执行汇编代码地址push进了栈中，然后在函数内部在push ebp这些操作，使得每次函数调用结束时，会出现以下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pop ebp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>ret返回的正是下一条汇编代码执行处</p>
<p>在函数调用时，有时通过push来传递参数，这个时候栈顶提高，但是参数传递之后对主函数没有任何作用，所以函数调用结束时主函数有时候会通过add esp来调整栈空间。</p>
<p>push指令在x86架构下是推入四个字节数据或地址，推入常量高位用0填充，可以通过mov指令实现对栈中数据进行字节位的调整</p>
<h2 id="ret-和-retn的区别"><a href="#ret-和-retn的区别" class="headerlink" title="ret 和 retn的区别"></a>ret 和 retn的区别</h2><blockquote>
<ul>
<li>ret和retn都是返回指令，用于从子程序中返回到调用处，同时从栈中弹出返回地址</li>
<li>ret和retn的区别在于是否有操作数。ret没有操作数，只是从栈中弹出返回地址；retn有一个操作数，表示要从栈中弹出的字节数</li>
<li>例如add esp,0x4; ret;，等价于retn 0x4</li>
</ul>
</blockquote>
<h2 id="repe-cmpsb字符串比较汇编指令"><a href="#repe-cmpsb字符串比较汇编指令" class="headerlink" title="repe cmpsb字符串比较汇编指令"></a>repe cmpsb字符串比较汇编指令</h2><blockquote>
<p>是一个汇编语言指令，它的意思是重复比较两个字符串的字节，直到不相等或者计数器为零为止。它涉及到三个寄存器：ECX，EDI和ESI。<strong>ECX是计数器</strong>，表示要比较的字节数；<strong>EDI和ESI是两个字符串的起始地址</strong>。每次比较后，EDI和ESI会根据方向标志DF的值自动增加或减少。如果DF为0，表示正向比较，EDI和ESI都加一；如果DF为1，表示反向比较，EDI和ESI都减一。比较的结果会影响标志寄存器中的零标志ZF。如果ZF为1，表示两个字节相等；如果ZF为0，表示两个字节不等。repe cmpsb通常用来检测两个字符串是否完全相同</p>
</blockquote>
<h2 id="jmp指令偏移地址计算"><a href="#jmp指令偏移地址计算" class="headerlink" title="jmp指令偏移地址计算"></a>jmp指令偏移地址计算</h2><p>在使用jmp汇编指令时，关于算偏移地址的时候机器码十六进制的计算</p>
<p>往下运行时，0x2 &#x3D; 0x44A04D-0x44A049-0x2，也就是jmp到的地址-原来jmp前的地址-jmp这条指令的字节数，本质就是算中间有多少字节</p>
<p>往上运行时，0xFFF870F7 &#x3D; 0x401140 - 0x44A044 - 5 最后一个五是jmp指令的字节数，0xFFF870F7转化成机器码就是F770FBFF</p>
<h2 id="IDAPatch保存后动调"><a href="#IDAPatch保存后动调" class="headerlink" title="IDAPatch保存后动调"></a>IDAPatch保存后动调</h2><p>Keypatcher进行patch，ctrl+w保存patch结果，但是动调有影响</p>
<p>Apply patches to后动调即可 ，在edit-patch program里</p>
<h2 id="Ollvm控制流平坦化技术"><a href="#Ollvm控制流平坦化技术" class="headerlink" title="Ollvm控制流平坦化技术"></a>Ollvm控制流平坦化技术</h2><p>ghidra自动化去混淆工具: <a target="_blank" rel="noopener" href="https://github.com/PAGalaxyLab/ghidra_scripts">https://github.com/PAGalaxyLab/ghidra_scripts</a></p>
<p>IDA自动化去混淆工具d810: <a target="_blank" rel="noopener" href="https://github.com/joydo/d810">https://github.com/joydo/d810</a></p>
<h2 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h2><h3 id="Hook的多种方式"><a href="#Hook的多种方式" class="headerlink" title="Hook的多种方式"></a>Hook的多种方式</h3><p><img src="https://s2.loli.net/2024/06/22/QkYWnuEXvbVM8Kp.png" alt="image-20240418163602878"></p>
<h3 id="HOOK和Callback的区别"><a href="#HOOK和Callback的区别" class="headerlink" title="HOOK和Callback的区别"></a>HOOK和Callback的区别</h3><p>钩子技术（Hook）和回调函数（Callback）在编程中都是用于实现程序的扩展和灵活性，但它们有着不同的作用和实现方式。</p>
<h4 id="相同点"><a href="#相同点" class="headerlink" title="相同点"></a>相同点</h4><ul>
<li>事件响应： 钩子技术和回调函数都用于实现对特定事件的响应和处理。</li>
<li>灵活性： 两者都可以增强程序的灵活性和扩展性，使得程序能够更好地处理不同的情况和需求。</li>
</ul>
<h4 id="差异性"><a href="#差异性" class="headerlink" title="差异性"></a>差异性</h4><ol>
<li>作用：</li>
</ol>
<ul>
<li>钩子技术主要用于拦截、监视和修改系统级别或应用程序级别的事件，比如键盘输入、鼠标操作、窗口消息等。</li>
<li>回调函数主要用于在特定事件发生时被调用，通常用于异步编程或事件驱动编程中，比如网络请求完成后的回调函数、定时器触发后的回调函数等。</li>
</ul>
<ol>
<li>实现方式：</li>
</ol>
<ul>
<li>钩子技术通常是通过操作系统提供的接口或库函数来实现的，可以在系统级别或应用程序级别进行钩子的安装和管理。</li>
<li>回调函数是一种编程模式，通过将函数指针或函数引用传递给其他函数，以便在特定事件发生时被调用。</li>
</ul>
<ol>
<li>应用场景：</li>
</ol>
<ul>
<li>钩子技术适用于需要拦截、监视和修改事件流的情况，比如实现键盘记录器、窗口管理工具等。</li>
<li>回调函数适用于需要异步处理或事件驱动的情况，比如处理异步任务完成后的结果、处理定时器事件等。</li>
</ul>
<p>综上所述，钩子技术和回调函数虽然都与事件响应相关，但它们的作用、实现方式和应用场景有着明显的区别。<strong>钩子技术更专注于事件的拦截和修改，而回调函数更专注于事件的响应和异步处理。</strong></p>
<p>从代码实现角度来看,Hook主要分成两种,Inline Hook 和 非 Inline Hook</p>
<p>Inline Hook指的是: </p>
<p><img src="https://s2.loli.net/2024/06/22/8isNvxnrQpDVHFE.png" alt="image-20240416213218744"></p>
<p>在call的调用的函数内里添加 jmp 想执行代码地址</p>
<p>非Inline Hook指的是:</p>
<p><img src="https://s2.loli.net/2024/06/22/KBonGr7HZgWVIC4.png" alt="image-20240416213515874"></p>
<p>事实上就是改变了Call操作的目标地址,实际上就是IAT Hook</p>
<h3 id="C-虚表的Hook"><a href="#C-虚表的Hook" class="headerlink" title="C++虚表的Hook"></a>C++虚表的Hook</h3><p>一个类的内存布局:</p>
<p><img src="https://s2.loli.net/2024/06/22/8aATK9XVMOtGpPn.png" alt="image-20240416214808838"></p>
<p>通过对象的地址来获得虚表的首地址,从而获得所有虚函数的地址</p>
<p>C++调用fish类的虚函数代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fish Myfish;</span><br><span class="line">Myfish.<span class="built_in">sleep</span>();</span><br></pre></td></tr></table></figure>

<p>汇编调用fish类的虚函数代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,ecx    //eca是MyFish对象的地址</span><br><span class="line">mov eax,[eax]  //获取MyFish对象的虚表地址</span><br><span class="line">call [eax+0x04]//调用sleep()函数</span><br></pre></td></tr></table></figure>

<h3 id="Detours-Hook"><a href="#Detours-Hook" class="headerlink" title="Detours Hook"></a>Detours Hook</h3><p>框架学习</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   	<span class="comment">//1.保存detour的事务</span></span><br><span class="line"><span class="built_in">DetourRestoreAfterWith</span>();</span><br><span class="line"><span class="comment">//2.开始处理detour的事务</span></span><br><span class="line"><span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line"><span class="comment">//3.更新线程信息-执行事务的线程</span></span><br><span class="line"><span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line"><span class="comment">//4.设置需要拦截的代理函数</span></span><br><span class="line"><span class="comment">//第一个参数二级函数指针-原函数地址</span></span><br><span class="line"><span class="comment">//第二个参数函数地址-代理函数的地址</span></span><br><span class="line"><span class="built_in">DetourAttach</span>((PVOID*)&amp;RealMessageBox, MyMessageBox);<span class="comment">//msg</span></span><br><span class="line"><span class="comment">//5.提交事务</span></span><br><span class="line"><span class="built_in">DetourTransactionCommit</span>();</span><br></pre></td></tr></table></figure>

<p>Hook MessageBox函数使得弹窗显示永远是 “你已经被Hook了！”</p>
<p>mfc程序</p>
<p>mfc.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;mfc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Myapp app;<span class="comment">//全局应用程序对象</span></span><br><span class="line"><span class="comment">//MyFrame* m_pMainwnd = new MyFrame;</span></span><br><span class="line"><span class="function">BOOL <span class="title">Myapp::InitInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyFrame* frame = <span class="keyword">new</span> MyFrame;</span><br><span class="line">	frame-&gt;<span class="built_in">ShowWindow</span>(SW_SHOWNORMAL);</span><br><span class="line">	frame-&gt;<span class="built_in">UpdateWindow</span>();</span><br><span class="line">	<span class="comment">//保存程序指针,否则窗口一闪而过,</span></span><br><span class="line">	m_pMainWnd = frame;<span class="comment">//m_pMainWnd线程类的一个成员</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BEGIN_MESSAGE_MAP</span>(MyFrame, CFrameWnd)</span><br><span class="line">	<span class="built_in">ON_WM_LBUTTONDOWN</span>()</span><br><span class="line"><span class="built_in">END_MESSAGE_MAP</span>()</span><br><span class="line"></span><br><span class="line">MyFrame::<span class="built_in">MyFrame</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">Create</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;Crackk&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">MyFrame::OnLButtonDown</span><span class="params">(UINT, CPoint point)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//获取Dll1.dll文件路径</span></span><br><span class="line">    WCHAR WorkPath[MAX_PATH];                        <span class="comment">//用于存放获取路径的信息    </span></span><br><span class="line">	<span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, WorkPath, MAX_PATH);</span><br><span class="line">	CString DllPath = WorkPath;</span><br><span class="line">	<span class="type">int</span> pos = DllPath.<span class="built_in">ReverseFind</span>(<span class="string">&#x27;\\&#x27;</span>);               </span><br><span class="line">	DllPath = DllPath.<span class="built_in">Left</span>(pos + <span class="number">1</span>);</span><br><span class="line">	DllPath += _T(<span class="string">&quot;Dll1.dll&quot;</span>);</span><br><span class="line">    <span class="comment">//一般情况利用辅助程序实现dll注入,这里为了便捷直接loadlibrary</span></span><br><span class="line">	HMODULE hmodule = <span class="built_in">LoadLibrary</span>(DllPath);</span><br><span class="line">	<span class="keyword">if</span> (hmodule == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, (LPCTSTR)<span class="string">&quot;加载dll失败&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, (LPCTSTR)<span class="string">&quot;弹窗&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>dll程序</p>
<p>solve.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;solve.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpReserved</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Start_Hook</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Exit_Hook</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Dll1main.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;solve.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="built_in">int</span>(WINAPI* RealMessageBox)(HWND, LPCTSTR, LPCTSTR, UINT) = MessageBox;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">MyMessageBox</span><span class="params">(HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption, UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">RealMessageBox</span>(hWnd, <span class="string">L&quot;你已经被Hook了！&quot;</span>, <span class="string">L&quot;Hooked&quot;</span>, uType);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Start_Hook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="built_in">DetourRestoreAfterWith</span>();</span><br><span class="line">		<span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">		<span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">		<span class="built_in">DetourAttach</span>((PVOID*)&amp;RealMessageBox, MyMessageBox);<span class="comment">//msg</span></span><br><span class="line">		<span class="built_in">DetourTransactionCommit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Exit_Hook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//1.开始处理detour的事务</span></span><br><span class="line">	<span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">	<span class="comment">//2.更新线程信息-执行事务的线程</span></span><br><span class="line">	<span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">	<span class="comment">//3.撤销hook </span></span><br><span class="line">	<span class="comment">//第一个参数二级函数指针-原函数地址</span></span><br><span class="line">	<span class="comment">//第二个参数函数地址-代理函数的地址</span></span><br><span class="line">	<span class="built_in">DetourDetach</span>((PVOID*)&amp;RealMessageBox, MyMessageBox);</span><br><span class="line">	<span class="comment">//4.提交事务</span></span><br><span class="line">	<span class="built_in">DetourTransactionCommit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/22/VWTSJEYMnOjZIr4.png" alt="image-20240416230935344"></p>
<h3 id="Windows的S-E-H"><a href="#Windows的S-E-H" class="headerlink" title="Windows的S.E.H"></a>Windows的S.E.H</h3><p>S.E.H全称是Struct Exception Handler即结构化异常处理机制</p>
<p>S.E.H是操作系统提供给线程来感知和处理异常的一种回调机制,S.E.H在线程栈上以<strong>单链表</strong>的形式存在</p>
<p><img src="https://s2.loli.net/2024/06/22/HUTfFSkE8Pwtm9R.png" alt="image-20240418155025834"></p>
<p>在win32中由于FS寄存器总是指向当前的TIB(线程信息块),因此在FS:[0]处能找到最近的一个EXCEPTION_REGISTERATION结构</p>
<p>当我们通过try&#x2F;catch或__try&#x2F;except等操作来注册S.E.H的时候,FS:[0]会指向新的S.E.H,且新的S.E.H的Prev字段会指向之前FS:[0]指向的S.E.H,整个操作类似于单链表的表头插入操作</p>
<h3 id="Windows的V-E-H"><a href="#Windows的V-E-H" class="headerlink" title="Windows的V.E.H"></a>Windows的V.E.H</h3><p>S.E.H是基于线程的异常处理,V.E.H是基于进程的异常处理</p>
<p>V.E.H处理异常的优先级低于调试器,高于S.E.H,即KiUserExceptionDispatcher()函数首先检查进程是否处于被调试状态,然后检查V.E.H链表,最后才是检查S.E.H链表</p>
<p>Windows提供了注册V.E.H的回调函数的API</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PVOID AddVectoredExceptionHandler<span class="comment">//注册回调函数</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG FirstHandler,<span class="comment">//如果大于0则从头部插入,否则从尾部插入</span></span><br><span class="line">	PVECTORED_EXCEPTION_HANDLE VectoredHandler<span class="comment">//异常处理函数地址</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以通过该函数进行虚假注册,通过函数返回值后去链表的头指针或者尾指针,从而遍历整个V.E.H链表</p>
<h3 id="硬件断点"><a href="#硬件断点" class="headerlink" title="硬件断点"></a>硬件断点</h3><h4 id="调试器寄存器"><a href="#调试器寄存器" class="headerlink" title="调试器寄存器"></a>调试器寄存器</h4><p>IA-32处理器定义了8个调试寄存器,DR0-DR7其中<strong>DR0-DR3用来指定断点的内存地址或IO地址</strong>;DR4和DR5是保留的,DR6的作用是当调试事件发生时向调试器报告事件的详细信息,以供调试器啊判断发生的是何种事件;DR7用来进一步定义中断条件</p>
<h4 id="硬件断点的优势"><a href="#硬件断点的优势" class="headerlink" title="硬件断点的优势"></a>硬件断点的优势</h4><p>硬件断点HOOK是结合DR0-DR3调试寄存器和Windows S.E.H 或V.E.H机制所引入的一种HOOK机制.如果HOOK采用的方式是修改代码,那么很容易被检测到,然而硬件断点HOOK并不涉及修改代码,所以他的优点主要体现在隐蔽性上</p>
<h4 id="线程上下文环境以及Windows下线程与CPU之间的关系"><a href="#线程上下文环境以及Windows下线程与CPU之间的关系" class="headerlink" title="线程上下文环境以及Windows下线程与CPU之间的关系"></a>线程上下文环境以及Windows下线程与CPU之间的关系</h4><p>线程执行环境CONTEXT的结构体:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struct_CONTEXT</span><br><span class="line">&#123;</span><br><span class="line">	DwORD  contextFlags;</span><br><span class="line">	DWORD	Dr0;</span><br><span class="line">    DWORD	Dr1;</span><br><span class="line">    DWORD	Dr2;</span><br><span class="line">    DWORD	Dr3;</span><br><span class="line">    DWORD	Dr6;</span><br><span class="line">    DWORD	Dr7;</span><br><span class="line">	FLOATING_SAVE_AREA FloatSave;</span><br><span class="line">	DWORD	segGs;</span><br><span class="line">	DWORD	segFs;</span><br><span class="line">	DWORD	segEs;</span><br><span class="line">	DWORD	SegDs;</span><br><span class="line">	DWORD	Edi;</span><br><span class="line">	DWORD	Esi;</span><br><span class="line">	DWORD	Ebx;</span><br><span class="line">	DWORD	Edx;</span><br><span class="line">	DWORD	Ecx;</span><br><span class="line">	DWORD	Eax;</span><br><span class="line">	DWORD	Ebp;</span><br><span class="line">	DWORD	Eip;</span><br><span class="line">	DWORD	segCs;</span><br><span class="line">	DWORD	EFlags;</span><br><span class="line">	DWORD	Esp;</span><br><span class="line">	DWORD	segSs;</span><br><span class="line">&#125; CONTEXT;</span><br></pre></td></tr></table></figure>

<p>Windows是基于线程调用的多任务抢占式操作系统,如果CPU目前运行的线程1,这时优先级更高的线程2将抢占执行,那么操作系统会把线程1的执行环境取出放到线程1的CONTEXT结构中,接着把线程2的CONTEXT信息放入CPU中,继续运行线程2</p>
<h3 id="S-E-H-Hook"><a href="#S-E-H-Hook" class="headerlink" title="S.E.H Hook"></a>S.E.H Hook</h3><p>未成功代码,显示有没经处理的异常</p>
<p>应该是MyExceptionFilter函数没起作用</p>
<p>dll中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SEHHook.h&quot;</span></span></span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,</span></span><br><span class="line"><span class="params">                       DWORD  ul_reason_for_call,</span></span><br><span class="line"><span class="params">                       LPVOID lpReserved</span></span><br><span class="line"><span class="params">                     )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        SetHardBreakPoint();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        SetHardBreakPoint();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SEH.cpp </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span>  <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SEHHook.h&quot;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;climits&gt;</span></span></span><br><span class="line">DWORD HookAddr = (DWORD)GetProcAddress(GetModuleHandleA(<span class="string">&quot;USER32.dll&quot;</span>),<span class="string">&quot;MessageBoxW&quot;</span>);</span><br><span class="line"></span><br><span class="line">LONG WINAPI <span class="title function_">MyExceptionFilter</span><span class="params">(PEXCEPTION_POINTERS ExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress == (LPVOID)HookAddr)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="comment">//获取当前线程上下文</span></span><br><span class="line">		PCONTEXT pcontext = ExceptionInfo-&gt;ContextRecord;</span><br><span class="line">		MessageBoxW(<span class="literal">NULL</span>,TEXT(<span class="string">&quot;你被hook了诶&quot;</span>), TEXT(<span class="string">&quot;gogogo&quot;</span>),<span class="number">0</span>);</span><br><span class="line">		pcontext-&gt;Eip += <span class="number">5</span>;</span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SetHardBreakPoint</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//遍历线程 通过openthread获取到线程环境后设置硬件断点</span></span><br><span class="line">	HANDLE hTool32 = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (hTool32 != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		THREADENTRY32 threadEntry32;<span class="comment">//线程环境结构体</span></span><br><span class="line">		threadEntry32.dwSize = <span class="keyword">sizeof</span>(THREADENTRY32);</span><br><span class="line">		HANDLE hMainThread = <span class="literal">NULL</span>;</span><br><span class="line">		FILETIME exit_time, kernel_time, user_time;</span><br><span class="line">		FILETIME creation_time;</span><br><span class="line">		FILETIME prev_creation_time;</span><br><span class="line">		prev_creation_time.dwLowDateTime = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">		prev_creation_time.dwHighDateTime = INT_MAX;</span><br><span class="line">		DWORD dwThreadEntryOffset = FIELD_OFFSET(THREADENTRY32, th32OwnerProcessID) + <span class="keyword">sizeof</span>(threadEntry32.th32OwnerProcessID);</span><br><span class="line">		<span class="keyword">if</span> (Thread32First(hTool32, &amp;threadEntry32))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (threadEntry32.dwSize &gt;= dwThreadEntryOffset &amp;&amp;threadEntry32.th32OwnerProcessID == GetCurrentProcessId())</span><br><span class="line">				&#123;</span><br><span class="line">					HANDLE hHookThread = OpenThread(THREAD_ALL_ACCESS, <span class="literal">false</span>, threadEntry32.th32ThreadID);</span><br><span class="line">					GetThreadTimes(hHookThread, &amp;creation_time, &amp;exit_time, &amp;kernel_time, &amp;user_time);</span><br><span class="line">					<span class="keyword">if</span> (CompareFileTime(&amp;creation_time, &amp;prev_creation_time) == <span class="number">-1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">memcpy</span>(&amp;prev_creation_time, &amp;creation_time, <span class="keyword">sizeof</span>(FILETIME));</span><br><span class="line">						<span class="keyword">if</span> (hMainThread != <span class="literal">NULL</span>)</span><br><span class="line">							CloseHandle(hMainThread);</span><br><span class="line">						hMainThread = hHookThread;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						CloseHandle(hHookThread);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				threadEntry32.dwSize = <span class="keyword">sizeof</span>(THREADENTRY32);</span><br><span class="line">			&#125; <span class="keyword">while</span> (Thread32Next(hTool32,&amp;threadEntry32));</span><br><span class="line">			SetUnhandledExceptionFilter(MyExceptionFilter);</span><br><span class="line">			CONTEXT thread_context = &#123; CONTEXT_DEBUG_REGISTERS &#125;;</span><br><span class="line">			thread_context.Dr0 = (DWORD)HookAddr;</span><br><span class="line">			thread_context.Dr7 = <span class="number">0x1</span>;<span class="comment">//设置断点类型(访问断点)</span></span><br><span class="line">			SetThreadContext(hMainThread, &amp;thread_context);</span><br><span class="line">			CloseHandle(hMainThread);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hTool32);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="V-E-H-Hook"><a href="#V-E-H-Hook" class="headerlink" title="V.E.H Hook"></a>V.E.H Hook</h3><p>试验成功</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dllmain.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;VEHHook.h&quot;</span></span></span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,</span></span><br><span class="line"><span class="params">                       DWORD  ul_reason_for_call,</span></span><br><span class="line"><span class="params">                       LPVOID lpReserved</span></span><br><span class="line"><span class="params">                     )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        AddVectoredExceptionHandler(<span class="number">1</span>, (PVECTORED_EXCEPTION_HANDLER)MyExceptionFilter);</span><br><span class="line">        SetHardBreakPoint();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        SetHardBreakPoint();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//VEHHOOK.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span>  <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;VEHHook.h&quot;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;climits&gt;</span></span></span><br><span class="line">DWORD HookAddr = (DWORD)GetProcAddress(GetModuleHandleA(<span class="string">&quot;USER32.dll&quot;</span>),<span class="string">&quot;MessageBoxW&quot;</span>);</span><br><span class="line"></span><br><span class="line">LONG WINAPI <span class="title function_">MyExceptionFilter</span><span class="params">(PEXCEPTION_POINTERS ExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress == (LPVOID)HookAddr)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="comment">//获取当前线程上下文</span></span><br><span class="line">		PCONTEXT pcontext = ExceptionInfo-&gt;ContextRecord;</span><br><span class="line">		MessageBoxA(<span class="literal">NULL</span>,<span class="string">&quot;HOOK&quot;</span>, <span class="string">&quot;HOOK&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//需要加一段调整eip的代码使得跳出死循环</span></span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">SetHardBreakPoint</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//遍历线程 通过openthread获取到线程环境后设置硬件断点</span></span><br><span class="line">	HANDLE hTool32 = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (hTool32 != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		THREADENTRY32 threadEntry32;<span class="comment">//线程环境结构体</span></span><br><span class="line">		threadEntry32.dwSize = <span class="keyword">sizeof</span>(THREADENTRY32);</span><br><span class="line">		HANDLE hMainThread = <span class="literal">NULL</span>;</span><br><span class="line">		FILETIME exit_time, kernel_time, user_time;</span><br><span class="line">		FILETIME creation_time;</span><br><span class="line">		FILETIME prev_creation_time;</span><br><span class="line">		prev_creation_time.dwLowDateTime = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">		prev_creation_time.dwHighDateTime = INT_MAX;</span><br><span class="line">		DWORD dwThreadEntryOffset = FIELD_OFFSET(THREADENTRY32, th32OwnerProcessID) + <span class="keyword">sizeof</span>(threadEntry32.th32OwnerProcessID);</span><br><span class="line">		<span class="keyword">if</span> (Thread32First(hTool32, &amp;threadEntry32))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (threadEntry32.dwSize &gt;= dwThreadEntryOffset &amp;&amp;threadEntry32.th32OwnerProcessID == GetCurrentProcessId())</span><br><span class="line">				&#123;</span><br><span class="line">					HANDLE hHookThread = OpenThread(THREAD_ALL_ACCESS, <span class="literal">false</span>, threadEntry32.th32ThreadID);</span><br><span class="line">					GetThreadTimes(hHookThread, &amp;creation_time, &amp;exit_time, &amp;kernel_time, &amp;user_time);</span><br><span class="line">					<span class="keyword">if</span> (CompareFileTime(&amp;creation_time, &amp;prev_creation_time) == <span class="number">-1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">memcpy</span>(&amp;prev_creation_time, &amp;creation_time, <span class="keyword">sizeof</span>(FILETIME));</span><br><span class="line">						<span class="keyword">if</span> (hMainThread != <span class="literal">NULL</span>)</span><br><span class="line">							CloseHandle(hMainThread);</span><br><span class="line">						hMainThread = hHookThread;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						CloseHandle(hHookThread);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				threadEntry32.dwSize = <span class="keyword">sizeof</span>(THREADENTRY32);</span><br><span class="line">			&#125; <span class="keyword">while</span> (Thread32Next(hTool32,&amp;threadEntry32));</span><br><span class="line">			CONTEXT thread_context = &#123; CONTEXT_DEBUG_REGISTERS &#125;;</span><br><span class="line">			thread_context.Dr0 = (DWORD)HookAddr;</span><br><span class="line">			thread_context.Dr7 = <span class="number">0x1</span>;<span class="comment">//设置断点类型(访问断点)</span></span><br><span class="line">			SetThreadContext(hMainThread, &amp;thread_context);</span><br><span class="line">			CloseHandle(hMainThread);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hTool32);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/06/22/z1xhTRjQWKd3IDk.png" alt="image-20240509220917719"></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E9%80%86%E5%90%91/">逆向</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/05/10/c++/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">c++笔记</span></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="Kvancy"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Kvancy</p><p class="is-size-6 is-block">CTFer / Reverser</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国 / 江西</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">5</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Kvancy" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/Kvancy"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#BFS脚本："><span class="level-left"><span class="level-item">1</span><span class="level-item">BFS脚本：</span></span></a></li><li><a class="level is-mobile" href="#Frida环境搭建与测试："><span class="level-left"><span class="level-item">2</span><span class="level-item">Frida环境搭建与测试：</span></span></a></li><li><a class="level is-mobile" href="#RC4解密脚本："><span class="level-left"><span class="level-item">3</span><span class="level-item">RC4解密脚本：</span></span></a></li><li><a class="level is-mobile" href="#RC4的c语言加密脚本："><span class="level-left"><span class="level-item">4</span><span class="level-item">RC4的c语言加密脚本：</span></span></a></li><li><a class="level is-mobile" href="#AES加解密C脚本"><span class="level-left"><span class="level-item">5</span><span class="level-item">AES加解密C脚本</span></span></a></li><li><a class="level is-mobile" href="#Ida-Python脚本"><span class="level-left"><span class="level-item">6</span><span class="level-item">Ida Python脚本:</span></span></a></li><li><a class="level is-mobile" href="#attribute实现main函数之前执行相应函数："><span class="level-left"><span class="level-item">7</span><span class="level-item">attribute实现main函数之前执行相应函数：</span></span></a></li><li><a class="level is-mobile" href="#函数调用默认传参的几种方式"><span class="level-left"><span class="level-item">8</span><span class="level-item">函数调用默认传参的几种方式</span></span></a></li><li><a class="level is-mobile" href="#gbk解码转中文，先ida64-convert-to-string，再用b修饰，解码即可"><span class="level-left"><span class="level-item">9</span><span class="level-item">gbk解码转中文，先ida64 convert to string，再用b修饰，解码即可</span></span></a></li><li><a class="level is-mobile" href="#异常处理和反调试"><span class="level-left"><span class="level-item">10</span><span class="level-item">异常处理和反调试</span></span></a></li><li><a class="level is-mobile" href="#dll的编译和使用"><span class="level-left"><span class="level-item">11</span><span class="level-item">dll的编译和使用</span></span></a></li><li><a class="level is-mobile" href="#c语言RC4，base64加解密代码"><span class="level-left"><span class="level-item">12</span><span class="level-item">c语言RC4，base64加解密代码</span></span></a></li><li><a class="level is-mobile" href="#lea指令使用，防止遗忘"><span class="level-left"><span class="level-item">13</span><span class="level-item">lea指令使用，防止遗忘</span></span></a></li><li><a class="level is-mobile" href="#内联汇编实现部分常用函数功能练习"><span class="level-left"><span class="level-item">14</span><span class="level-item">内联汇编实现部分常用函数功能练习</span></span></a></li><li><a class="level is-mobile" href="#重温栈结构"><span class="level-left"><span class="level-item">15</span><span class="level-item">重温栈结构</span></span></a></li><li><a class="level is-mobile" href="#ret-和-retn的区别"><span class="level-left"><span class="level-item">16</span><span class="level-item">ret 和 retn的区别</span></span></a></li><li><a class="level is-mobile" href="#repe-cmpsb字符串比较汇编指令"><span class="level-left"><span class="level-item">17</span><span class="level-item">repe cmpsb字符串比较汇编指令</span></span></a></li><li><a class="level is-mobile" href="#jmp指令偏移地址计算"><span class="level-left"><span class="level-item">18</span><span class="level-item">jmp指令偏移地址计算</span></span></a></li><li><a class="level is-mobile" href="#IDAPatch保存后动调"><span class="level-left"><span class="level-item">19</span><span class="level-item">IDAPatch保存后动调</span></span></a></li><li><a class="level is-mobile" href="#Ollvm控制流平坦化技术"><span class="level-left"><span class="level-item">20</span><span class="level-item">Ollvm控制流平坦化技术</span></span></a></li><li><a class="level is-mobile" href="#Hook"><span class="level-left"><span class="level-item">21</span><span class="level-item">Hook</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Hook的多种方式"><span class="level-left"><span class="level-item">21.1</span><span class="level-item">Hook的多种方式</span></span></a></li><li><a class="level is-mobile" href="#HOOK和Callback的区别"><span class="level-left"><span class="level-item">21.2</span><span class="level-item">HOOK和Callback的区别</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#相同点"><span class="level-left"><span class="level-item">21.2.1</span><span class="level-item">相同点</span></span></a></li><li><a class="level is-mobile" href="#差异性"><span class="level-left"><span class="level-item">21.2.2</span><span class="level-item">差异性</span></span></a></li></ul></li><li><a class="level is-mobile" href="#C-虚表的Hook"><span class="level-left"><span class="level-item">21.3</span><span class="level-item">C++虚表的Hook</span></span></a></li><li><a class="level is-mobile" href="#Detours-Hook"><span class="level-left"><span class="level-item">21.4</span><span class="level-item">Detours Hook</span></span></a></li><li><a class="level is-mobile" href="#Windows的S-E-H"><span class="level-left"><span class="level-item">21.5</span><span class="level-item">Windows的S.E.H</span></span></a></li><li><a class="level is-mobile" href="#Windows的V-E-H"><span class="level-left"><span class="level-item">21.6</span><span class="level-item">Windows的V.E.H</span></span></a></li><li><a class="level is-mobile" href="#硬件断点"><span class="level-left"><span class="level-item">21.7</span><span class="level-item">硬件断点</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#调试器寄存器"><span class="level-left"><span class="level-item">21.7.1</span><span class="level-item">调试器寄存器</span></span></a></li><li><a class="level is-mobile" href="#硬件断点的优势"><span class="level-left"><span class="level-item">21.7.2</span><span class="level-item">硬件断点的优势</span></span></a></li><li><a class="level is-mobile" href="#线程上下文环境以及Windows下线程与CPU之间的关系"><span class="level-left"><span class="level-item">21.7.3</span><span class="level-item">线程上下文环境以及Windows下线程与CPU之间的关系</span></span></a></li></ul></li><li><a class="level is-mobile" href="#S-E-H-Hook"><span class="level-left"><span class="level-item">21.8</span><span class="level-item">S.E.H Hook</span></span></a></li><li><a class="level is-mobile" href="#V-E-H-Hook"><span class="level-left"><span class="level-item">21.9</span><span class="level-item">V.E.H Hook</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.52pojie.cn/thread-1954225-1-1.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">2023腾讯游戏安全PC决赛复现</span></span><span class="level-right"><span class="level-item tag">www.52pojie.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.52pojie.cn/thread-1952072-1-1.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">2022腾讯游戏安全PC端初赛复现</span></span><span class="level-right"><span class="level-item tag">www.52pojie.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.52pojie.cn/thread-1948904-1-1.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">2023年腾讯游戏安全竞赛PC端初赛复现</span></span><span class="level-right"><span class="level-item tag">www.52pojie.cn</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E5%AE%9E%E8%B7%B5/"><span class="level-start"><span class="level-item">实践</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">笔记</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-09-22T16:00:00.000Z">2024-09-23</time></p><p class="title"><a href="/2024/09/23/2024%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/">2024腾讯游戏安全PC初赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-12T16:00:00.000Z">2024-08-13</time></p><p class="title"><a href="/2024/08/13/2023%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%86%B3%E8%B5%9B/">2023腾讯游戏安全PC决赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-05T16:00:00.000Z">2024-08-06</time></p><p class="title"><a href="/2024/08/06/2022%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/">2022腾讯游戏安全PC初赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-27T16:00:00.000Z">2024-07-28</time></p><p class="title"><a href="/2024/07/28/2023%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8PC%E5%88%9D%E8%B5%9B/">2023腾讯游戏安全PC初赛</a></p><p class="categories"><a href="/categories/%E5%AE%9E%E8%B7%B5/">实践</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-04-30T16:00:00.000Z">2024-05-01</time></p><p class="title"><a href="/2024/05/01/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">Windows内核逆向学习记录</a></p><p class="categories"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/09/"><span class="level-start"><span class="level-item">September 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/08/"><span class="level-start"><span class="level-item">August 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">July 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">May 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/04/"><span class="level-start"><span class="level-item">April 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">January 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">September 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/07/"><span class="level-start"><span class="level-item">July 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">May 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">April 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%AE%B0/"><span class="tag">杂记</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A0%B4%E8%A7%A3/"><span class="tag">破解</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%86%E5%90%91/"><span class="tag">逆向</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A9%B1%E5%8A%A8/"><span class="tag">驱动</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/Kvancy.svg" alt="Kvancy" height="28"></a><p class="is-size-7"><span>&copy; 2024 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>